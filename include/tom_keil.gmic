#@gmic

#@gimp _<b>Testing</b>
#@gimp Tom Keil

#**************************************
#ABOUT
#**************************************

#@gimp About : _none_, gimp_tk_about
#@gimp : note = note{"
#@gimp : <span foreground="purple">( <b>T</b>om Keil´s <b>F</b>ilter <b>S</b>et for <b>G'MIC</b>)</span>\n\nis proposed to you by"}
#@gimp : note = note("Tom Keil")
#@gimp : note = note{"\n"}
#@gimp : sep = separator()
#@gimp : note = note{"
#@gimp : The source code of this set of filters and additional informations and tutorials are available at :"}
##@gimp : note = link("http://www.tkfilter.bplaced.net")
#@gimp : sep = separator()
#@gimp : note = note{"\nThe filters in this folder are still under development and may be subject to changes. Some filters appearing here are also part of the main filter tree of G´MIC. If they appear here too it means there are changes and updates not yet implemented in the main filter tree."}
gimp_tk_about :
  -gimp_logo "Tom Keil´s Filters"

# Quick fix to correct TK filters using old '-gimp_channel_processing'.
tk_gimp_channel_processing :
  -gimp_channel_processing {$3*100/255},{$2<1?-min(1,$2-1)*100:min(1,0.25*($2-1))*100},{log($1)},${4--1}

# Quick fix to correct TK filters using old '-gimp_select_color'.
tk_gimp_select_color :
  ($4^$5^$6^$7) -_gimp_select_color[-1] $1 color={^} -rm[-1]
  -repeat $!
    -if {$8==0}                                  # Output selected colors.
      --_gimp_select_color[-1] $1
      -select_color[-1] $2%,$color
      -b[-1] $3%
      -if $9 -*[-1] -1 -+[-1] 1 -endif
      -to_rgba[-2] -s[-2] c -*[-2,-1] -a[-4--1] c
    -else
      -_gimp_select_color[-1] $1
      -select_color[-1] $2%,$color
      -b[-1] $3
      -if $9 -*[-1] -1 -+[-1] 1 -endif
      -*[-1] 255 -r[-1] 100%,100%,1,4
    -endif
  -mv[-1] 0 -done

# Quick fix to correct TK filters using old '-gimp_replace_color'.
tk_gimp_replace_color :
  -to_rgba -replace_color $1,$2%,${3--1} -c 0,255

#****************************************
# infrared simulation
#****************************************

#@gimp Infrared simulation : gimp_tk_infrared, gimp_tk_infrared_preview(1)
#@gimp : Filter density = float(0.75,0.01,0.99)
#@gimp : Wood effect saturation = float(0.5,0,1)
#@gimp : Wood effect color = int(-100,-180,180)
#@gimp : Wood effect falloff = float(0.75,0,1)
#@gimp : Sky color = int(0,-180,180)
#@gimp : Sky falloff = float(1,0,1)
#@gimp : Infrared defocus = float(0,0,3)
#@gimp : Exposure = int(0,-255,255)
#@gimp : Contrast = float(1,0,4)
#@gimp : Saturation = float(1,0,2)
#@gimp : Color / B&amp;W = bool(0)
#@gimp : Add grain = float(50,0,200)
#@gimp : sep = separator(), Preview type = choice("Full","Forward horizontal","Forward vertical","Backward horizontal","Backward vertical","Duplicate top","Duplicate left","Duplicate bottom","Duplicate right")
#@gimp : sep = separator(), note = note("<small>Author: <i>Tom Keil</i>      Latest update: <i>07/17/2012</i>.</small>")

gimp_tk_infrared :

 -repeat $! -l[$>]
 --gimp_hsv_equalizer 0,120,{240*$4},{if({$2==0},0,$3)},{if({$2==0},-$1,{-1+$2})},$1,240,{120*$6},$5,0,-$1,0,0,0,0,0
 -blur[-1] $7 -gimp_compose_alpha $1,0
 -tk_gimp_channel_processing 1,$9,$8,0,0,0,100,256,0,0,0,2,0,0
 -gimp_mix_lab 1,0,0,$10,0,0,$10,0,0,0,2,0
 -if {$11==1} -gimp_blackandwhite 0.299,0,0.587,0,0.114,0,1,1,0,0,0,$12,$12,$12,2,{{w+h}/60000},0,0,16,4,0,0,0 -endif
 -endl -done

gimp_tk_infrared_preview :

 -gimp_split_preview "-gimp_tk_infrared ${1--2}",$-1

#*****END OF FILTER**********************

#****************************************
#DOF Manipulation
#****************************************

#@gimp DOF manipulation : gimp_tk_dof, gimp_tk_dof_preview(1)
#@gimp : sep = separator()
#@gimp : Focal point X = float (50,0,100)
#@gimp : Focal point Y = float (50,0,100)
#@gimp : DOF 1 = int (30,0,255)
#@gimp : DOF 2  = int (60,0,255)
#@gimp : Transition = float(5,0,25)
#@gimp : Defocus strength = float(15,0,200)
#@gimp : Defocus style = choice(2,"median","gaussian","mixed")
#@gimp : Depth estimation model = choice("automatic depth estimation","daylight scene","individual focus field mask","individual depth map")
#@gimp : Bokeh strength = float(0,0,1)
#@gimp : Highlights threshold = float(200,0,255)
#@gimp : Bokeh size = float(40,2,200)
#@gimp : Bokeh blur = float(2,0,20)
#@gimp : Aperture type = choice("circular","octogonal")
#@gimp : Remove blurring artifacts = bool(0)
#@gimp : sep = separator()
#@gimp : Scheimpflug effect = choice("none","vertical blend","horizontal blend","vertical only","horizontal only")
#@gimp : Tilt plane 1 = float(0,0,100)
#@gimp : Tilt plane 2 = float(0.01,0,100)
#@gimp : sep = separator()
#@gimp : Output mode = choice("image","layers in focus/out of focus","focus field mask only","depth estimation only")
#@gimp : Computation mode = choice(1,"high quality","normal","high speed")
#@gimp : use treshold mask mode = bool(0)
#@gimp : sep = separator(), Preview type = choice("Full","Forward horizontal","Forward vertical","Backward horizontal","Backward vertical","Duplicate top","Duplicate left","Duplicate bottom","Duplicate right")
#@gimp : sep = separator(), note = note("<small>Author: <i>Tom Keil</i>      Latest update: <i>21/01/2012</i>.</small>")
##@gimp : note = link("Filter explained here",http://www.tkfilter.bplaced.net/TKFilter%20tutorials%20DOF%20manipulation.html)

gimp_tk_dof :

#check valid input

 -if {{$8==0}||{$8==1}} -if {{$!}!=1} -error[] "Select input mode ACTIVE. This option is available for single layer only."
 -endif -endif
 -if {{$8==2}||{$8==3}} -if {{$15==3}||{$15==4}||{$17==3}} -error[] "Option not available for individual mask" -endif -endif
 -if {{$8==2}||{$8==3}} -if {{$!}!=2} -error[] "For individual mask select input mode ACTIVE AND BELOW" -endif -endif


#create layers

 tr={$5} dfs={$6} bsi={$11} bsb={$12}
 -if {$19==1} scdo=50 scup=200 tr={$5/2} dfs={$6/2} bsi={$11/2} bsb={$12/2} -endif
 -if {$19==2} scdo=25 scup=400 tr={$5/4} dfs={$6/4} bsi={$11/4} bsb={$12/4} -endif

 -if {{$8==0}||{$8==1}} -if {$19!=0} --r[0] $scdo%,$scdo% -else [0] -endif
 -else -if {$19!=0} -r[-1] $scdo%,$scdo% -endif -endif
 -if {$19!=0} --r[0] $scdo%,$scdo% -else [0] -endif
 -if {{$8==2}||{$8==3}} -rv[-1,-2] -endif

#create focus mask

 -if {{$15==0}||{$15==1}||{$15==2}}

 -if {$8==0} -gimp_tk_autodepth[-1]
 -elif {$8==1} -gimp_tk_depthmap[-1] 1,20,0,0,0,0,0
 -elif {{$8==2}||{$8==3}} -endif

 -if {$18!=3} -if {$8!=2}
 -if {$20==1} -to_rgb[-1]
 --f[-1] if(i>={{255-$3}+{$4/2}},0,i)
 --f[-1] if(i<={{255-$3}-{$4/2}},0,i) -compose_darken[-1,-2]
 -n[-1] 0,255 -f[-1] if(i>=1,255,i) -rm[-2]
 -else
 -local_similarity_mask[-1] $1,$2,$3,$4,4,0
 -endif
 -blur_xy[-1] $tr
 -endif -endif

 -endif

#create Scheimpflug effect

 -if {{$15==1}||{$15==3}}
 --gimp_linear_gradient[-1] 0,0,0,255,255,255,255,255,1,180,100,$16
 --gimp_linear_gradient[-1] 0,0,0,255,255,255,255,255,0,180,0,$17
 -compose_darken[-1,-2]
 -endif

 -if {{$15==2}||{$15==4}}
 --gimp_linear_gradient[-1] 0,0,0,255,255,255,255,255,1,90,100,$16
 --gimp_linear_gradient[-1] 0,0,0,255,255,255,255,255,0,90,0,$17
 -compose_darken[-1,-2]
 -endif

#finalize mask

 -if {{$15==1}||{$15==2}} -rv[-1,-2] -compose_lighten[-1,-2] -endif
 -if {{$15==3}||{$15==4}} -rm[-2] -endif

#inpaint background

 -if {{$18==0}||{$18==1}}

 -if {$14==1} [-1,-2]

 -blur_xy[-1] {$tr/2}
 -ir[-1] 1,256 -n[-1] 0,255
 -tk_gimp_replace_color[-1] 1,0,0,0,0,255,0,0,0,0
 -inpaint[-2] [-1] -rm[-1,1] -rv[-1,-2]

 -endif

#blur defocused layer

 -if {$7==0} -median[-2] $dfs
 -elif {$7==1} -blur_xy[-2] $dfs
 -elif {$7==2} -median[-2] {$dfs/2} -blur_xy[-1] {$dfs/5}
 -endif

#create Bokeh

 -if {$9!=0} -if {$19==0}  [0] -else --r[0] $scdo%,$scdo% -endif
 -gimp_morpho[-1] 1,$bsi,0,{2-$13},0,1,0
 -tk_gimp_replace_color[-1] {$10*1.765},0,0,0,0,255,0,0,0,0
 -blur_xy[-1] $bsb

 -rv[-1,-3] -gimp_compose_lighten[-1,-3] $9
 -endif

#resize and recompose


 -if {$19!=0} -r[1,2] $scup%,$scup% -endif

 -to_rgba[0] -s[0] c -rv[3,5]
 -compose_multiply[3,5] -to_gray[3]
 -a[0,1,2,3] c
 -if {$18==0} -rv[0,1] -compose_rgba[0,1] -endif

 -endif

 -if {$18!=1} -k[-1] -endif
 -if {{$18==2}||{$18==3}} -if {$19!=0} -r[-1] $scup%,$scup% -endif -endif

gimp_tk_dof_preview :

 -to_rgba

 -if {{$8==0}||{$8==1}} -if {{$!}!=1} -error[] "Select input mode ACTIVE. This option is available for single layer only."
 -endif -endif

 -if {{$8!=2}&&{$8!=3}}
 -gimp_split_preview "-gimp_tk_dof ${1--2}",$-1
 -else -gimp_tk_dof ${1--1} -endif

 -to_rgba

 -if {$20==0}
 -line 100%,$2%,{$1+5}%,$2%,1,255,0,0
 -line 0%,$2%,{$1-5}%,$2%,1,255,0,0

 -line $1%,100%,$1%,{$2+5}%,1,255,0,0
 -line $1%,0%,$1%,{$2-5}%,1,255,0,0
 -endif

#*****END OF FILTER**********************

#****************************************
#beauty retouch
#****************************************

#@gimp Beauty Retouch : gimp_tk_retouch, gimp_tk_retouch_preview(0)
#@gimp : sep = separator()
#@gimp : Smoothness = float(30,0,100)
#@gimp : Details = float(3,0,10)
#@gimp : Smoothing Strength = float(1,0,5)
#@gimp : Edge Threshold = float(20,0,50)
#@gimp : Edge Smoothness = float(1.5,0,10)
#@gimp : Sharpening Radius = float(1,0,10)
#@gimp : Sharpening Strength = float(2.5,0,5)
#@gimp : View Edge Mask = bool(0)
#@gimp : Smoothen skin tones only = bool(0)
#@gimp : sep = separator(), Preview type = choice("Full","Forward horizontal","Forward vertical","Backward horizontal","Backward vertical","Duplicate top","Duplicate left","Duplicate bottom","Duplicate right")
#@gimp : sep = separator(), note = note("<small>Author: <i>Tom Keil</i>.      Latest update: <i>01/05/2011</i>.</small>")
#@gimp : note = link("Filter explained here","http://www.flickr.com/groups/gmic/discuss/72157625538669041/")
gimp_tk_retouch :
  -repeat $! -l[$>]
    -if {$8==1}
      --gimp_edges $5,$4,0,0 -gimp_gaussian_blur {$5*5},0,0,1,1,0,0
    -else
      --to_rgba[0]  --to_gray[0] -gimp_edges[2] $5,$4,0,0
      -gimp_gaussian_blur[2] {$5*5},0,0,1,1,0,0 -to_gray[2] --to_rgba[0] --negate[2]
      -gimp_highpass[1] {$1},2,1,1,0
      -gimp_gaussian_blur[1] $2,0,0,1,1,0,0
      -to_rgba[0]
      -if {$9==1}  --to_rgba[0] -channels[5] 0
      -tk_gimp_channel_processing[5] 1,1,4,0,0,0,100,256,0,0,0,2,7,0
      -gimp_gaussian_blur[5] {{w+h}/1000},0,0,1,0,0,0 -to_gray[5] -endif
      -split[1] c  -reverse[4,5] -compose_multiply[4,5]
      -if {$9==1} -reverse[4,-1] -compose_multiply[4,-1] -endif
      -append[-6,-5,-4,-3] c
      -reverse[0,1] -gimp_compose_softlight[0,1] {$3/5}
      -gimp_unsharp[-2] 0,$6,30,$7,0.00,1.00,0.5,1,0,7,0
      -split[-2] c  -reverse[-1,-2] -compose_multiply[-1,-2] -append[-4,-3,-2,-1] c
      -blend[0,1] alpha
    -endif
  -endl -done

gimp_tk_retouch_preview :
  -gimp_split_preview "-gimp_tk_retouch ${1--2}",$-1

#*************END OF FILTER***********

#*******END OF DIRECTORY**************
#@gimp _

#@gimp _<b>Stereoscopic 3D</b>

#****************************************
#3D Conversion
#****************************************

#@gimp 3D Conversion : gimp_tk_make3D, gimp_tk_make3D_preview(1)
#@gimp : sep = separator()
#@gimp : note = note("Stereoscopic settings:")
#@gimp : Scene selector = choice("automatic depth estimation","daylight scene","optimized lateral inhibition","light motive","dark motive","landscape","center foreground","center background","left foreground","left diagonal foreground","right foreground","right diagonal foreground","left and right foreground","left and right background","bottom and top foreground","bottom and left foreground","bottom and right foreground","central perspective outdoor","central perspective indoor","portrait","human 1","human 2","studio","underwater","flat")
#@gimp : Far point deviation = float(20,-100,100)
#@gimp : Stereoscopic window position = float(0,-100,100)
#@gimp : Depth field control = float(20,0,100)
#@gimp : Feature analyzer threshold = float(0,0,5)
#@gimp : Feature analyzer smoothness = float(0,0,5)
#@gimp : Local detail enhancer = float(0,0,5)
#@gimp : DOF analyzer = float(0,0,5)
#@gimp : Frequency analyzer = float(0,0,5)
#@gimp : Flip left / right = bool(0)
#@gimp : Use individual depth map = bool(0)
#@gimp : note = note("<small>To use this option your depth map must be placed below your image. Switch input layers to <i><b>Active and below</b></i>.</small>")
#@gimp : sep = separator()
#@gimp : note = note("Image settings:")
#@gimp : Black & White = bool (0)
#@gimp : Output format = choice("Anaglyph red/cyan","Anaglyph red/cyan optimized","Anaglyph blue/yellow","Anaglyph blue/yellow optimized","Anaglyph green/magenta","Anaglyph green/magenta optimized","Full side by side keep width","Full side by side keep uncompressed","Full bottom/top","Half side  by side","Half bottom/top","Interlace horizontal","Interlace vertical","Full HD frame packing","Unaligned images","Depth map only")
#@gimp : Gamma compensation = float(1.2,0,4)
#@gimp : Anti-ghosting = float(25,0,255)
#@gimp : Color boost = float(1,0,4)
#@gimp : Anaglyph glasses adjustment = float(0,-100,100)
#@gimp : Autocrop = bool (1)
#@gimp : Bidirectional rendering = bool (0)
#@gimp : sep = separator()
#@gimp : note = note("Frame settings:")
#@gimp : Render multiple frames = bool (0)
#@gimp : Render routine for wiggle animations = bool (0)
#@gimp : Frames = int(2,2,100)
#@gimp : Frame size = int(200,50,1920)
#@gimp : sep = separator(), note = note("<small>Author: <i>Tom Keil</i>.      Latest update: <i>09/20/2012</i>.</small>")
##@gimp : note = link("Filter explained here",http://www.tkfilter.bplaced.net/TKFilter%20tutorials%202Dto3D%203D-automatic%20stereoscopic%20conversion.html)

gimp_tk_make3D :

 # prepare image

 sh={-$2} sw={-$sh-$3} size1={w} size2={h} -to_rgb[0] -r[0] $size1,$size2 [0]

 # create depth map

 -if {$11==0}
 --gimp_tk_depthmap[-1] $1,$4,$5,$6,$7,$8,$9,0,0,0 -r[-1] $size1,$size2
 -gimp_gaussian_blur[-1] 0,{{w+h}/700},{{w+h}/350},1,0,0,0

 # individual depth map

 -else -if {{$!}!=3}
 -error[] "For individual depth map select input mode ACTIVE AND BELOW" -endif
 -rv[1,-1] -to_rgb[-1] -luminance[-1]

 # analyze image features to enrich individual maps

 -if {$11==1}
 -if {$9!=0}
 --fc[0] 128,128,128 --channels[0] 2 -negate[-1] -c[-1] 0,90
 -n[-1] 0,128 -rv[-1,-2] -compose_darken[-1,-2]
 --channels[0] 0 -negate[-1] -c[-1] 165,255 -n[-1] 128,255 -rv[-1,-2]
 -compose_hardlight[-1,-2] -rv[-1,-2]
 -if {$11==0} -if {$1!=20} -gimp_compose_average[-1,-2] {$9/5}
 -else -gimp_compose_value[-1,-2] {$9/5},0
 -tk_gimp_channel_processing[-1] 1,{$4/25},0,0,0,0,100,256,0,0,0,2,0,0
 -endif
 -else -gimp_compose_value[-1,-2] {$9/5},0 -endif -endif

 -if {$8!=0} --gimp_highpass[0] 2,2,0,0,0
 -tk_gimp_replace_color[-1] 5,0,128,128,128,255,0,0,0,255
 -gimp_morpho[-1] 3,70,0,0,0,1,0   -to_gray[-1] av={ia}
 -ir[-1] $av,255 -n[-1] 0,255 -blur_xy[-1] 25
 -rv[-1,-2] -gimp_compose_overlay[-1,-2] {$8/5} -endif

  -if {$5!=0} --gimp_isophotes[0] {{$5*3}+2},0,0,0
 -gimp_morpho[-1] 3,{5-{$5/2}},0,0,0,1,0
 -tk_gimp_channel_processing[-1] 1,1,255,0,0,0,100,256,0,0,0,2,0,0
 -rv[-1,-2] -gimp_compose_overlay[-1,-2] {$5/10}
 --gimp_gradient_norm[0] {$6*2},{1.5-{0.1+{$5/3.6}}},0,100,0,0
 -rv[-1,-2] -compose_lighten[-1,-2] -gimp_segment_watershed[-1] $5,$6,0,0
 -endif

 -if {$7!=0} --luminance[0] -gimp_map_tones[-1] 1,{0.25-{$7/20}},0,30,3,0
 -rv[-1,-2] -gimp_compose_overlay[-1,-2] {$7/10} -endif

 -n[-1] 0,255

 -endif -endif


 #frame size for multiple frames

 -if {$20==1} -r {w*{$23/max(w,h)}},{h*{$23/max(w,h)}},1,3,6 -c 0,255 -endif

 #create second view

 -if {$20==0}
 -if {$13!=15} -if {$19==0}
 -if {$sw<=0} -negate[-1] -endif


 -r[-1] $size1,$size2,1,2 -s[-1] c -f[-1] 0 -n[-2] 0,$sw -a[-1,-2] c


 -warp[-2] [-1],1 -shift[-2] $sh,0 -rm[-1]
 -else
 [-1] -r[-1,-2] 100%,100%,1,2
 -s[-1] c -f[-1] 0 -n[-2] 0,{abs($sw/2)} -a[-1,-2] c
 -negate[-2] -s[-2] c -f[-2] 0 -n[-3] 0,{-abs($sw/2)} -a[-2,-3] c
 -warp[-4] [-2],1 -warp[-3] [-1],1
 -shift[-3] $sh,0 -rm[-1,-2]
 -endif -endif
 -else

 #create multiple frames

 -if {$19==0}
 count={$22} dev=0 -repeat $count dev={$dev+{$sw/$22}}
 [0] -rv[-1,-2]
 -if {$sw<=0} -negate[-1] -endif
 -r[-1] 100%,100%,1,2 -s[-1] c -f[-1] 0
 -if {$21==0} -n[-2] 0,$dev -else -n[-2] {-$dev},$dev -endif
 -a[-1,-2] c -warp[-2] [-1],1 -to_gray[-1] -n[-1] 0,255
 -if {$sw<=0} -negate[-1] -endif
 -done -rm[-1,0] -rv
 -else
 count={abs($22/2)} dev=0
 -repeat $count dev={$dev+{$sw/$count}}
 [-2] -rv[-1,-2]
 [-2] -rv[-1,-2]
 [-1] -r[-1,-2] 100%,100%,1,2
 -s[-1] c -f[-1] 0
 -if {$21==0} -n[-2] 0,{abs($dev/2)}
 -else -n[-2] {-abs($dev/2)},{abs($dev/2)} -endif
 -a[-1,-2] c
 -negate[-2] -s[-2] c -f[-2] 0
 -if {$21==0} -n[-3] 0,{-abs($dev/2)}
 -else -n[-3] {-abs($dev/2)},{abs($dev/2)} -endif
 -a[-2,-3] c
 -warp[-4] [-2],1 -warp[-3] [-1],1 -rm[-2] -to_gray[-1] -n[-1] 0,255
 -mv[-4] -1 -done -rm[-1,-2] -mv[0--1:2] -1 -rv[0-50%] -mv[0] 50%
 -endif -endif

 #crop images

 -if {$20==0} -if {$18==1} -if {$13!=15}
 -if {$sh>=0} -crop[-1,-2] $sh,0,{w},{h} -else -crop[-1,-2] 0,0,{w+$sh},{h} -endif
 -if {$19==0}
 -if {$sw>=0} -crop[-1,-2] $sw,0,{w},{h} -else -crop[-1,-2] 0,0,{w+$sw},{h} -endif
 -else -crop[-1,-2] {abs($sw/2)},0,{w-abs($sw/2)},{h}
 -endif -endif -endif -endif

 #align stereoscopic image

 -if {$12==1} -gimp_blackandwhite 0.299,0,0.587,0,0.114,0,1,1,0,0,0,0,0,0,2,0,0,0,16,4,0,0,0 -endif
 -if {$20==0}
 -if {{$13!=14}&&{$13!=15}}
 -gimp_tk_stereoimage[0,1] $13,$10,$14,$15,$16,$17
 -elif {$13==14} -k[0,1]
 -elif {$13==15} -k[-1]
 -endif
 -endif

# adjust unaligned output images

 -if {$13==14} -apply_gamma $14 -tk_gimp_channel_processing 1,1,$15,0,0,0,100,256,0,0,1,10,7,0
 -gimp_mix_lab 1,0,0,$16,0,0,$16,0,0,0,2,0 -endif

# preview function

 gimp_tk_make3D_preview :

 -if {$20==0} shpre={$2/3} swpre={$3/3} -else shpre={$2*{400/$23}} swpre={$3*{400/$23}} -endif

 -if {{$11==1}&&{{$!}!=2}} -fc[0] 255,0,128,255 -k[0] -text "For individual depth map",10,80%,20,1,0,0,0,255
 -text "select input mode ACTIVE AND BELOW.",10,90%,20,1,0,0,0,255
 -else
 -gimp_tk_make3D $1,$shpre,$swpre,${4-12},{if({$20==1},14,$13)},${14-19},0,${21-23} -if {{$13==14}||{$20==1}} -k[1] -endif
 -endif

#************END OF FILTER***************

#****************************************
#3D Video Conversion
#****************************************

#@gimp 3D Video Conversion : gimp_tk_video3D, gimp_tk_video3D_preview(1)
#@gimp : sep = separator()
#@gimp : note = note("<b>Stereoscopic settings:</b>")
#@gimp : Scene selector = choice("automatic depth estimation","daylight scene","optimized lateral inhibition","light motive","dark  motive","landscape","center foreground","center background","left  foreground","left diagonal foreground","right foreground","right diagonal  foreground","left and right foreground","left and right background","bottom and top foreground","bottom and left foreground","bottom and right foreground","central  perspective outdoor","central perspective indoor","portrait","human 1","human  2","studio","underwater","flat")
#@gimp : Far point deviation = float(10,-100,100)
#@gimp : Stereo window position = float(-10,-100,100)
#@gimp : Depth field control = float(20,0,100)
#@gimp : Feature analyzer threshold = float(0,0,5)
#@gimp : Feature analyzer smoothness = float(0,0,5)
#@gimp : Local detail enhancer = float(0,0,5)
#@gimp : DOF analyzer = float(0,0,5)
#@gimp : Frequency analyzer = float(0,0,5)
#@gimp : Motion analyzer = float(0,-5,5)
#@gimp : Flip left / right = bool(0)
#@gimp : sep = separator()
#@gimp : note = note("<b>Frames settings:</b>")
#@gimp : Black & White = bool (0)
#@gimp : Output format = choice("Anaglyph red/cyan","Anaglyph red/cyan optimized","Anaglyph blue/yellow","Anaglyph blue/yellow optimized","Anaglyph green/magenta","Anaglyph green/magenta optimized","Full side by side keep width","Full side by uncompressed","Full bottom/top","Half side  by side","Half bottom/top","Interlace horizontal","Interlace vertical","Full HD frame packing","Left and right image streams","Depth maps only")
#@gimp : Output to folder = bool(0)
#@gimp : Folder name = folder()
#@gimp : Gamma compensation = float(1.2,0,4)
#@gimp : Anti-ghosting = float(25,0,255)
#@gimp : Color boost = float(1,0,4)
#@gimp : Anaglyph glasses adjustment = float(0,-100,100)
#@gimp : Autocrop = bool (1)
#@gimp : Set frame format = bool (1)
#@gimp : Frame width = int(1280,128,4096)
#@gimp : Frame format = choice(1,"4:3","16:9","3:2","2:1","21:9","Keep aspect ratio")
#@gimp : Frames offset = int(0,-5,5)
#@gimp : Reverse frame stack = bool(0)
#@gimp : sep = separator()
#@gimp : note = note("<b>Input settings:</b>")
#@gimp : Processing mode = choice("Layer processing","Batch processing")
#@gimp : Input folder = folder()
#@gimp : Input frame files name = text("frame_")
#@gimp : Start frame number = int(0,0,99998)
#@gimp : End frame number = int(1,1,99999)
#@gimp : Frame files format = choice(".png",".bmp")
#@gimp : sep = separator()
#@gimp : note = note("<b>Advanced editing:</b>")
#@gimp : Activate custom filter = choice("off","on","left stream only", "right stream only")
#@gimp : Custom filter code = text(1,"# old movie #\n#-luminance -gimp_stripes_y 10,3,0 -sepia \n\n#simple vintage#\n#--fc 0,15,125 -rv -gimp_compose_exclusion 0.3 \n\n# HDR popout #\n#-gimp_map_tones_fast 2,0.3,3,2 -gimp_unsharp_octave 4,5,3,0,0,0\n\n")
#@gimp : Depth fade in frames  = int(0,0,120)
#@gimp : Depth fade out frames  = int(0,0,120)
#@gimp : sep = separator()
#@gimp : note = note("<b>Advanced quality control:</b>")
#@gimp : Key frame rate = int(1,1,100)
#@gimp : Stabilizer = float(5,0,100)
#@gimp : Preprocessor radius = float(0,0,5)
#@gimp : Preprocessor power = float(0,0,5)
#@gimp : Custom depth correction = choice("None","Custom correction map","Single custom depth map","Custom depth maps stream")
#@gimp : Rendering mode = choice(1,"Right eye view","Bidirectional rendering","Align image streams","Anaglyph reconstruction")
#@gimp : sep = separator()
#@gimp : note = note("<b>Preview:</b>")
#@gimp : Preview type = Choice("first frame","last frame","selected frame","full layer stack -slow!-")
#@gimp : Preview frame selection  = int(0,0,99999)
#@gimp : sep = separator(), note = note("<small><b>Switch input layers to All.</b></small>")
#@gimp : sep = separator(), note = note("<small>Author: <i>Tom Keil</i>.       Latest update: <i>10/07/2012</i>.</small>")
##@gimp : note = link("Filter explained  here",http://www.tkfilter.bplaced.net/TKFilter%20tutorials%202Dto3D%203D-automatic%20stereoscopic%20conversion.html)

 gimp_tk_video3D :

 sh={-$2} sw={-$sh-$3} size1={w} size2={h}
 -if {narg($_previewflag)==0} _previewflag=0 -endif
 -if {$_previewflag!=0} sh={$sh*{400/$22}} sw={$sw*{400/$22}} -endif

 -if {$26==0}

 ####layer based conversion####

 -if {{$34!=0}||{$35!=0}}
 -if {{$34>={{$!}-$35}}||{$35>={{$!}-$34}}} -error[] "Fade out of frame range."
 -endif -endif

 -if {$13!=14} -channels 0,2 -endif

 -if {$_previewflag!=2}  frames={$!} -else frames=1  -endif
 counter={$!} index=0

 -if {$_previewflag!=0} -r 400,328 -endif

 # image stream alignment and 2D filtering only modes

 #-if {{$41==3}&&{$_previewflag==0}} -error[] "Anaglyph video reconstruction in batch processing mode only" -endif

 flag3d=0 -if {$41!=2}

 -if {!{{$2==0}&&{$3==0}&&{$1==24}&&{$13==14}&&{$32!=0}}} flag3d=1

 # start 3D conversion per frame

 -repeat {$frames}

 # prepare images
 [$index]

 # create depth maps

 -if {{$40==0}||{$40==1}}
 --gimp_tk_depthmap[$index] $1,$4,$5,$6,$7,$8,$9,$38,$39,{w*{$37/1000}}
 -r[-1] $size1,$size2 -endif

 -if {$40==1}
 infilec="correction.png" inpathc="$27/"$infilec""
 -input[-1] $inpathc
 -to_rgba[-1,-2] -compose_rgba[-1,-2] -to_rgb[-1]

 -elif {$40==2}
  infilec="depthmap.png" inpathc="$27/"$infilec""
 -input[-1] $inpathc

 -elif {$40==3}
 -if {$_previewflag==2}
 infilec="depthmap_"$_mapin".png" inpathc="$27/depthmaps/"$infilec""
 -else
  infilec="depthmap_"{$frames-$index}".png" inpathc="$27/depthmaps/"$infilec""
 -endif
 -input[-1] $inpathc
 -rv[$index,-2]

 -endif

 -if {$_previewflag!=0} -r 400,328 -endif

 # motion analysis

 -if {$10!=0}
 -if {$_previewflag==2} [0] -mv[-4] -1
 -compose_difference[-1,-2] -luminance[-1] -n[-1] 0,255
 -ir[-1] 0,{{$37/2}+1} -negate[-1] -n[-1] 0,255
 -else
 [$index] [{$index+1}]
 -compose_difference[-1,-2] -luminance[-1] -n[-1] 0,255

 -ir[-1] 0,{{$37/2}+1}

-negate[-1] -n[-1] 0,255
 -if {$index<={$frames-2}} --negate[-1] -endif
 -endif
 -endif
 index={$index+1} -done

 -if {$10!=0}
 -if {$_previewflag==2}
 -if {$42==0}  infile={$29} -elif {$42==1} infile={$30} -elif {$42==2} infile={$43} -endif

 -if {$infile==2} -rv[-1,-2] -else -if {$infile>={$29+2}}
 -compose_difference[-4,-5] -luminance[-4] -n[-4] 0,255
 -ir[-4] 0,1 -negate[-4] -n[-4] 0,255
 -negate[-4] -compose_darken[-1,-4]
 -mv[-3] -1 -endif -endif
 -blur_xy[-2] {w*{$37/1000}}
 -if {$infile!=$29} -if {$10>=0} -gimp_compose_lighten[-1,-2] {abs($10)/5}
 -else -negate[-2] -gimp_compose_darken[-1,-2] {abs($10)/5} -endif -endif

 -else
 -rm[-1] -rm[{$counter+3}]
 -repeat {$frames-2}
 -mv[{$counter+6}] {$counter+2}
 -compose_darken[{$counter+2},{$counter+3}]
 -rv[{$counter+1},{$counter+2}]
 -blur_xy[{$counter+1}] {w*{$37/1000}}
 -if {$10>=0}
 -gimp_compose_lighten[{$counter+1},{$counter+2}] {abs($10)/5}
 -else -negate[{$counter+1}]
 -gimp_compose_darken[{$counter+1},{$counter+2}] {abs($10)/5}
 -endif
 counter={$counter+2} -done
 -rv[-3,-4] -blur_xy[-4] {w*{$37/1000}}
 -if {$10>=0} -gimp_compose_lighten[-3,-4] {abs($10)/5}
 -else -negate[-4] -gimp_compose_darken[-3,-4] {abs($10)/5} -endif

 -endif
 -endif

 # create second view frameset

 -if {$_previewflag==2} -if {$24!=0} -rm[-2] -endif -endif

 index={-1} -repeat $frames

 -if {$13!=15}

 -if {$41==0} -if {$sw<=0} -negate[$index] -endif -endif

 -if {$_previewflag!=2}
 -if {$34!=0} -if {{-$index}<=$34} sw={{{-$index}/$34}*$sw} sh={{{-$index}/$34}*$sh}
 -endif -endif
 -if {$35!=0} -if {-{$index+1}>={$frames-$35}} sw={$sw*{{$frames-{-{$index+1}}}/$35}}
 sh={$sh*{{$frames-{-{$index+1}}}/$35}} -endif -endif -endif

 -if {$41==0}
 -r[$index] 100%,100%,1,2 -s[$index] c -f[$index] 0 -n[{$index-1}] 0,$sw
 -a[$index,{$index-1}] c -warp[{$index-1}] [$index],1
 -shift[{$index-1}] $sh,0 -rm[$index]

 -else

 [$index]
 -mv[-1] {$frames+{$index+1}}

 -r[$index,{$frames+{$index+1}}] 100%,100%,1,2
 -s[$index] c -f[$index] 0 -n[{$index-1}] 0,{abs($sw/2)} -a[$index,{$index-1}] c

 -negate[{$frames+{$index+1}}] -s[{$frames+{$index+1}}] c
 -f[{$frames+{$index+2}}] 0 -n[{$frames+{$index+1}}] 0,{-abs($sw/2)}
 -a[{$frames+{$index+1}},{$frames+{$index+2}}] c

 -warp[{$frames+{$index+0}}] [{$frames+{$index+1}}],1
 -warp[{$index-1}] [$index],1
 -shift[{$index-1}] $sh,0
 -rm[$index,{$frames+{$index+1}}]

 -endif
 -endif

 sh={-$2} sw={-$sh-$3}
 -if {$_previewflag!=0} sh={$sh*{400/$22}} sw={$sw*{400/$22}} -endif
 index={$index-1} -done

 # frames offset

 -if {$13!=15} -if {$_previewflag!=2}
 -if {$24>=0} -repeat $24 -rm[-1] [$frames]
 -mv[-1] $frames -done
 -else counter={1} -repeat {abs($24)} -rm[$frames]
 [{-$counter}] -mv[-1] {-$counter-1} counter={$counter+1} -done -endif
 -endif -endif

 # autocrop frames

 -if {$20==1} -if {$13!=15}
 -if {$sh>=0} -crop $sh,0,{w},{h} -else -crop 0,0,{w+$sh},{h} -endif
 -if {$sw>=0} -crop $sw,0,{w},{h} -else -crop 0,0,{w+$sw},{h} -endif
 -endif -endif

 #end image stream alignment and 2D mode bypass

 -endif -endif

 # apply custom filter

 -if {$_previewflag!=2}
 -if {$32!=0} -if {$13!=15} -repeat $! -l[$>] -gimp_custom_code "$33",0,0,0 -endl -done -endif -endif
 -else
 -if {$32==1} -if {$13!=15} -gimp_custom_code[0,1] "$33",0,0,0 -endif
 -elif {$32==2} -if {$13!=15} -l[0] -gimp_custom_code "$33",0,0,0 -endl -endif
 -elif {$32==3} -if {$13!=15} -l[1] -gimp_custom_code "$33",0,0,0 -endl -endif
 -endif -endif

 # align stereoscopic images

 -if {$41==2} -if {{$13==14}||{$13==15}} -error[] "Output format not allowed for image stream alignment" -endif -endif
 -if {$12==1} -ac "-gimp_blackandwhite 0.3,0,0.6,0,0.1,0,1,1,0,0,0,0,0,0,2,0,0,0,16,4,0,0,0",rgb -endif

 counter={$frames-1} index={-2}
 -repeat $frames

 -if {{$13!=14}&&{$13!=15}}
 -gimp_tk_stereoimage[-1,$counter] $13,$11,$16,$17,$18,$19
 -elif {$13==15} -rm[0,$index]
 -endif counter={$counter-1} index={$index-1} -done

 # adjust output image streams

 -if {$13==14} -apply_gamma $16 -tk_gimp_channel_processing 1,1,$17,0,0,0,100,256,0,0,1,10,7,0
 -gimp_mix_lab 1,0,0,$18,0,0,$18,0,0,0,2,0 -endif


 # resize frames to output format

 -if {$21==1} -if {$13!=13}
 -if {$23==0} -r $22,{$22*0.75},1,{s},6
 -elif {$23==1} -r $22,{{$22*9}/16},1,{s},6
 -elif {$23==2} -r $22,{{$22*2}/3},1,{s},6
 -elif {$23==3} -r $22,{$22*0.5},1,{s},6
 -elif {$23==4} -r $22,{{$22*9}/21},1,{s},6
 -elif {$23==5} -r $22,{$22*{h/w}},1,{s},6 -endif
 -endif -endif  -c 0,255

 -if {$25==1} -rv -endif

 # save frames to folder

 -if {$14==1}
 -if {{$31==0}||{$13==15}} end=".png" -else end=".bmp" -endif
 -rv

 index={0} name=0
 -if {{$13==14}&&{$flag3d==1}}
 fileleft="$15/frame_left_"{$name+1}$end fileright="$15/frame_right_"{$name+1}$end
 -else  -if {$13!=15} filename="$15/frame_"{$index+1}$end
 -else  filename="$15/depthmap_"{$index+1}$end -endif -endif

 -repeat $frames

 -if {{$13==14}&&{$flag3d==1}}
 -output[$index] $fileright
 -output[{$index+$frames}] $fileleft
 index={$index+1} name={$name+1}
 fileleft="$15/frame_left_"{$name+1}$end fileright="$15/frame_right_"{$name+1}$end

 -else
 -output[$index] $filename
 index={$index+1} -if {$13!=15} filename="$15/frame_"{$index+1}$end -else filename="$15/depthmap_"{$index+1}$end -endif
 -endif

 -done -rv

 -endif

 ####batch based conversion####

 -else

 # load images in batch mode

 -if {$31==0} end=".png" -else end=".bmp" -endif
 infile={$29} inpath="$27/$28"$infile""$end"" outfile={$29}
 frames={{$30-$29}+1} counter=1

 -if {{$34!=0}||{$35!=0}}
 -if {{$34>={$frames-$35}}||{$35>={$frames-$34}}} -error[] "Fade out of frame range"
 -endif -endif

 -if {$41==2}
 inpathleft="$27/$28""left_"$infile$end inpathright="$27/$28""right_"$infile$end
 -endif

 av=1 var=1 avprev=1 varprev=1

 -repeat $frames

 -if {$41!=2}

 -rm -input[0] $inpath
 -if {{$24==0}} [0]
 -else infile2={$infile+$24}
 -if {$infile2<=$29} infile2={$29} -endif
 -if {$infile2>=$30} infile2={$30} -endif
  inpath2="$27/$28"$infile2""$end""
 -input[1] $inpath2 -endif

 -else
 -rm -input[0] $inpathleft
 -input[1] $inpathright
 -endif

 size1={w} size2={h}

 # image stream alignment and 2D filtering only modes

  flag3d=0 -if {$41==3} flag3d=1 -endif -if {{$41!=2}&&{$41!=3}}

 -if {!{{$2==0}&&{$3==0}&&{$1==24}&&{$13==14}&&{$32!=0}}} flag3d=1

 # prepare images

 -if {$13!=14} -channels[0,1] 0,2 -endif

 # create depth map

 -if {{$40==0}||{$40==1}}
 av={0,ia} var={0,iv} diffav={{$av-$avprev}/$avprev*100} diffvar={{$var-$varprev}/$varprev*100}
 -if {{abs($diffav)>=10}||{abs($diffvar)>=10}} scenechange=1 -else scenechange=0 -endif
 -if {{$counter==1}||{$scenechange==1}||{{$counter/$36}=={round($counter/$36,1)}}}
 --gimp_tk_depthmap[0] $1,$4,$5,$6,$7,$8,$9,$38,$39,{w*{$37/1000}} -r[-1] $size1,$size2
 -if {$av!=0} avprev=$av -endif -if {$var!=0} varprev=$var -endif
 -if {$36!=1} filename="$15/depthmap_temp.png"
 -output[-1] $filename -endif
 -else
 filename="$15/depthmap_temp.png"
 -input[-1] $filename
 -endif
 -endif

 -if {$40==1}
 infilec="correction.png" inpathc="$27/"$infilec""
 -input[-1] $inpathc
 -compose_rgba[-1,-2]

 -elif {$40==2}
 infilec="depthmap.png" inpathc="$27/"$infilec""
 -input[-1] $inpathc

 -elif {$40==3}
  infilec="depthmap_"$infile".png" inpathc="$27/depthmaps/"$infilec""
 -input[-1] $inpathc
 -endif

 # motion analysis

 -if {$10!=0} -if {$infile!=$29}

 [0]
 infilemov={$infile-1} inpathmov="$27/$28"$infilemov""$end""
 -input[-1] $inpathmov
 -compose_difference[-1,-2] -luminance[-1] -n[-1] 0,255
 -ir[-1] 0,{{$37/2}+1} -negate[-1] -n[-1] 0,255

 -if {$infile>={$29+2}}
  infilemov2={$infile-2} inpathmov2="$27/$28"$infilemov2""$end""
 -input[-1] $inpathmov2
  infilemov3={$infile-1} inpathmov3="$27/$28"$infilemov3""$end""
 -input[-1] $inpathmov3
 -compose_difference[-1,-2] -luminance[-1] -n[-1] 0,255
 -ir[-1] 0,1 -n[-1] 0,255 -compose_darken[-1,-2]
 -endif -blur_xy[-1] {w*{$37/1000}} -rv[-1,-2]
 -if {$10>=0}
 -gimp_compose_lighten[-1,-2] {abs($10)/5}
 -else
 -negate[-2]
 -gimp_compose_darken[-1,-2] {abs($10)/5}
 -endif

 -endif -endif

 # create second view

 -if {$13!=15}

 -if {$41==0}

 -if {$sw<=0} -negate[2] -endif

 -if {$34!=0} -if {$counter<=$34} sw={{$counter/$34}*$sw} sh={{$counter/$34}*$sh} -endif -endif
 -if {$35!=0} -if {$counter>={$frames-$35}} sw={$sw*{{{$frames-$counter}+1}/$35}}
 sh={$sh*{{{$frames-$counter}+1}/$35}} -endif -endif

 -r[-1] 100%,100%,1,2 -s[-1] c -f[-1] 0 -n[-2] 0,$sw -a[-1,-2] c
 -warp[-2] [-1],1 -shift[-2] $sh,0 -rm[-1]

 -else
 [-1] -r[-1,-2] 100%,100%,1,2
 -s[-1] c -f[-1] 0 -n[-2] 0,{abs($sw/2)} -a[-1,-2] c
 -negate[-2] -s[-2] c -f[-2] 0 -n[-3] 0,{-abs($sw/2)} -a[-2,-3] c
 -warp[-4] [-2],1 -warp[-3] [-1],1
 -shift[-3] $sh,0 -rm[-1,-2]
 -endif

 -endif

 sh={-$2} sw={-$sh-$3}

 # autocrop frames

 -if {$20==1} -if {$13!=15}
 -if {$sh>=0} -crop $sh,0,{w},{h} -else -crop 0,0,{w+$sh},{h} -endif
 -if {$sw>=0} -crop $sw,0,{w},{h} -else -crop 0,0,{w+$sw},{h} -endif
 -endif -endif

 #end image stream alignment and 2D mode bypass

 -endif  -endif

 -if {$41==3} -gimp_tk_deana[0] $37,{{$38*2}+0.1} -to_rgb -endif

 # apply custom filter

 -if {$32==1} -if {$13!=15} -gimp_custom_code[0,1] "$33",0,0,0 -endif
 -elif {$32==2} -if {$13!=15} -l[0] -gimp_custom_code "$33",0,0,0 -endl -endif
 -elif {$32==3} -if {$13!=15} -l[1] -gimp_custom_code "$33",0,0,0 -endl -endif
 -endif

 # align stereoscopic image

 -if {$12==1} -ac[0,1] "-gimp_blackandwhite 0.3,0,0.6,0,0.1,0,1,1,0,0,0,0,0,0,2,0,0,0,16,4,0,0,0",rgb -endif
 -if {{$41==2}&&{$13==14}} -error[] "Output format not allowed for image stream alignment"
 -elif {{$41==3}&&{$13==15}} -error[] "Output format not allowed for anaglyph video reconstruction"
 -elif {{$41==2}&&{$13==15}} --gimp_tk_depth_obtain[0,1] $11,{$37/100},{100-{$38*20}},{$39*20}
 -if {$32!=0} -gimp_custom_code[0,1,-1] "$33",0,0,0 -endif -k[-1]
 -elif {{$41!=2}&&{$13==15}} -k[-1]
 -elif {{$41==3}&&{$13==14}} -k[0,1]
 -else -gimp_tk_stereoimage[0,1] $13,$11,$16,$17,$18,$19 -endif

 # adjust output image streams

 -if {$13==14} -apply_gamma $16 -tk_gimp_channel_processing 1,1,$17,0,0,0,100,256,0,0,1,10,7,0
 -gimp_mix_lab 1,0,0,$18,0,0,$18,0,0,0,2,0 -endif

 # resize frame to output format

 -if {$21==1} -if {$13!=13}
 -if {$23==0}   -r $22,{$22*0.75},1,{s},6
 -elif {$23==1} -r $22,{{$22*9}/16},1,{s},6
 -elif {$23==2} -r $22,{{$22*2}/3},1,{s},6
 -elif {$23==3} -r $22,{$22*0.5},1,{s},6
 -elif {$23==4} -r $22,{{$22*9}/21},1,{s},6
 -elif {$23==5} -r $22,{$22*{h/w}},1,{s},6
 -endif -endif -endif -c 0,255

 # save frame to folder

 -if {{$13==14}&&{$flag3d==1}}
 fileleft="$15/frame_left_"$outfile$end fileright="$15/frame_right_"$outfile$end
 -else  -if {$13!=15} filename="$15/frame_"$outfile$end
 -else  filename="$15/depthmap_"$outfile$end -endif -endif

 -if {{$13==14}&&{$flag3d==1}}
 -output[0] $fileleft -output[1] $fileright
 -else -output[0] $filename
 -endif
 outfile={$outfile+1}

 # end batch processing loops and delete temporary file

 infile={$infile+1} inpath="$27/$28"$infile""$end""
 -if {$41==2} inpathleft="$27/$28""left_"$infile$end inpathright="$27/$28""right_"$infile$end -endif

 counter={$counter+1} -done -endif

 -if {{$_previewflag==0}&&{$26==1}} -if {$36!=1}
 -if ${-is_windows} path="$15" path=${path}{`92`}
 -x "cd \""$path"\" && del depthmap_temp.png"
 -else file="$15/depthmap_temp.png" -x "rm -f \"$file\"" -endif
 -endif -endif


 #####preview function####

 gimp_tk_video3D_preview :

 shpre={$2*{400/$22}} swpre={$3*{400/$22}}

 -if {$26==0}

 #####preview layer mode###

 -if {{$!}==1} -fc[0] 255,0,128,255 -k[0] -text "Select multiple layer",10,80%,24,1,0,0,0,255
 -text "input mode ALL.",10,90%,24,1,0,0,0,255

 -elif {$41==2} -fc[0] 255,0,128,255 -k[0] -text "Alignment of image streams",10,80%,24,1,0,0,0,255
 -text "in BATCH processing mode only!",10,90%,24,1,0,0,0,255

 -elif {$41==3} -fc[0] 255,0,128,255 -k[0] -text "Anaglyph video reconstruction",10,80%,24,1,0,0,0,255
 -text "in BATCH processing mode only!",10,90%,24,1,0,0,0,255

 -else
 _previewflag=1

 -if {$40==3} -if {$42==0} _mapin=1 -elif {$42==1} _mapin={$!} -elif {$42==2}  _mapin=$43 -endif -endif
 -if {$42==0} nr=1 pv={-1} -elif {$42==1} nr={$!} pv={-$!} -elif {{$42==2}||{$42==3}} nr=$43 pv={-$43} -endif
 -if {{$42==2}||{$42==3}} -if {$43>={$!}} nr={$!} pv={-$!} _mapin={$!} -endif -endif

 -if {$42!=3}
 -gimp_tk_video3D[$pv] $1,$shpre,$swpre,${4-9},0,${11-13},0,"$15",${16-23},0,${25-26},"$27","$28",${29-32},"$33",0,0,${36-39},0,${41-43} -k[$pv]
 -text[0] "layer "{``$nr},20,75%,{h*0.1},1,255,{if({{$13==2}||{$13==3}||{$13==15}},0,255)},0,255
 -if {$24!=0} -text "For preview with frames offset ",20,70%,{h*0.05},1,255,{if({$13==15},0,255)},{if({$13==15},0,255)},255
 -text "use full layer stack preview mode!",20,85%,{h*0.05},1,255,{if({$13==15},0,255)},{if({$13==15},0,255)},255 -endif
 -if {{$34!=0}||{$35!=0}} -text "For fade in/out effect preview",20,65%,{h*0.05},1,255,{if({$13==15},0,255)},{if({$13==15},0,255)},255
 -text "use full layer stack preview mode!",20,85%,{h*0.05},1,255,{if({$13==15},0,255)},{if({$13==15},0,255)},255  -endif
 -if {$40!=0} -text "For preview with custom depth correction ",20,60%,{h*0.05},1,255,{if({$13==15},0,255)},{if({$13==15},0,255)},255
 -text "use full layer stack preview mode!",20,85%,{h*0.05},1,255,{if({$13==15},0,255)},{if({$13==15},0,255)},255 -endif
 -if {$10!=0} -text "For preview with motion analyzer ",20,55%,{h*0.05},1,255,{if({$13==15},0,255)},{if({$13==15},0,255)},255
 -text "use full layer stack preview mode!",20,85%,{h*0.05},1,255,{if({$13==15},0,255)},{if({$13==15},0,255)},255 -endif
 -if {{$32==2}||{$32==3}} -text[0] "Separate stream filtering ignored in layer mode",20,50%,{h*0.05},1,255,255,0,255 -endif

 -else
 -gimp_tk_video3D $1,$shpre,$swpre,${4-13},0,"$15",${16-26},"$27","$28",${29-32},"$33",${34-43} -k[$pv]
 -endif

 -text[0] "layer "{``$nr},20,75%,{h*0.1},1,255,{if({{$13==2}||{$13==3}||{$13==15}},0,255)},0,255
 -if {{$2==0}&&{$3==0}&&{$1==24}&&{$13==14}&&{$32!=0}} -text[0] "2D filter mode on!",50%,75%,{h*0.075},1,255,255,0,255 -endif
 -if {$36!=1} -text "Key frame settings ignored in layer processing mode. ",20,50%,{h*0.05},1,255,255,0,255 -endif

 _previewflag=0
 -endif

 -else

 ####preview batch mode####

 _previewflag=2

 -if {$42==3}

 --fc[0] 255,0,128,255 -k[-1]
 -text "No preview available",20,50,28,1,0,0,0,255
 -text "for batch input stack!",20,80,28,1,0,0,0,255
 -text "Please select frame to adjust settings.",20,150,16,1,0,0,0,255

 -elif {{$42==2}&&{{$43<={$29-1}}||{$43>={$30+1}}}} -fc[0] 255,0,128,255 -k[0]
 -text[0] "Selected frame out of range! ",10,80%,24,1,0,0,0,255

 -elif {{$41==2}&&{$13==14}} -fc[0] 255,0,128,255 -k[0]
 -text[0] "Output format not allowed!",10,80%,24,1,0,0,0,255

 -elif {{$41==3}&&{$13==15}} -fc[0] 255,0,128,255 -k[0]
 -text[0] "Output format not allowed!",10,80%,24,1,0,0,0,255

 -else

 -rm
 -if {$31==0} end=".png" -else end=".bmp" -endif

 -if {$42==0}  infile={$29}
 -if {$34!=0} swpre={{1/$34}*$swpre} shpre={{1/$34}*$shpre} -endif

 -elif {$42==1} infile={$30}
 -if {$35!=0} swpre={{1-{1/$35}}*$swpre} shpre={{1-{1/$35}}*$shpre} -endif

 -elif {$42==2} infile={$43}
 -if {{$34!=0}||{$35!=0}}
 -if {$43<={$29+$34}} swpre={{$43/$34}*$swpre} shpre={{$43/$34}*$shpre} -endif
 -if {$43>={$30-$35}} swpre={{$30-$43}*{$swpre/$35}} shpre={{$30-$43}*{$shpre/$35}} -endif

 -endif

 -endif

 -if {$41!=2}

 inpath1="$27/$28"$infile""$end""
 -input[0] $inpath1

 -if {$24!=0} infileoff={$infile+$24}
 -if {$infileoff<=$29} infileoff={$29} -endif
 -if {$infileoff>=$30} infileoff={$30} -endif
  inpathoff="$27/$28"$infileoff""$end""
 -input[1] $inpathoff
 -endif

 -if {$infile!=$29} -if {$10!=0}
 infilemov={$infile-1} inpathmov="$27/$28"$infilemov""$end""
 -input[-1] $inpathmov

 -if {$infile>={$29+2}}
  infilemov2={$infile-2} inpathmov2="$27/$28"$infilemov2""$end""
 -input[-1] $inpathmov2
  infilemov3={$infile-1} inpathmov3="$27/$28"$infilemov3""$end""
 -input[-1] $inpathmov3
 -endif -endif -endif

 -else
  inpathleft="$27/$28""left_"$infile$end inpathright="$27/$28""right_"$infile$end
 -rm -input[0] $inpathleft
 -input[1] $inpathright
 -endif

 -if {$42==0} _mapin=$29 -elif {$42==1} _mapin=$30 -elif {$42==2} _mapin=$43 -endif

 framesn={{$30-$29}+1}
 -if {{{$34!=0}||{$35!=0}}&&{{$34>={$framesn-$35}}||{$35>={$framesn-$34}}}} -fc[0] 255,0,128,255 -k[0]
 -text "Fade out of frame range! ",10,80%,{h*0.1},1,0,0,0,255
 -else
 -if {{$41==2}&&{$13==15}} --gimp_tk_depth_obtain[0,1] $11,{$37/100},{100-{$38*20}},{$39*20}
 -if {$32!=0} -gimp_custom_code[0,1,-1] "$33",0,0,0  -endif -k[-1]
 -else
 -gimp_tk_video3D $1,$shpre,$swpre,${4-9},{if({$infile==$29},0,$10)},${11-13},0,"$15",${16-25},0,"$27","$28",${29-31},{if({{$2==0}&&{$3==0}&&{$1==24}&&{$13==14}&&{$32!=0}},2,$32)},"$33",0,0,1,${37-43}
 -endif -to_rgb -if {$13==14} -k[-1] -endif

 -text[0] "frame "{``$infile},20,75%,{h*0.1},1,255,{if({{$13==2}||{$13==3}||{$13==15}},0,255)},0,255
 -if {$41!=2} -if {$36!=1} -if {{$40==0}||{$40==1}} -text[0] "Preview always forced to key frame. ",20,50%,{h*0.05},1,255,255,0,255 -else
 -text[0] "No keyframe computation for individual maps. ",20,64%,{h*0.05},1,255,255,0,255 -endif -endif -endif
 -if {{$2==0}&&{$3==0}&&{$1==24}&&{$13==14}&&{$32!=0}} -text[0] "2D filter mode on!",50%,75%,{h*0.075},1,255,255,0,255 -endif

 -endif -endif -endif

 _previewflag=0

#************END OF FILTER***************


#****************************************
#lenticular print
#****************************************

#@gimp Lenticular print : gimp_tk_lenticular, gimp_tk_lenticular(1)
#@gimp : sep = separator()
#@gimp : Lenticular density lpi = float(30,5,200)
#@gimp : Lenticular orientation = choice("vertical","horizontal")
#@gimp : Print size width = float(5,1,50)
#@gimp : Print size unit = choice("inch","centimeter")
#@gimp : Print adjustment marks = bool(1)
#@gimp : Automatic upscale for optimum results = bool(0)
#@gimp : sep = separator(), note = note("<small>Author: <i>Tom Keil</i>.      Latest update: <i>06/10/2011</i>.</small>")
##@gimp : note = link("Filter explained here",http://www.tkfilter.bplaced.net/TKFilter%20tutorials%202Dto3D%203D-automatic%20stereoscopic%20conversion.html)

gimp_tk_lenticular :

 -if {$!<=1} -return -endif
 frames={$!} index=0 -if {$4==0} length=$3 -else length={$3/2.54} -endif
 lenses={$length*$1} lensewidth={w/$lenses}
 picstripe={$lensewidth/$frames} x=0 y=0 end={$picstripe}
 step={$lensewidth-$picstripe}

 #automatic upscale

 -if {$6==1}
 -if {$picstripe!={int($picstripe)}} scale={{int($picstripe)+1}/$picstripe}
 -r {w*$scale},{h*$scale} lensewidth={w/$lenses} picstripe={$lensewidth/$frames}
 end={$picstripe} step={$lensewidth-$picstripe} -endif -endif

#generate mask

 -to_rgb --fc[-1] 255,255,255 -repeat $lenses
 -if {$2==0}
 -fill[-1] if(x>=$end,0,i) x={$x+$step} end={$end+$step}
 -fill[-1] if(x>=$end,255,i) x={$x+$picstripe} end={$end+$picstripe}
 -else
 -fill[-1] if(y>=$end,0,i) y={$y+$step} end={$end+$step}
 -fill[-1] if(y>=$end,255,i) y={$y+$picstripe} end={$end+$picstripe}
 -endif -done

#shift mask to position and apply on frames

 -repeat {$frames-1} --to_gray[-1] -ir[-1] 128,256 -n[-1] 0,255
 -if {$2==0} -shift[-1] {{$picstripe}*{$frames-{$index+1}}}
 -else -shift[-1] 0,{{$picstripe}*{$frames-{$index+1}}} -endif
 -s[$index] c -a[$index,{$index+1},{$index+2},-1] c
 index={$index+1} -done

#compose all layers

 -repeat {$frames-1} -rv[0,-2] -compose_rgba[0,-2] -rv[0,-2] -done

#create adjustment marks

 -if {$5==1} -to_rgba[0]
 -if {$2==0} -shift[0] 0,5 -else -shift[0] 5,0 -endif
 -negate[-1] -rv -compose_rgba -else -rm[-1] -endif

#************END OF FILTER***************

#****************************************
#       STEREOGRAM
#****************************************

#@gimp Single image stereogram : gimp_tk_stereogram, gimp_tk_stereogram_preview(1)
#@gimp : sep = separator()
#@gimp : Deviation = float(50,0,200)
#@gimp : sep = separator(), note = note("Pattern generator")
#@gimp : Pattern variation 1 = float(0.5,0,1)
#@gimp : Pattern variation 2 = float(10,0,20)
#@gimp : Pattern variation 3 = float(0,0,1)
#@gimp : Tiles = int(40,10,100)
#@gimp : Color 1 = color(255,255,0)
#@gimp : Color 2 = color(255,0,0)
#@gimp : Color 3 = color(0,255,0)
#@gimp : Color 4 = color(0,0,255)
#@gimp : Color strength = float(0.5,0,1)
#@gimp : sep = separator(), Preview type = choice("Full","Forward horizontal","Forward vertical","Backward horizontal","Backward vertical","Duplicate top","Duplicate left","Duplicate bottom","Duplicate right")
#@gimp : sep = separator(), note = note("<small>Author: <i>Tom Keil</i>.      Latest update: <i>02/25/2012</i>.</small>")
#@gimp : note = note("Input image should be a <b>depth map</b> which is turned into an autostereogram, also known as magic eye image")
##@gimp : note = link("Filter explained here",http://www.tkfilter.bplaced.net/TKFilter%20filter.html)
#@gimp : note = link("Background explained here","http://en.wikipedia.org/wiki/Autostereogram")

gimp_tk_stereogram :

-repeat $! -l[$>] -to_gray --fc[-1] 255,255,255
-gimp_plasma[-1] $2,$3,8,0,0,128,128,128
-gimp_array[-1] 10,10,0,0,0,0
-gimp_array_fade[-1] {$5/10},{$5/10},0,0,80,90,3,0
-r[-1] [0],[0]
-gimp_noise[-1] {w/30},0,3,0,0
--gimp_rorschach[-1] $4,1,0 -rv[-1,-2] -gimp_compose_multiply[-1,-2] 0.5
--gimp_corner_gradient[-1] $6,$7,$8,255,$9,$10,$11,255,$12,$13,$14,255,$15,$16,$17,255
-rv[-1,-2] -gimp_compose_hardlight[-1,-2] $18
-rv[-1,-2]
-r[-1] 100%,100%,1,2
-s[-1] c -f[-1] 0 -n[-2] 0,$1 -a[-1,-2] c
-warp[-2] [-1],1
-rm[-1] -endl -done

gimp_tk_stereogram_preview :
 -gimp_split_preview "-gimp_tk_stereogram ${1--2}",$-1


#*******END OF FILTER********************


#****************************************
#Stereoscopic image alignment
#****************************************

#@gimp Stereoscopic image alignment : gimp_tk_stereoimage, gimp_tk_stereoimage(1)
#@gimp : sep = separator()
#@gimp : Mode = choice("Anaglyph red/cyan","Anaglyph red/cyan optimized","Anaglyph blue/yellow","Anaglyph blue/yellow optimized","Anaglyph green/magenta","Anaglypgh green/magenta optimized","Full side by side keep width","Full side by side keep uncompressed","Full bottom/top","Half side  by side","Half bottom/top","Interlace horizontal","Interlace vertical","Full HD frame packing")
#@gimp : Flip left / right = bool(0)
#@gimp : Gamma compensation = float(1,0,4)
#@gimp : Anti-ghosting = float(0,0,255)
#@gimp : Color boost = float(1,0,4)
#@gimp : Anaglyph glasses adjustment = float(0,-100,100)
#@gimp : sep = separator()  note = note("This filter needs two aligned input images.")
#@gimp : sep = separator(), note = note("<small>Author: <i>Tom Keil</i>     Latest update: <i>08/04/2012</i>.</small>")

gimp_tk_stereoimage :

 -if {$!<=1} -return -endif
 -local -to_rgb

 -if {$4!=0} -tk_gimp_channel_processing 1,1,$4,0,0,0,100,256,0,0,1,10,7,0 -endif
 -if {{$1==0}||{$1==1}||{$1==2}||{$1==3}||{$1==4}||{$1==5}} -apply_gamma $3 -endif

 -if {$1==0} -if {$2==0} -rv[-1,-2] -endif -s c
 -rm[-3,-4,-5] -a[-1,-2,-3] c

 -elif {$1==1} -if {$2==1} -rv[-1,-2] -endif
 -apply_gamma[-1] 1.15 -apply_gamma[-2] 1.0 -s c
 rlr=456 rlg=500 rlb=176 rrr={-43} rrg={-88} rrb={-2}
 glr={-40} glg={-38} glb={-16} grr=378 grg=734 grb={-18}
 blr={-15} blg={-21} blb={-5} brr={-72} brg={-113} brb=1226
 [0-5]
 -*[-3] $rlr -*[-2] $rlg -*[-1] $rlb -*[-6] $rrr -*[-5] $rrg -*[-4] $rrb
 -+[-6] [-5] -+[-6] [-4] -+[-6] [-3] -+[-6] [-2] -+[-6] [-1] -rm[-1--5]
 -/[-1] 1000 -n[-1] 0,255 -to_gray[-1]
 [0-5]
 -*[-3] $glr -*[-2] $glg -*[-1] $glb -*[-6] $grr -*[-5] $grg -*[-4] $grb
 -+[-6] [-5] -+[-6] [-4] -+[-6] [-3] -+[-6] [-2] -+[-6] [-1] -rm[-1--5]
 -/[-1] 1000 -n[-1] 0,255 -to_gray[-1]
 [0-5]
 -*[-3] $blr -*[-2] $blg -*[-1] $blb -*[-6] $brr -*[-5] $brg -*[-4] $brb
 -+[-6] [-5] -+[-6] [-4] -+[-6] [-3] -+[-6] [-2] -+[-6] [-1] -rm[-1--5]
 -/[-1] 1000 -n[-1] 0,255 -to_gray[-1]
 -k[-1--3] -a[-1,-2,-3] c

 -elif {$1==2} -if {$2==0} -rv[-1,-2] -endif -s c
 -rm[-6,-5,-1] -mv[0] 3  -a[-1,-2,-3] c

 -elif {$1==3} -if {$2==1} -rv[-1,-2] -endif
 -apply_gamma[-1] 0.9 -apply_gamma[-2] 1.25 -s c
 rrr=1062 rrg={-205} rrb=299 rlr={-16} rlg={-123} rlb={-17}
 grr={-26} grg=908 grb=68 glr=6 glg=62 glb={-17}
 brr={-38} brg={-173} brb=22 blr=94 blg=185 blb=911
 [0-5]
 -*[-3] $rlr -*[-2] $rlg -*[-1] $rlb -*[-6] $rrr -*[-5] $rrg -*[-4] $rrb
 -+[-6] [-5] -+[-6] [-4] -+[-6] [-3] -+[-6] [-2] -+[-6] [-1] -rm[-1--5]
 -/[-1] 1000 -n[-1] 0,255 -to_gray[-1]
 [0-5]
 -*[-3] $glr -*[-2] $glg -*[-1] $glb -*[-6] $grr -*[-5] $grg -*[-4] $grb
 -+[-6] [-5] -+[-6] [-4] -+[-6] [-3] -+[-6] [-2] -+[-6] [-1] -rm[-1--5]
 -/[-1] 1000 -n[-1] 0,255 -to_gray[-1]
 [0-5]
 -*[-3] $blr -*[-2] $blg -*[-1] $blb -*[-6] $brr -*[-5] $brg -*[-4] $brb
 -+[-6] [-5] -+[-6] [-4] -+[-6] [-3] -+[-6] [-2] -+[-6] [-1] -rm[-1--5]
 -/[-1] 1000 -n[-1] 0,255 -to_gray[-1]
 -k[-1--3] -a[-3,-2,-1] c

 -elif {$1==4} -if {$2==0} -rv[-1,-2] -endif  -s c
 -rm[-1,-3,-5] -mv[-1] -2 -a[-3,-2,-1] c

 -elif {$1==5} -if {$2==1} -rv[-1,-2] -endif  -s c
 -apply_gamma[-1] 1 -apply_gamma[-2] 1.15 -s c
 rrr={-62} rrg={-158} rrb={-39} rlr={529} rlg={705} rlb={24}
 grr={284} grg=668 grb=143 glr={-16} glg={-15} glb={-65}
 brr={-15} brg={-27} brb=21 blr=9 blg=75 blb=937
 [0-5]
 -*[-3] $rlr -*[-2] $rlg -*[-1] $rlb -*[-6] $rrr -*[-5] $rrg -*[-4] $rrb
 -+[-6] [-5] -+[-6] [-4] -+[-6] [-3] -+[-6] [-2] -+[-6] [-1] -rm[-1--5]
 -/[-1] 1000 -n[-1] 0,255 -to_gray[-1]
 [0-5]
 -*[-3] $glr -*[-2] $glg -*[-1] $glb -*[-6] $grr -*[-5] $grg -*[-4] $grb
 -+[-6] [-5] -+[-6] [-4] -+[-6] [-3] -+[-6] [-2] -+[-6] [-1] -rm[-1--5]
 -/[-1] 1000 -n[-1] 0,255 -to_gray[-1]
 [0-5]
 -*[-3] $blr -*[-2] $blg -*[-1] $blb -*[-6] $brr -*[-5] $brg -*[-4] $brb
 -+[-6] [-5] -+[-6] [-4] -+[-6] [-3] -+[-6] [-2] -+[-6] [-1] -rm[-1--5]
 -/[-1] 1000 -n[-1] 0,255 -to_gray[-1]
 -k[-1--3] -a[-3,-2,-1] c

 -elif {$1==6} -if {$2==1} -rv[-1,-2] -endif
 -r[-1,-2] 50%,50%,1,3,6 -a[-1,-2] x

 -elif {$1==7} -if {$2==1} -rv[-1,-2] -endif -a[-1,-2] x

 -elif {$1==8} -if {$2==1} -rv[-1,-2] -endif -a[-1,-2] y

 -elif {$1==9} -if {$2==1} -rv[0,1] -endif
 -r[0,1] 50%,100%,1,3,6 -a[0,1] x


 -elif {$1==10} -if {$2==1} -rv[0,1] -endif
 -r[0,1] 100%,50%,1,3,6 -a[0,1] y

 -elif {$1==11} -to_rgba[0,1]
 -if {$2==1} -rv[0,1] -endif
 -fill[0] if(y%2==0,0,i) -rv[0,1] -compose_rgba[0,1] -to_rgb

 -elif {$1==12} -to_rgba[0,1]
 -if {$2==1} -rv[0,1] -endif
 -fill[0] if(x%2==0,0,i) -rv[0,1] -compose_rgba[0,1] -to_rgb

 -elif {$1==13}
 -if {$2==1} -rv[0,1] -endif
 -r[0,1] 1920,1080,1,3,6 --fc[-1] 0,0,0 -r[-1] 1920,45
 -rv[-1,-2] -a[-1,-2] y -a[-1,-2] y

 -endif -c 0,255

 -if {{$1==6}||{$1==7}||{$1==8}||{$1==9}||{$1==10}||{$1==11}||{$1==12}||{$1==13}}
 -apply_gamma $3 -endif
 -gimp_mix_lab 1,0,0,$5,0,0,$5,0,0,0,2,0
 -if {{$1==0}||{$1==1}} -gimp_mix_rgb 1,$6,0,1,0,0,1,0,0,0,2,0 -endif
 -if {{$1==2}||{$1==3}} -gimp_mix_rgb 1,0,0,1,0,0,1,$6,0,0,2,0 -endif
 -if {$1==4} -gimp_mix_rgb 1,0,0,1,$6,0,1,0,0,0,2,0 -endif
 -if {$1==5} -gimp_mix_rgb 1,0,0,1,$6,0,1,{if({$6>=0},$6,0)},0,0,2,0 -endif

 -endl

#************END OF FILTER***************


#****************************************
#depth map construction
#****************************************

#@gimp Depth map construction : gimp_tk_depthmap, gimp_tk_depthmap(1)
#@gimp : sep = separator()
#@gimp : note = note("This filter estimates and constructs a depth map for a 2D image ")
#@gimp : Scene selector = choice("automatic depth estimation","daylight scene","optimized lateral inhibition","light motive","dark  motive","landscape","center foreground","center background","left  foreground","left diagonal foreground","right foreground","right diagonal  foreground","left and right foreground","left and right background","bottom and top foreground","bottom and left foreground","bottom and right foreground","central  perspective outdoor","central perspective indoor","portrait","human 1","human  2","studio","underwater","flat")
#@gimp : Depth field control = float(20,0,100)
#@gimp : Feature analyzer threshold = float(0,0,5)
#@gimp : Feature analyzer smoothness = float(0,0,5)
#@gimp : Local detail enhancer = float(0,0,5)
#@gimp : DOF analyzer = float(0,0,5)
#@gimp : Frequency analyzer = float(0,0,5)
#@gimp : Preprocessor radius = float(0,0,5)
#@gimp : Preprocessor Power = float(0,0,5)
#@gimp : Smoothing = float(0,0,100)
#@gimp : sep = separator(), note = note("<small>Author: <i>Tom Keil</i>       Latest update: <i>07/30/2012</i>.</small>")

gimp_tk_depthmap :

 -repeat $! -l[$>] -to_rgb size1={w} -resize2dx 400,2
 -if {{$8!=0}||{$8!=0}} -gimp_map_tones_fast {$8*4},{$9/5},3,0 -endif
 -if {$1==0} --gimp_tk_autodepth[-1]
 --luminance[0] -gimp_map_tones[-1] 1,0.25,0,30,3,0
 -rv[-1,-2] -gimp_compose_value[-1,-2] 0.15
 -tk_gimp_channel_processing[-1] 1,{$2/20},0,0,0,0,100,256,0,0,0,2,0,0
 -elif {$1==1} --channels[0] 2
 -tk_gimp_channel_processing[-1] 1,{{$2/25}+0.1},0,0,0,0,100,256,0,1,0,2,0,0
 --gimp_linear_gradient[-1] 0,0,0,255,255,255,255,255,0,90,0,{100-{$2/1.5}}
 -rv[-1,-2] -gimp_compose_lighten[-1,-2] {0.5+{$2/200}}
 -elif {$1==2} --s[-1] c -gimp_dog[-1] 0.4,0,0,0,0
 -negate[-2]  -gimp_dog[-3] 0.4,0,0,0,0
 -gimp_compose_alpha[-1,-2] 0.44,0
 -gimp_compose_alpha[-1,-2] 0.44,0
 -tk_gimp_channel_processing[-1] 1,{$2/20},0,0,0,0,100,256,0,0,0,2,0,0
 -elif {$1==3} --luminance[-1]
 -tk_gimp_channel_processing[-1] 1,{$2/25},0,0,0,0,100,256,0,0,0,2,0,0
 -elif {$1==4} --luminance[-1] -negate[-1]
 -tk_gimp_channel_processing[-1] 1,{$2/25},0,0,0,0,100,256,0,0,0,2,0,0
 -elif {$1==5}
 --gimp_linear_gradient[-1] 0,0,0,255,255,255,255,255,0,90,0,{100-$2}
 -elif {$1==6}
 --gimp_radial_gradient[-1] 0,0,0,255,255,255,255,255,1,$2,100,50,50
 -elif {$1==7}
 --gimp_radial_gradient[-1] 0,0,0,255,255,255,255,255,0,0,{100-$2},50,50
 -elif {$1==8}
 --gimp_linear_gradient[-1] 0,0,0,255,255,255,255,255,1,0,$2,100
 -elif {$1==9}
 --gimp_linear_gradient[-1] 0,0,0,255,255,255,255,255,1,315,$2,100
 -elif {$1==10}
 --gimp_linear_gradient[-1] 0,0,0,255,255,255,255,255,0,0,0,{100-$2}
 -elif {$1==11}
 --gimp_linear_gradient[-1] 0,0,0,255,255,255,255,255,0,45,0,{100-$2}
 -elif {$1==12}
 --gimp_linear_gradient[-1] 0,0,0,255,255,255,255,255,0,0,50,{100-{$2/2}}
 --gimp_linear_gradient[-1] 0,0,0,255,255,255,255,255,0,180,50,{100-{$2/2}}
 -compose_lighten[-1,-2]
 -elif {$1==13}
 --gimp_linear_gradient[-1] 0,0,0,255,255,255,255,255,1,180,100,{50+{$2/2}}
 --gimp_linear_gradient[-1] 0,0,0,255,255,255,255,255,0,180,{50-{$2/2}},0
 -compose_darken[-1,-2]
 -elif {$1==14}
 --gimp_linear_gradient[-1] 0,0,0,255,255,255,255,255,0,90,50,{100-{$2/2}}
 --gimp_linear_gradient[-1] 0,0,0,255,255,255,255,255,0,270,50,{100-{$2/2}}
 -compose_lighten[-1,-2]
 -elif {$1==15}
 --gimp_linear_gradient[-1] 0,0,0,255,255,255,255,255,0,180,50,{100-{$2/2}}
 --gimp_linear_gradient[-1] 0,0,0,255,255,255,255,255,0,90,50,{100-{$2/2}}
 -compose_lighten[-1,-2]
 -elif {$1==16}
 --gimp_linear_gradient[-1] 0,0,0,255,255,255,255,255,0,0,50,{100-{$2/2}}
 --gimp_linear_gradient[-1] 0,0,0,255,255,255,255,255,0,90,50,{100-{$2/2}}
 -compose_lighten[-1,-2]
 -elif {$1==17}
 --gimp_linear_gradient[-1] 0,0,0,255,255,255,255,255,0,0,50,{100-{$2/4}}
 --gimp_linear_gradient[-1] 0,0,0,255,255,255,255,255,0,180,50,{100-{$2/4}}
 -compose_lighten[-1,-2]
 --gimp_linear_gradient[-1] 0,0,0,255,255,255,255,255,0,90,0,{100-{$2/2}}
 -compose_lighten[-1,-2]
 -elif {$1==18}
 --gimp_linear_gradient[-1] 0,0,0,255,255,255,255,255,0,0,50,{100-{$2/4}}
 --gimp_linear_gradient[-1] 0,0,0,255,255,255,255,255,0,180,50,{100-{$2/4}}
 -compose_lighten[-1,-2]
 --gimp_linear_gradient[-1] 0,0,0,255,255,255,255,255,0,90,0,{100-{$2/4}}
 -compose_lighten[-1,-2]
 --gimp_linear_gradient[-1] 0,0,0,255,255,255,255,255,0,270,50,{100-{$2/4}}
 -compose_lighten[-1,-2]
 -elif {$1==19} --channels[-1] 0
 -tk_gimp_channel_processing[-1] 1,{$2/25},0,0,0,0,100,256,0,0,0,2,0,0
 --gimp_radial_gradient[-1] 0,0,0,255,255,255,255,255,1,$2,100,50,50
 -rv[-1,-2] -compose_multiply[-1,-2]
 -elif {$1==20}
 --gimp_gaussian_blur[-1] $6,0,0,1,0,0,0
 -gimp_edges[-1] {$4/2},{50-{$2/2}},1,0
 --gimp_gradient_norm[0] {$4/2},{1.5-{$2/67}},0,{100-$2},0,0
 -rv[-1,-2] -compose_lighten[-1,-2] --channels[0] 0
 -tk_gimp_channel_processing[-1] 1,{{$2/25}+1},0,0,0,0,100,256,0,0,0,2,0,0
 -rv[-1,-2] -compose_lighten[-1,-2]
 --gimp_linear_gradient[-1] 0,0,0,255,255,255,255,255,0,0,50,{100-{$2/4}}
 --gimp_linear_gradient[-1] 0,0,0,255,255,255,255,255,0,180,50,{100-{$2/4}}
 -compose_lighten[-1,-2]
 --gimp_linear_gradient[-1] 0,0,0,255,255,255,255,255,0,90,0,{100-{$2/2}}
 -compose_lighten[-1,-2] -rv[-1,-2] -compose_lighten[-1,-2]
 -elif {$1==21} --gimp_gaussian_blur[-1] $4,0,0,1,0,0,0
 -gimp_edges[-1] {$4/2},{50-{$2/2}},1,0
 --gimp_gradient_norm[0] {$4/2},{1.5-{$2/67}},0,{100-$2},0,0
 -rv[-1,-2] -compose_lighten[-1,-2] --channels[0] 0
 -tk_gimp_channel_processing[-1] 1,{{$2/25}+0.5},0,0,0,0,100,256,0,0,0,2,0,0
 -rv[-1,-2] -compose_lighten[-1,-2]
 --gimp_linear_gradient[-1] 0,0,0,255,255,255,255,255,0,0,0,{100-$2}
 --gimp_linear_gradient[-1] 0,0,0,255,255,255,255,255,0,180,0,{100-$2}
 -compose_darken[-1,-2] -rv[-1,-2] -compose_darken[-1,-2]
 --gimp_linear_gradient[-1] 0,0,0,255,255,255,255,255,0,90,75,{100-{$2/4}}
 -rv[-1,-2] -gimp_compose_lighten[-1,-2] 0.5
 -elif {$1==22} --gimp_gaussian_blur[-1] $4,0,0,1,0,0,0
 -gimp_edges[-1] {$4/2},{50-{$2/2}},1,0
 --gimp_gradient_norm[0] {$4/2},{1.5-{$2/67}},0,{100-$2},0,0
 -rv[-1,-2] -compose_lighten[-1,-2] --channels[0] 0
 -tk_gimp_channel_processing[-1] 1,{{$2/25}+0.5},0,0,0,0,100,256,0,0,0,2,0,0
 -rv[-1,-2] -compose_lighten[-1,-2]
 -elif {$1==23} --channels[-1] 0
 -tk_gimp_channel_processing[-1] 1,{$2/25},0,0,0,0,100,256,0,0,0,2,0,0
 -elif {$1==24} --fc[-1] 0,0,0
 -endif

 # analyze image features

 -if {$7!=0}
 --fc[0] 128,128,128 --channels[0] 2 -negate[-1] -c[-1] 0,90
 -n[-1] 0,128 -rv[-1,-2] -compose_darken[-1,-2]
 --channels[0] 0 -negate[-1] -c[-1] 165,255 -n[-1] 128,255 -rv[-1,-2]
 -compose_hardlight[-1,-2] -rv[-1,-2]
 -if {$1!=19} -gimp_compose_average[-1,-2] {$7/5}
 -else -gimp_compose_value[-1,-2] {$7/5},0
 -tk_gimp_channel_processing[-1] 1,{$2/25},0,0,0,0,100,256,0,0,0,2,0,0
 -endif -endif

 -if {$6!=0} --gimp_highpass[0] 2,2,0,0,0
 -tk_gimp_replace_color[-1] 5,0,128,128,128,255,0,0,0,255
 -gimp_morpho[-1] 3,70,0,0,0,1,0   -to_gray[-1] av={ia}
 -ir[-1] $av,255 -n[-1] 0,255 -blur_xy[-1] 25
 -rv[-1,-2] -gimp_compose_overlay[-1,-2] {$6/5} -endif

 -if {$3!=0} --gimp_isophotes[0] {{$3*3}+2},0,0,0
 -gimp_morpho[-1] 3,{5-{$3/2}},0,0,0,1,0
 -tk_gimp_channel_processing[-1] 1,1,255,0,0,0,100,256,0,0,0,2,0,0
 -rv[-1,-2] -gimp_compose_overlay[-1,-2] {$3/10}
 --gimp_gradient_norm[0] {$4*2},{1.5-{0.1+{$3/3.6}}},0,100,0,0
 -rv[-1,-2] -compose_lighten[-1,-2] -gimp_segment_watershed[-1] $3,$4,0,0
 -endif

 -blur_y[-1] $10 -blur_x[-1] {$10/2}

 -if {$5!=0} --luminance[0] -gimp_map_tones[-1] 1,{0.25-{$5/20}},0,30,3,0
 -rv[-1,-2] -gimp_compose_overlay[-1,-2] {$5/10} -endif

 -n[-1] 0,255 -rm[0] -resize2dx $size1,2 -endl -done

#*******END OF FILTER********************


#****************************************
#automatic depth estimation
#****************************************

#@gimp Automatic depth estimation : gimp_tk_autodepth, gimp_tk_autodepth(1)
#@gimp : sep = separator()
#@gimp : note = note("This filter estimates a depth map from a 2D image by analyzing various monoscopic image properties.")
#@gimp : sep = separator(), note = note("<small>Author: <i>Tom Keil</i>       Latest update: <i>07/30/2012</i>.</small>")

gimp_tk_autodepth :

 -repeat $! -l[$>] -to_rgb size1={w} -resize2dx 400,2

 #coefficient settings

 whpos=128 blpos=128 rpos=255 gpos=200 blupos=200 crga=1.5 crmix1=0.5 crmix2=0.5 geocomp1=75 geocomp2=30
 geostr=0.3 focstr=0.3 featsize=60 featpos=128 feattr=35 tr=30 rtr=90 gtr=90 blutr=90 contstr=0.9
 featinfl=1 foctol=5 focmorph=70 focavt=85 focavt2=140 focvart=2000 latinhib=0.5

 #depth from gravity

 --gimp_map_tones_fast[-1] 10,0.5,0,0 -luminance[-1]
 -gimp_segment_watershed[-1] 0.5,1,0  -label[-1] 5,0
 --gimp_gradient_norm[0] 0,0.5,0,100,0,0 -compose_lighten[-1,-2]
 -gimp_segment_watershed[-1] 0.5,1,0 -label[-1] 5,0 -n[-1] 0,255

 #depth from luminance and compensate over/underexposed areas

 --luminance[0]

 --channels[0] 1 -ir[-1] $gtr%,100%
 -gimp_morpho[-1] 2,2,0,0,0,1,0 -n[-1] 0,$gpos
 -tk_gimp_replace_color[-1] 1,0,0,0,0,255,0,0,0,0  -blend[-1,-2] alpha

 --channels[0] 0 -ir[-1] $rtr%,100%
 -gimp_morpho[-1] 2,2,0,0,0,1,0 -n[-1] 0,$rpos
 -tk_gimp_replace_color[-1] 1,0,0,0,0,255,0,0,0,0 -blend[-1,-2] alpha

 --channels[0] 2 -ir[-1] $blutr%,100%  -n[-1] 0,$blupos
 -gimp_morpho[-1] 2,2,0,0,0,1,0
 -tk_gimp_replace_color[-1] 1,0,0,0,0,255,0,0,0,0
 -to_rgba[-1] --gimp_linear_gradient[-1] 0,0,0,255,255,255,255,255,0,90,0,100
 -s[-2] c -rv[-1,-2] -compose_multiply[-1,-2] -to_gray[-1] -a[-4,-3,-2,-1] c
 -blend[-1,-2] alpha

 --channels[0] 0 --luminance[0] -compose_average[-1,-2] -ir[-1] 80%,95%
 -gimp_morpho[-1] 2,2,0,0,0,1,0 -n[-1] 0,$whpos
 -tk_gimp_replace_color[-1] 1,0,0,0,0,255,0,0,0,0 -blend[-1,-2] alpha

 --channels[0] 0 --luminance[0] -compose_average[-1,-2] -ir[-1] 5%,20%
 -gimp_morpho[-1] 2,2,0,0,0,1,0 -n[-1] 0,$blpos
 -tk_gimp_replace_color[-1] 1,0,0,0,0,255,0,0,0,0 -blend[-1,-2] alpha

 #depth from lateral inhibition

 --gimp_gradient_norm[0] 0,0.5,0,50,0,0

 [-1]
 -gimp_morpho[-1] 2,$featsize,0,0,0,1,0
 -ir[-1] $feattr%,100%
 -n[-1] 0,$featpos
 -blur_xy[-1] 2
 -gimp_compose_lighten[-1,-2] $contstr
 -blur_xy[-1] 2

 #depth from color

 -to_rgb[0] -rgb2ycbcr[0] --channels[0] 2 -ycbcr2rgb[0]
 -n[-1] 0,255 -c[-1] 25%,100%  -apply_gamma[-1] $crga

 --channels[0] 2 -negate[-1] -c[-1] 0,128
 -to_rgba[-1] --gimp_linear_gradient[-1] 0,0,0,255,255,255,255,255,0,270,0,100
 -s[-2] c -rv[-1,-2] -compose_multiply[-1,-2] -to_gray[-1]
 -a[-4,-3,-2,-1] c -rv[-1,-2] -gimp_compose_darken[-1,-2] $crmix1

 #depth from geometry

 --luminance[0] -gimp_houghsketchbw[-1] 10,5,15,$tr,1,1,0 complex={ia}
 -if {$complex>=$geocomp1}
 -do tr={$tr+10} -rm[-1] --luminance[0] -gimp_houghsketchbw[-1] 10,5,15,$tr,1,1,0 complex={ia}
 -while {{$complex>=$geocomp2}&&{$tr<=90}} -endif
 -gimp_morpho[-1] 3,5,0,0,0,1,0 -blur_xy[-1] 1 -gimp_distance[-1] 255,0,1,1,0
 complex={ia}


 #depth from focus

 --gimp_highpass[0] 2,2,0,0,0
 -tk_gimp_replace_color[-1] $foctol,0,128,128,128,255,0,0,0,255
 -gimp_morpho[-1] 3,$focmorph,0,0,0,1,0   -to_gray[-1]
 av={ia} var={iv}
 -if {{$av<=$focavt}||{{$av>=$focavt}&&{$av<=$focavt2}&&{$var<=$focvart}}}
 -ir[-1] $av,255 -n[-1] 0,255 -blur_xy[-1] 10 -else -fc[-1] 128,128,128 -endif

 #lateral inhibition emphaziser

 --gimp_gradient_norm[0] 0,0.5,0,50,0,0


 #composing depth representations

 -rm[0]
 -gimp_compose_overlay[-7,-6] 0.5

 -gimp_compose_overlay[-6,-5] $featinfl

 -gimp_compose_value[-5,-4] $crmix2

 -rv[-4,-3]
 -if {$complex!=0} -gimp_compose_overlay[-4,-3] $geostr -else -rm[-3] -endif

 -rv[-3,-2]
 -gimp_compose_overlay[-3,-2] $focstr

 -rv[-2,-1]
 -gimp_compose_lighten[-1,-2] $latinhib


 #final segmentation and smoothing

 -blur_xy[-1] 2  -gimp_morpho[-1] 3,20,0,0,0,1,0
 -gimp_segment_watershed[-1] 15,0,0 -n[-1] 0,255

 -blur_y[-1] 2 -blur_x[-1] 1
 -resize2dx $size1,2
 -endl -done

#************END OF FILTER***************

#****************************************
# depth map reconstruction
#****************************************

#@gimp Depth map reconstruction : gimp_tk_depth_obtain, gimp_tk_depth_obtain(1)
#@gimp : note = note("This filter estimates a depth map from the left and the right view of a stereoscopic image. Images must be aligned correct to compute correct depth information.")
#@gimp : flip left/right = bool(0)
#@gimp : Smoothness = float(0.1,0,1)
#@gimp : Center size = float(100,0,100)
#@gimp : Center smoothness = float(0,0,50)
#@gimp : sep = separator(), note = note("<small>Author: <i>Tom Keil</i>       Latest update: <i>09/04/2012</i>.</small>")

gimp_tk_depth_obtain :
 -if {$!<=1} -return -endif
 -l
 -to_rgb size1={w} size2={h} -resize2dx 400,2
 -if {$1==1} -rv -endif
 -if {$3!=100}
 -gimp_frame_round 10,{100-$3},$4,0,255,255,255,255,0,0.1,3
 -endif
 -displacement[0] [1],$2
 -rm[1]
 -channels 0
 -n 0,255
 -r $size1,$size2 -endl

#*******END OF FILTER*****************

#*************************************
#De-Anaglyph
#*************************************

#@gimp De-Anaglyph : gimp_tk_deana, gimp_tk_deana(1)
#@gimp : sep = separator()
#@gimp : note = note("This filter reconstructs strereoscopic full colour views from anaglyphs")
#@gimp : sep = separator()
#@gimp : Colour smoothing = float(20,0,100)
#@gimp : Gamma equalizer = float(2,0.1,10)
#@gimp : sep = separator(), note = note("<small>Author: <i>Tom Keil</i>     Latest update: <i>09/20/2012</i>.</small>")

gimp_tk_deana :
 -repeat $! -l[$>] -to_rgb --s c -rm[-1]
 -to_rgb[-1,-2] -rgb2lab[-1,-2] -channels[-1,-2] 0
 -rgb2lab[0] -s[0] c -blur_x[1,2] $1
 -c[-1,-2] {0,im},{0,iM}
 -apply_gamma[-1] {($2^({0,ia}/ia)-$2)*$2+1}
 -apply_gamma[-2] {($2^({0,ia}/{-2,ia})-$2)*$2+1}
 [1,2] -rm[0] -mv[2] 0
 -a[0,1,2] c -a[1,2,3] c -lab2rgb[0,1]
 -endl -done

#************END OF FILTER************



#*******END OF DIRECTORY**************
#@gimp _


#@gimp _<b>Artistic</b>

#****************************************
# Photoillustration
#****************************************
#@gimp Photoillustration: gimp_tk_photoillustration,  gimp_tk_photoillustration_preview(0)
#@gimp : note = note("adding an illustrative effect to any photograph")
#@gimp : sep = separator()
#@gimp : Local contrast style = choice("tone mapping","tone mapping soft","tone mapping fast","local  normalisation","unsharp mask","global mapping","dynamic range increase","none")
#@gimp : Local contrast effect = float(0.25,0.00,2.5)
#@gimp : Smoothing style = choice("anisotropic","bilateral","color channel  smoothing","segmentation","morphological closing","selective gaussian","wavelet","Kuwahara","none")
#@gimp : Contour precision = float(0.30,0.00,1.00)
#@gimp : Area smoothness = float(0.50,0.00,10.00)
#@gimp : Sharpening radius = float(0.50,0.00,10.00)
#@gimp : Sharpening strength = float(1.00,0.00,5.00)
#@gimp : Special effects = choice("none","soft glow","dusty","Orton glow","extra  smooth","bloom","paintstroke")
#@gimp : Effect strength = float(5.00,0.00,20.00)
#@gimp : Overall lightness = float(0,-50,50)
#@gimp : Overall contrast = float(1,0.5,1.5)
#@gimp : Shadows lightness = float(0,-100,100)
#@gimp : Highlights lightness = float(0,-100,100)
#@gimp : Mid tone contrast = float(1,0.5,4)
#@gimp : Color green-magenta = float(0,-20,20)
#@gimp : Color blue-yellow = float(0,-20,20)
#@gimp : Color boost = float(1.2,0,4)
#@gimp : Detail reconstruction detection = float (98.5,50,100)
#@gimp : Detail reconstruction smoothness = float(5,0,10)
#@gimp : Detail reconstruction strength = float(0.5,0,1)
#@gimp : Detail reconstruction style = choice("micro/macro details  adjusted","fine","strong","high pass","artistic round","artistic hard","artistic  modern","comic Style","gritty","none")
#@gimp : Keep detail layer seperate = bool(0)
#@gimp : Remove artifacts from micro/macro detail = bool(0)
#@gimp : Skin tone protection = bool(0)
#@gimp : Sharpen edges only = bool(0)
#@gimp : Computation mode = choice(1,"high quality","normal","high speed")
#@gimp : sep = separator(), Preview type = choice("Full","Forward  horizontal","Forward vertical","Backward horizontal","Backward vertical")
#@gimp : sep = separator(), note = note("<small>Author: <i>Tom Keil</i>        Latest update: <i>28/08/2012</i>.</small>")
###@gimp : note = link("Filter explained  here","http://www.tkfilter.bplaced.net/TKFilter%20tutorials%20Photoillustration.html")
gimp_tk_photoillustration :
  -repeat $! -l[$>]
  -if {$26==1} scdo=50 scup=200 -endif
  -if {$26==2} scdo=25 scup=400 -endif
  -if {$26!=0} -r $scdo%,$scdo% -else -endif
  -if {$21==0} [^] --negate[1]  [0] --negate[0]
  -gimp_gaussian_blur[2] {{{100-$18}/5}+0.5},0,0,1,0,0,0  -gimp_compose_dodge[1,2] 1
  -if {$23==1} -gimp_gaussian_blur[1] {{{100-$18}/10}+0.5},0,0,1,0,0,0 -endif
  -gimp_gaussian_blur[3] {{{{{100-$18}/5}+1}*10}+10},0,0,1,0,0,0
  -gimp_compose_dodge[2,3] 1
  -if {$23==1} -gimp_gaussian_blur[2] {{{{100-$18}/10}+0.5}*3},0,0,1,0,0,0 -endif
  -reverse[1,2] -gimp_compose_multiply[1,2] {1-{$19/10}}
  -tk_gimp_channel_processing[1] {{1-$20}+0.1},1,0,0,0,0,100,256,0,0,0,2,7,0
  -elif {$21==1} --gimp_laplacian $19,{99.99-$18},$18,1,1,0
  -elif {$21==2} --gimp_gradient_norm $19,0.5,{99.99-$18},$18,1,0
  -elif {$21==3} --gimp_highpass {-{$18-100.3}},{{10-$19}*0.7},0,1,0
  -elif {$21==4} --gimp_pencilbw {100-$18},{$19*20},0,0,0
  -elif {$21==5}
  --gimp_hardsketchbw {300+{{$18-50}*15}},{$19*10},$19,1,{50-{$18/2}},0,0,0
  -elif {$21==6} --gimp_thin_edges $19,{{$18/5}-10},0,0
  -elif {$21==7} --gimp_edges {$19/3.5},{95-$18},0,0
  --gimp_mix_hsv[0] 1,0,0,1,-1,0,1,0,0,0,2,0
  -tk_gimp_channel_processing[2] 1,1,0,{$19/10},4,{{$18-50}*2},100,256,0,0,0,2,7,0
  -reverse[1,2] -gimp_compose_multiply[1,2] {0.5+{$20/2}}
  -elif {$21==8} --channels 2
  -if {$19<=5}   -gimp_unsharp[1]  1,{2-{{$19*0.3}+0.5}},20,{5-$19},0.00,1.00,0.5,1,0,7,0
  -else -gimp_gaussian_blur[1] {$19-5},0,0,1,0,0,0  -endif
  -endif
  -if {$1!=3}
  -tk_gimp_channel_processing[0] 1,1,$12,0,0,0,100,256,0,0,1,{abs($12/10)},7,0
  -tk_gimp_channel_processing[0] 1,1,$13,0,0,0,100,256,0,0,3,{abs($12/10)},7,0      -endif
  -if {$24==0}
  -if {$1==0} -gimp_map_tones[0] {$2/2.5},{1-{$2/2.5}},$2,{2+{$2*80}},3,0
  -elif {$1==1} -gimp_map_tones[0] {$2/10},0.5,{10-{$2*2}},300,3,0
  -elif {$1==2} -gimp_map_tones_fast[0] {$2*2},{$2/2.5},3,0
  -elif {$1==3}
  -gimp_normalize_local[0] {$2*2},{1+{$2*25.2}},{$2*16},{$2*16},0,3,0
  -elif {$1==4} -gimp_unsharp[0] 0,{{w+h}/100},0,$2,0,1,1,1,0,7,0
  -elif {$1==5} --negate[0]
  -if {$21!=9} -reverse[1,2] -endif
  -gimp_gaussian_blur[1] {{{w+h}/5}-{$2*{{w+h}/12.5}}},0,0,1,0,0,0
  -to_gray[1] -reverse[0,1] -gimp_compose_softlight[0,1] {$2/2.5}
  -elif {$1==6} -gimp_tk_dri[0] {$2/2.5},{$2/5},{$2/2.5},{$2*2},{$2/2.5},1,1,0
  -endif
  -else
  --to_rgba[0] --channels[0] 0 -if {$21!=9} -move[1] 4 -endif
  -negate[2]
  -tk_gimp_channel_processing[2] 1,1,2,0,0,0,100,256,0,0,0,2,7,0
  -gimp_gaussian_blur[2] {{w+h}/500},0,0,1,0,0,0
  -to_gray[2]
  -if {$1==0} -gimp_map_tones[1] {$2/2.5},{1-{$2/2.5}},$2,{2+{$2*80}},3,0
  -elif {$1==1} -gimp_map_tones[1] {$2/10},0.5,{10-{$2*2}},300,3,0
  -elif {$1==2} -gimp_map_tones_fast[1] {$2*2},{$2/2.5},3,0
  -elif {$1==3}   -gimp_normalize_local[1]  {$2*2},{1+{$2*25.2}},{$2*16},{$2*16},0,3,0
  -elif {$1==4} -gimp_unsharp[1] 0,100,0,$2,0,1,1,1,0,7,0
  -elif {$1==5} -negate[1] -gimp_gaussian_blur[1]  {{{w+h}/5}-{$2*{{w+h}/12.5}}},0,0,1,0,0,0
  -to_gray[1] -to_rgba[1]
  -elif {$1==6} -gimp_tk_dri[1] {$2/2.5},{$2/5},{$2/2.5},{$2*2},{$2/2.5},1,1,0    -to_rgba[1]
  -endif
  -split[1] c
  -if {$21!=9} -reverse[4,5] -compose_multiply[4,5] -append[-5,-4,-3,-2] c
  -else -reverse[3,4] -compose_multiply[3,4] -append[-4,-3,-2,-1] c -endif
  -if {$1!=3} -compose_rgba[0,1] -else -reverse[0,1]
  -gimp_compose_softlight[0,1] {$2/2.5} -endif
  -endif

  -tk_gimp_channel_processing[0] 1,$11,$10,0,0,0,100,256,0,0,0,2,7,0
  -tk_gimp_channel_processing[0] 1,$14,0,0,0,0,100,256,0,0,2,{abs($14*2.5)},7,0
  -if {$1==3}
  -tk_gimp_channel_processing[0] 1,1,$12,0,0,0,100,256,0,0,1,{abs($12/10)},7,0
  -tk_gimp_channel_processing[0] 1,1,$13,0,0,0,100,256,0,0,3,{abs($12/10)},7,0
  -endif
  -if {$3==0} -gimp_anisotropic_smoothing[0]  {$5*100},{$4*2},$4,$5,$5,0.80,30.00,2.0,0,1,1,0,1,0
  -elif {$3==1} -gimp_bilateral[0] {100-{$4*100}},{$5*25},1,0,0
  -elif {$3==2} -gimp_gaussian_blur[0] {$5*10},0,0,1,8,0,0
  -elif {$3==3} -gimp_segment_watershed[0] {$4*5},{$5/2},0,0
  -elif {$3==4} -gimp_morpho[0] 3,{$5*2+2},0,2,0,1,0
  -elif {$3==5} -gimp_selective_smoothing[0] {$5*4},{$4*2},10,10,0,1,0
  -elif {$3==6} -gimp_haar_smoothing[0] {10-{$4*10}},{round($5*5,1)},0,0,1,0
  -elif {$3==7} -to_rgb[0] -gimp_kuwahara[0] {6-{$4*5}},{1+{$5*2.9}},0,0
  -endif

  -gimp_mix_lab[0] 1,0,0,$17,$15,0,$17,$16,0,0,2,0
  -if {$25==0}
  -gimp_unsharp[0] 1,$6,20,$7,0.00,1.00,0.5,1,0,7,0
  -else
  --to_rgba[0] --gimp_edges[0] $6,{30-{$7*5}},1,0 -if {$21!=9} -move[1] 4 -endif
  -gimp_unsharp[1] 1,$6,20,$7,0.00,1.00,0.5,1,0,7,0
  -gimp_gaussian_blur[2] {{w+h}/500},0,0,1,0,0,0
  -to_gray[2]
  -split[1] c
  -if {$21!=9} -reverse[4,5] -compose_multiply[4,5] -append[-5,-4,-3,-2] c
  -else -reverse[3,4] -compose_multiply[3,4] -append[-4,-3,-2,-1] c -endif
  -compose_rgba[0,1]
  -endif

  -if {$22==0}
  -if {$21==3}  -reverse -gimp_compose_overlay $20
  -elif {$21==8} -reverse -gimp_compose_hardlight $20
  -elif {$21!=9} -reverse -gimp_compose_multiply $20
  -endif -endif

  -if {$8==1}
  -gimp_glow[0] $9,0,0
  -elif {$8==2} --gimp_highpass[0] {$9*3},2,1,0,0
  -if {{$22==1}&&{$21!=9}} -reverse[1,2] -endif
  -reverse[0,1] -gimp_compose_overlay[0,1] {$9/40}
  -elif {$8==3} [0] [0]
  -if {{$22==1}&&{$21!=9}} -reverse[1,3] -endif
  -gimp_compose_screen[1,2] 1  -gimp_gaussian_blur[1] {$9*3},0,0,1,0,0,0
  -reverse[0,1] -gimp_compose_softlight[0,1] {$9/20}
  -elif {$8==4}
  -gimp_anisotropic_smoothing[0] 0,1.5,0.3,{$9/4},1.10,0.80,30.00,2.0,0,1,1,0,1,0
  -elif {$8==5}
  --gimp_mix_hsv[0] 1,0,0,1,-1,0,1,0,0,0,2,0
  -if {{$22==1}&&{$21!=9}} -reverse[1,2] -endif
  -tk_gimp_channel_processing[1] 1,1,0,0,4,0,{100-{$9*2.5}},256,0,1,0,2,0,0
  -gimp_gaussian_blur[1] $9,0,0,1,0,0,0
  -tk_gimp_channel_processing[1] 1,1,0,0,4,0,{50-{$9*2}},256,0,1,0,2,0,0
  -tk_gimp_replace_color[1] 1,0,0,0,0,255,0,0,0,0
  -gimp_gaussian_blur[1] {$9*2},0,0,1,0,0,0
  -reverse[0,1] -gimp_compose_softlight[0,1] {0.25+{$9/150}}
  -elif {$8==6}
  -gimp_anisotropic_smoothing[0]  60,0.16,{{$9/50}+0.6},{{$9/9}+0.6},2.35,0.8,30,2,0,1,1,0,1

  -endif

  -if {$26!=0} -r $scup%,$scup% -endif

  -endl -done

gimp_tk_photoillustration_preview :
  -gimp_split_preview "-gimp_tk_photoillustration ${1--2}",$-1

#*****END OF FILTER**********************


#****************************************
# watercolor
#****************************************

#@gimp Watercolor : gimp_watercolor, gimp_watercolor_preview(1)
#@gimp : sep = separator(), note = note("General settings:")
#@gimp : Color intensity = float(1.8,0,4)
#@gimp : Light colors = float(0.1,0,1)
#@gimp : Dark colors = float(1,0,10)
#@gimp : sep = separator(), note = note("Line art settings:")
#@gimp : Line art details = float (80,50,100)
#@gimp : Line art smoothness = float(0,0,10)
#@gimp : Line art strength = float(0.5,0,1)
#@gimp : Line art style = choice("pencil","ink","comic style")
#@gimp : Line art fade = float(0,0,100)
#@gimp : sep = separator(), note = note("Color brushes settings:")
#@gimp : Brush style = choice("modern","classic","abstract","line","smooth")
#@gimp : Cyan brush size = float(2,0,50)
#@gimp : Cyan stroke strength = float(0,-5,5)
#@gimp : Cyan edge distance = float(2,0,10)
#@gimp : Cyan abstraction = float(4,0,10)
#@gimp : Magenta brush size = float(2,0,50)
#@gimp : Magenta stroke strength = float(0,-5,5)
#@gimp : Magenta edge distance = float(3,0,10)
#@gimp : Magenta abstraction = float(3,0,10)
#@gimp : Yellow brush size = float(2,0,50)
#@gimp : Yellow stroke strength = float(0,-5,5)
#@gimp : Yellow edge distance = float(4,0,10)
#@gimp : Yellow abstraction = float(2,0,10)
#@gimp : sep = separator(), note = note("Paper and ambience settings:")
#@gimp : Paper color black = bool(0)
#@gimp : Add paper texture = bool(0)
#@gimp : Invert colors = bool(0)
#@gimp : Ambient light = float(0,-50,50)
#@gimp : sep = separator(), Preview type = choice("Full","Forward horizontal","Forward vertical","Backward horizontal","Backward vertical","Duplicate top","Duplicate left","Duplicate bottom","Duplicate right")
#@gimp : sep = separator(), note = note("<small>Authors : <i>Tom Keil and Arto Huotari </i>       Latest update: <i>02/19/2011</i>.</small>")
#@gimp : note = link("Tutorial download","http://www.slideshare.net/ArtoHuotari/gmig-water-color-filter-tutorial")
#@gimp : note = link("Video demonstration here","http://vimeo.com/19713850")
gimp_watercolor :
  -repeat $! -l[$>] -split_opacity -l[0]
  #secure details:
  -if {$7==0} --gimp_gradient_norm $5,0.5,{99.99-$4},$4,1,0
  -elif {$7==1} --gimp_edges {$5/3.5},{95-$4},0,0
  -elif {$7==2} --gimp_edges {$5/3.5},{95-$4},0,0
  --gimp_mix_hsv[0] 1,0,0,1,-1,0,1,0,0,0,2,0
  -tk_gimp_channel_processing[2] 1,1,0,{$5/10},4,{{$4-50}*2},100,256,0,0,0,2,7,0
  -reverse[1,2] -gimp_compose_multiply[1,2] {0.5+{$6/2}}
  -endif -gimp_frame_round[1] 5,$8,15,0,255,255,255,255,0,0.1,3

  #image preparation:
  -gimp_anisotropic_smoothing[0]
  60,0.16,{{20/50}+0.6},{{20/9}+0.6},2.35,0.8,30,2,0,1,1,0,1
  [0] --negate[0] -move[1] 4
  -gimp_gaussian_blur[2] {{w+h}/100},0,0,1,0,0,0
  -gimp_compose_dodge[1,2] 1
  -gimp_mix_lab[0] 1,0,0,$1,0,0,$1,0,0,0,2,0
  -reverse[0,1]
  -gimp_compose_colorburn[0,1] $2

  --luminance[0] -reverse[1,2]
  -tk_gimp_channel_processing[1] 1,1,0,0,4,{$3*5},100,256,0,0,0,2,0,0
  -gimp_gaussian_blur[1] $3,0,0,1,0,0,0
  -tk_gimp_channel_processing[1] 1,1,0,0,4,0,99,256,0,1,0,2,0,0
  -tk_gimp_replace_color[1] 1,0,255,255,255,255,0,0,0,0
  -gimp_spread[1] {$3*2},{$3*2},0,0
  -gimp_gaussian_blur[1] {{w+h}/1000},0,0,1,0,0,0
  -reverse[0,1] -gimp_compose_multiply[0,1] 1

  #channel and mask creation:
  -split[0] c
  -if {$9==0} --negate[0] --negate[1] --negate[2]
  -elif {$9==1} --fill_color[0] 255,255,255 --fill_color[0] 255,255,255
  --fill_color[0] 255,255,255
  -elif {$9==2} --fill_color[0] 255,255,255 --fill_color[0] 255,255,255
  --fill_color[0] 255,255,255
  -elif {$9==3} --gimp_edges[0] {$10/5},{$13*5},1,0
  --gimp_edges[1] {$14/5},{$17*5},1,0 --gimp_edges[2] {$18/5},{$21*5},1,0
  -elif {$9==4} --negate[0] --negate[1] --negate[2] -endif

  #channel and mask processing:
  -tk_gimp_channel_processing[0] 1,{{$11/5}+1},{$11/50},0,0,0,100,256,0,0,0,2,0,0
  -if {$9!=2}
  -gimp_gaussian_blur[0] $10,0,0,1,0,0,0
  -else -cubism[0] 300,{$13*5},{$13*36},1,{$10/50} -endif
  -if {$9==0}
  -tk_gimp_channel_processing[-3] 1,{{$11/5}+1},{$11/50},0,0,0,100,256,0,0,0,2,0,0
  -cubism[-3] 300,{$13*5},{$13*36},1,{$10/50} -endif
  -if {$9==4}
  -tk_gimp_channel_processing[-3] 1,{{$11/5}+1},{$11/50},0,0,0,100,256,0,0,0,2,0,0
  -gimp_painting[-3] $13,1.5,2 -endif
  -gimp_frame_fuzzy[-3] {$12*5},{$12*5},{$13*20},{$10/2},0,0,0,255

  -tk_gimp_channel_processing[1] 1,{{$15/5}+1},{$15/50},0,0,0,100,256,0,0,0,2,0,0
  -if {$9!=2}
  -gimp_gaussian_blur[1] $14,0,0,1,0,0,0
  -else -cubism[1] 300,{$17*5},{$17*36},1,{$14/50} -endif
  -if {$9==0}
  -tk_gimp_channel_processing[-2] 1,{{$15/5}+1},{$15/50},0,0,0,100,256,0,0,0,2,0,0
  -cubism[-2] 300,{$17*5},{$17*36},1,{$14/50} -endif
  -if {$9==4}
  -tk_gimp_channel_processing[-2] 1,{{$15/5}+1},{$15/50},0,0,0,100,256,0,0,0,2,0,0
  -gimp_painting[-2] $17,1.5,2 -endif
  -gimp_frame_fuzzy[-2] {$16*5},{$16*5},{$17*20},{$14/2},0,0,0,255

  -tk_gimp_channel_processing[2] 1,{{$19/5}+1},{$19/50},0,0,0,100,256,0,0,0,2,0,0
  -if {$9!=2}
  -gimp_gaussian_blur[2] $18,0,0,1,0,0,0
  -else -cubism[2] 300,{$21*5},{$21*36},1,{$18/50} -endif
  -if {$9==0}
  -tk_gimp_channel_processing[-1] 1,{{$19/5}+1},{$19/50},0,0,0,100,256,0,0,0,2,0,0
  -cubism[-1] 300,{$21*5},{$21*36},1,{$18/50} -endif
  -if {$9==4}
  -tk_gimp_channel_processing[-1] 1,{{$19/5}+1},{$19/50},0,0,0,100,256,0,0,0,2,0,0
  -gimp_painting[-1] $21,1.5,2  -endif
  -gimp_frame_fuzzy[-1] {$20*5},{$20*5},{$21*20},{$18/2},0,0,0,255
  -to_gray[-1] -to_gray[-2] -to_gray[-3] -to_rgba[0] -to_rgba[1] -to_rgba[2]

  #recombine image:
  -split[0] c -reverse[3,-3] -compose_multiply[3,-3] -append[0,1,2,3] c
  -split[1] c -reverse[4,-2] -compose_multiply[4,-2] -append[1,2,3,4] c
  -split[2] c -reverse[5,-1] -compose_multiply[5,-1] -append[2,3,4,5] c
  -if {$22==0} --fill_color[0] 255,255,255 -else --fill_color[0] 0 -endif
  -reverse[0,-1]  -compose_rgba[0,-1]
  -if {$22==0} --fill_color[1] 255,255,255 -else --fill_color[1] 0 -endif
  -reverse[1,-1] -compose_rgba[1,-1]
  -if {$22==0} --fill_color[2] 255,255,255 -else --fill_color[2] 0 -endif
  -reverse[2,-1] -compose_rgba[2,-1]
  -to_gray[0] -to_gray[1] -to_gray[2] -append[0,1,2] c
  -if {$23==1} -gimp_paper 0,0 -endif
  -if {$24==1} -negate[0] -endif
  -gimp_mix_lab 1,$25,0,1,0,0,1,0,0,0,2,0
  -reverse[0,1] -gimp_compose_multiply[0,1] $6
  -endl -a c -endl -done

gimp_watercolor_preview :
  -gimp_split_preview "-gimp_watercolor ${1--2}",$-1

#*****END OF FILTER**********************

#*******END OF DIRECTORY*****************
#@gimp _

#@gimp _<b>Sequences</b>

#****************************************
# Object animation
#****************************************

#@gimp Object animation : gimp_tk_animateobject, gimp_tk_animateobject_preview(1)
#@gimp : sep = separator()
#@gimp : note = note("Object motion:")
#@gimp : X-motion = float(0,-100,100)
#@gimp : Y-motion = float(0,-100,100)
#@gimp : Z-motion = float(0,-10,50)
#@gimp : sep = separator()
#@gimp : note = note("Camera position:")
#@gimp : Camera X = float(0.5,0,1)
#@gimp : Camera Y = float(0.5,0,1)
#@gimp : sep = separator()
#@gimp : note = note("Frame settings:")
#@gimp : Frame size = int(400,50,1920)
#@gimp : Frames = int(2,2,100)
#@gimp : Reverse motion = bool(0)
#@gimp : note = note("<small>Your mask must be placed below your image. Switch input layers to <i><b>Active and below</b></i>.</small>")
#@gimp : sep = separator()
#@gimp : Work on frameset = bool(0)
#@gimp : note = note("<small>To use this option your mask must be placed below your frames. Switch input layers to <i><b>All</b></i>.</small>")
#@gimp : sep = separator()
#@gimp : note = note("Advanced settings:")
#@gimp : Sharpen object = float(0,0,10)
#@gimp : Expand background reconstruction = float(0,0,50)
#@gimp : Smoothen background reconstruction = float(0,0,1)
#@gimp : Adjust background reonstruction = float(1,1,256)
#@gimp : sep = separator()
#@gimp : Blue screen mode = bool(0)
#@gimp : note = note("<small>Layer stack for images: Object image top, background image below, mask bottom. Layer stack for framesets: Frameset top, object image below, mask bottom. Switch input layers to <i><b>All</b></i>.</small>")
#@gimp : sep = separator()
#@gimp : Camera motion only = bool(0)
#@gimp : Closeup = float(1,1,10)
#@gimp : note = note("<small>Use this option without mask layer. Switch input layers to <i><b>Active</b></i> or <i><b>All</b></i></small>")
#@gimp : sep = separator(), note = note("<small>Author : <i>Tom Keil</i>.      Latest update: <i>04/08/2012</i>.</small>")
##@gimp : note = link("Filter explained here",http://www.tkfilter.bplaced.net/TKFilter%20tutorials%20animated%20objects.html)

gimp_tk_animateobject :

#resize and reconstruct single image background

 -if {$!<=1} -return -endif
 -if {$15==0}

 -to_rgb -if {$9==0}
 -r {w*{$6/max(w,h)}},{h*{$6/max(w,h)}},1,{s},6 -c 0,255
 -if {$14==0}
 [-1,-2] [0] -rv[0,1]
 -blur_xy[0] $11 -ir[0] $13,256 -n[0] 0,255
 -tk_gimp_replace_color[0] 1,0,0,0,0,255,0,0,0,0
 -blur_xy[0] $12 -inpaint[1] [0]
 -rm[0] -rv[-1,-2]
 -else [0] -rv[0,1] -rv[-1,-2]
 [0] [0]
 [-3] [-1]
 -to_gray[-1,-2] -ir[-1,-2] 128,256 -n[-1,-2] 0,255
 -s[1] c -a[1,2,3,-1] c
 -s[2] c -a[2,3,4,-1] c
 -rv[1,-1] -compose_rgba[1,-1]
 -rv[2,-1] -compose_rgba[2,-1]
 -to_rgb[1,2]
 -endif

#construct object views

  dx={$1/$7} dy={$2/$7} dz=1 -repeat $7
 -shift[-1,-2] $dx%,$dy%
 -if {$3>=0} dz={$dz+{{$3}/$7}}
 -else dz={$dz-{{{1-{10.01+$3}/10}}/$7}} -endif
 --gimp_zoom[-1,-2] $dz,$4,$5,0
 -to_gray[-1] -ir[-1] 128,256 -n[-1] 0,255 -to_rgb[-2]
 -s[-2] c -a[-4,-3,-2,-1] c
 -if {$10!=0} -unsharp[-1] {$10/5},{$10/2},0 -cut[-1] 0,255  -endif
 -mv[-1] -3 -done -rm[-1,-2] -rv -rv[-1,-2]

#combine object views with background

 index={-3} -repeat $7
 [-2] -rv[-1,-2] index={$index-1}
 -rv[-3,$index] -compose_rgba[-3,$index]
 -done -rm[-2] -if {$8==1} -rv -endif

 -else

#construct background on frameset

 -if {$14==0} frames={$!-1} counter={-5}
 [-1,-2]
 --blur_xy[-1] $11 -ir[-1] $13,256 -n[-1] 0,255
 -tk_gimp_replace_color[-1] 1,0,0,0,0,255,0,0,0,0
 -blur_xy[-1] $12
 -repeat $frames -inpaint[$counter] [-1]
 counter={$counter-1} -done -rm[-1,-4]

#create and combine object views on frameset

 [-1,-2]
 -else frames={$!-2} --to_gray[-1]
 -s[-3] c -a[-5,-4,-3,-1] c
 --to_gray[-1] --fc[-1] 0,0,0
 -rv[-1,-4] -compose_rgba[-1,-4] -mv[-1] -3
 -endif

 counter={-6} dx=0 dy=0 dz=1 -repeat {$frames}
 [-1,-2]
 -shift[-1,-2] $dx%,$dy%
 -if {$3>=0} dz={$dz+{{$3}/$frames}}
 -else dz={$dz-{{{1-{10.01+$3}/10}}/$frames}} -endif
 --gimp_zoom[-1,-2] $dz,$4,$5,0
 -to_gray[-1] -ir[-1] 128,256 -n[-1] 0,255 -to_rgb[-2]
 -s[-2] c -a[-4,-3,-2,-1] c
 -if {$10!=0} -unsharp[-1] {$10/5},{$10/2},0 -cut[-1] 0,255 -endif
 -mv[-1] $counter
 -compose_rgba[$counter,{$counter-1}]
 dx={$dx+{$1/$frames}} dy={$dy+{$2/$frames}}
 counter={$counter-1}
 -rm[-1,-2]
 -done  -rm[-1,-2,-3,0]

 -endif

 #camera motion only

 -else

 -to_rgb -if {$9==0}
 -r {w*{$6/max(w,h)}},{h*{$6/max(w,h)}},1,{s},6 -c 0,255 -endif

 dx=0 dy=0 dz=1 -if {$9==0} counter=$7 -else counter={$!-1} -endif
 index={-2} -repeat $counter
 -if {$9==0} [-1] -mv[-1] $index -endif
 dx={$dx+{$1/$7}} dy={$dy+{$2/$7}}
 -shift[$index] $dx%,$dy%
 -if {$3>=0} dz={$dz+{{$3}/$7}}
 -else dz={$dz-{{{1-{10.01+$3}/10}}/$7}} -endif
 -gimp_zoom[$index] $16,$4,$5,0
 -gimp_zoom[$index] $dz,$4,$5,0
 -if {$10!=0} -unsharp[$index] {$10/5},{$10/2},0 -cut[$index] 0,255 -endif
 index={$index-1} -done
 -if {$16!=1} -rm[-1] -endif -endif

 #preview function

gimp_tk_animateobject_preview:

 -if {$15==0} start_x={{xM/w}*100} start_y={{yM/h}*100} -else start_x=50 start_y=50 -endif
 -gimp_tk_animateobject ${1-6},1,${8--1} -k[0]
 -line[0] {$1+$start_x}%,{$2+$start_y-10}%,{$1+$start_x}%,{$2+$start_y+10}%,1,255,0,0
 -line[0] {$1+$start_x-10}%,{$2+$start_y}%,{$1+$start_x+10}%,{$2+$start_y}%,1,255,0,0
 -line[0] {$4*100}%,0%,{$4*100}%,{{$5*100}-5}%,1,255,255,0
 -line[0] {$4*100}%,{{$5*100}+5}%,{$4*100}%,100%,1,255,255,0
 -line[0] 0%,{$5*100}%,{{$4*100}-5}%,{$5*100}%,1,255,255,0
 -line[0] {{$4*100}+5}%,{$5*100}%,100%,{$5*100}%,1,255,255,0

#*****END OF FILTER**********************

#*******END OF DIRECTORY*****************
#@gimp _


#@gimp _<b>Colors</b>

#****************************************
# Vintage style
#****************************************

#@gimp Vintage style : gimp_tk_vintage, gimp_tk_vintage_preview(1)
#@gimp : Exposure = float(2,-5,5)
#@gimp : Contrast = float(0.85,0.5,1.5)
#@gimp : Saturation = float(0.7,0,4)
#@gimp : Shadows threshold = float(80,0,128)
#@gimp : Highlights threshold = float(200,128,255)
#@gimp : Transition smoothness = float(5,0,50)
#@gimp : sep = separator()
#@gimp : Color shadows = color(147,26,161)
#@gimp : Strength shadows = float(0.3,0,1)
#@gimp : Color midtones = color(235,220,176)
#@gimp : Strength midtones = float(0.4,0,1)
#@gimp : Color highlights = color(190,181,108)
#@gimp : Strength highlights = float(0.2,0,1)
#@gimp : Color overall effect = color(0,0,100)
#@gimp : Color effect mode = choice("exclusion","overlay","soft  Light","multiply","screen")
#@gimp : Strength effect = float(0.3,0,1)
#@gimp : sep = separator()
#@gimp : Vignette size = float(25,0,100)
#@gimp : Vignette strenth = float(0,0,1)
#@gimp : sep = separator(), Preview type = choice("Full","Forward  horizontal","Forward vertical","Backward horizontal","Backward vertical")
#@gimp : sep = separator(), note = note("<small>Author : <i>Tom Keil</i>.       Latest update: <i>06/04/2011</i>.</small>")
##@gimp : note = link("Filter explained  here",http://www.tkfilter.bplaced.net/TKFilter%20filter.html)

gimp_tk_vintage :
 -repeat $! -l[$>]
 -to_rgb[0] --luminance[0] --luminance[0] --luminance[0]
 -gimp_mix_lab[0] $2,{$1*10},0,$3,0,0,$3,0,0,0,2,0


 -tk_gimp_channel_processing[-1] 1,1,0,0,4,{$4/2.55},100,256,0,1,0,2,0,0
 -tk_gimp_channel_processing[-2] 1,1,0,0,4,{$4/2.55},{$5/2.55},256,0,0,0,2,0,0
 -tk_gimp_channel_processing[-3] 1,1,0,0,4,0,{$5/2.55},256,0,1,0,2,0,0
 -to_gray[-1,-2,-3] -gimp_gaussian_blur[-1,-2,-3] $6,0,0,1,0,0,0

 --fc[0] $7,$8,$9 --fc[0] $11,$12,$13 --fc[0] $15,$16,$17 -to_rgba[-1,-2,-3]
 -s[-1] c -rv[-1,-9] -compose_multiply[-1,-9] -mv[-8] 9 -a[-4,-3,-2,-1] c
 -s[-2] c -rv[-2,-8] -compose_multiply[-2,-8] -mv[-7] 7 -a[-5,-4,-3,-2] c
 -s[-3] c -rv[-3,-7] -compose_multiply[-3,-7] -mv[-6] 5 -a[-6,-5,-4,-3] c


 --fc[0] $19,$20,$21 -rv[-1,-5]
 -if {$22==0} -gimp_compose_exclusion[-1,-5] $23
 -elif {$22==1} -gimp_compose_overlay[-1,-5] $23
 -elif {$22==2} -gimp_compose_softlight[-1,-5] $23
 -elif {$22==3} -gimp_compose_multiply[-1,-5] $23
 -elif {$22==4} -gimp_compose_screen[-1,-5] $23
 -endif

 -rv[-3,-4] -gimp_compose_lighten[-3,-4] $10
 -rv[-2,-3] -gimp_compose_overlay[-2,-3] $14
 -rv[-1,-2] -gimp_compose_darken[-1,-2] $18

 -if {$25!=0}
 --fc[0] 255,255,255 -gimp_frame_round[-1] 2,$24,0,0,0,0,0,255,100,0.1,3
 -gimp_gaussian_blur[-1] {$6*5},0,0,1,0,0,0
 -rv[-1,-2] -gimp_compose_multiply[-1,-2] $25 -endif
 -endl -done

gimp_tk_vintage_preview :
 -gimp_split_preview "-gimp_tk_vintage ${1--2}",$-1

#*******END OF FILTER********************

#****************************************
#metallic look Filter
#****************************************

#@gimp Metallic look : gimp_tk_metallic, gimp_tk_metallic_preview(1)
#@gimp : Strength = float(1,0,1)
#@gimp : Smoothness = float(0,0,20)
#@gimp : Metal = choice("Silver","Gold","Copper","Bronze","Blue steel")
#@gimp : sep = separator(), Preview type = choice("Full","Forward horizontal","Forward vertical","Backward horizontal","Backward vertical","Duplicate top","Duplicate left","Duplicate bottom","Duplicate right")
#@gimp : sep = separator(), note = note("<small>Author : <i>Tom Keil</i>.      Latest update: <i>04/12/2011</i>.</small>")
##@gimp : note = link("Filter explained here",http://www.tkfilter.bplaced.net/TKFilter%20filter.html)

gimp_tk_metallic :
 -repeat $! -l[$>]
 -gimp_gaussian_blur $2,0,0,1,1,0,0
 -luminance --luminance
 -gimp_apply_curve[1] 0,31,111,64,17,110,176,148,75,177,235,186,1,0,0,0,0
 -gimp_apply_curve[1] 0,31,111,64,17,110,176,148,75,177,235,186,1,0,0,0,0
 -rv[0,1] -gimp_compose_value[0,1] $1,0
 -if {$3==1} -gimp_mix_rgb 1,50,0,1,50,0,1,-50,0,0,2,0
 -elif {$3==2} -gimp_mix_rgb 1,75,0,1,5,0,1,-25,0,0,2,0
 -elif {$3==3} -gimp_mix_rgb 1,70,0,1,40,0,1,-20,0,0,2,0
 -elif {$3==4} -gimp_mix_rgb 1,-5,0,1,0,0,1.1,12,0,0,2,0
 -endif -endl -done

gimp_tk_metallic_preview :
 -gimp_split_preview "-gimp_tk_metallic ${1--2}",$-1

#*****END OF FILTER**********************

#****************************************
#Zone system
#****************************************

#@gimp Zone system : gimp_zonesystem, gimp_zonesystem_preview(1)
#@gimp : Shadows zone = int(1,1,5)
#@gimp : Highlights zone = int(10,6,10)
#@gimp : Gamma = float(1,0,5)
#@gimp : Contrast = float(1,0,4)
#@gimp : Black point = int(0,0,255)
#@gimp : White point = int(255,0,255)
#@gimp : sep = separator(), Preview type = choice("Full","Forward horizontal","Forward vertical","Backward horizontal","Backward vertical","Duplicate top","Duplicate left","Duplicate bottom","Duplicate right")
#@gimp : sep = separator(), note = note("<small>Author : <i>Tom Keil</i>.      Latest update: <i>02/13/2011</i>.</small>")
gimp_zonesystem :
  -repeat $! -l[$>] -to_rgb -rgb2lab -s c -n[0] {{$1-1}*10}%,{$2*10}%
  -a c -lab2rgb -tk_gimp_channel_processing $3,$4,0,0,0,0,100,256,0,0,0,2,7,0
  -gimp_apply_curve 0,$5,0,$6,255,-1,128,-1,128,-1,128,255,1,7,0,0,0
  -endl -done

gimp_zonesystem_preview :
  -gimp_split_preview "-gimp_zonesystem ${1--2}",$-1

#*****END OF FILTER**********************

#****************************************
# Color temperature
#****************************************

#@gimp Color temperature : gimp_tk_colortemp, gimp_tk_colortemp_preview
#@gimp : Color temperature = float(0,-20,20)
#@gimp : Automatic color balance = bool(0)
#@gimp : sep = separator()
#@gimp : Preview type = choice("Full","Forward horizontal","Forward vertical","Backward horizontal","Backward vertical","Duplicate top","Duplicate left","Duplicate bottom","Duplicate right")
#@gimp : sep = separator(), note = note("<small>Author: <i>Tom Keil</i>.      Latest update: <i>05/04/2012</i>.</small>")
gimp_tk_colortemp :

 -repeat $! -l[$>] -if {$2==1} --luminance[-1] -to_rgb[-2]
 -s[-2] c  avb={-2,127.5-ia} avg={-3,127.5-ia} avr={-4,127.5-ia}
 -+[-4] $avr -+[-3] $avg -+[-2] $avb -a[-4,-3,-2] c -rv -compose_luminance -endif
 -gimp_mix_lab 1,0,0,1,{if({$1>=0},{$1/4},{$1*0.75})},0,1,$1,0,0,2,0 -endl -done

gimp_tk_colortemp_preview :

 -gimp_split_preview "-gimp_tk_colortemp ${1--2}",$-1

#*****END OF FILTER**********************

#*******END OF DIRECTORY*****************
#@gimp _


#@gimp _<b>Degradations</b>

#*******END OF DIRECTORY*****************
#@gimp _


#@gimp _<b>Details</b>

#****************************************
#Mask Creator
#****************************************

#@gimp Mask Creator : gimp_tk_mask, gimp_tk_mask_preview(1)
#@gimp : sep = separator()
#@gimp : Mask Type = choice("Luminance","Saturation","Hue","LAB-lightness")
#@gimp : Color Channels = choice("All","Red","Green","Blue","Yellow","Magenta","Cyan","LAB-A","LAB-B")
#@gimp : Shadows threshold = float(0,0,255)
#@gimp : Highlights threshold = float(255,0,255)
#@gimp : Tones Smoothness = float(0,0,20)
#@gimp : Mask Contrast = float(1,0,10)
#@gimp : Negative = bool(0)
#@gimp : Apply Mask = bool(0)
#@gimp : Transparency = float(1,0,1)
#@gimp : sep = separator(), Preview type = choice("Full","Forward horizontal","Forward vertical","Backward horizontal","Backward vertical","Duplicate top","Duplicate left","Duplicate bottom","Duplicate right")
#@gimp : sep = separator(), note = note("<small>Author: <i>Tom Keil</i>.      Latest update: <i>04/11/2011</i>.</small>")
##@gimp : note = link("Filter explained here",http://www.tkfilter.bplaced.net/TKFilter%20filter.html)

gimp_tk_mask :

 -repeat $! -l[$>]
 -if {$8==1} --to_rgba[-1] -rv[-1,-2] -endif -to_rgb[-1]
 -if {$2==1} -channels[-1] 0
 -elif {$2==2} -channels[-1] 1
 -elif {$2==3} -channels[-1] 2
 -elif {$2==4} -rgb2cmy -channels[-1] 2
 -elif {$2==4} -rgb2cmy -channels[-1] 1
 -elif {$2==4} -rgb2cmy -channels[-1] 0
 -elif {$2==5} -rgb2lab -channels[-1] 1
 -elif {$2==6} -rgb2lab -channels[-1] 2
 -endif -to_rgb[-1]

 -if {$1==0} -luminance[-1] --luminance[-1]
 -elif {$1==1} -rgb2hsv[-1] -channels[-1] 1
 -n[-1] 0,255 [-1]
 -elif {$1==2} -rgb2hsv[-1] -channels[-1] 0
 -n[-1] 0,255  [-1]
 -elif {$1==3} -rgb2lab[-1] -channels[-1] 0
 -n[-1] 0,255  [-1]
 -endif

 -c[-1] $3,255 -n[-1] 0,255
 -f[-2] "if(i<$4,if(c==0,i,i),0)"
 -gimp_gaussian_blur[-1,-2] $5,0,0,1,0,0,0
 -compose_darken
 -if {$8==1} -rv[-1,-2] -endif
 -tk_gimp_channel_processing[-1] 1,$6,0,0,0,0,100,256,0,0,0,2,0,0
 -if {$7==1} -negate[-1] -endif
 -if {$8==1} -s[-2] c  -rv[-1,-2]
 -gimp_compose_multiply[-1,-2] $9
 -a[-4,-3,-2,-1] c
 -endif -endl -done

gimp_tk_mask_preview :
 -gimp_split_preview "-gimp_tk_mask ${1--2}",$-1


#*******END OF FILTER********************

#****************************************
#dynamic range increase
#****************************************

#@gimp Dynamic Range Increase : gimp_tk_dri, gimp_tk_dri_preview(1)
#@gimp : sep = separator()
#@gimp : Map Tones = float(0,0,1)
#@gimp : Recover Shadows = float(0,0,1)
#@gimp : Recover Highlights = float(0,0,1)
#@gimp : Enhance Details = float (1,0,5)
#@gimp : Detail Strength = float (0.5,0,1)
#@gimp : Map Tones = bool(1)
#@gimp : Enhance Details = bool(1)
#@gimp : sep = separator(), Preview type = choice("Full","Forward horizontal","Forward vertical","Backward horizontal","Backward vertical","Duplicate top","Duplicate left","Duplicate bottom","Duplicate right")
#@gimp : sep = separator(), note = note("<small>Author: <i>Tom Keil</i>      Latest update: <i>04/12/2011</i>.</small>")
##@gimp : note = link("Filter explained here",http://www.tkfilter.bplaced.net/TKFilter%20filter.html)

gimp_tk_dri :
 -repeat $! -l[$>]
 -if {$6==1}
 --negate --to_rgba[0] --luminance[0] --to_rgba[0] --luminance[0]
 -gimp_gaussian_blur[1] {{{w+h}/20}*{1.1-$1}},0,0,1,0,0,0 -to_gray[1]
 -rv[0,1] -gimp_compose_softlight[0,1] $1
 -gimp_gaussian_blur[2] {{w+h}/200},0,0,1,1,0,0 -negate[2] -to_gray[2]
 -s[1] c -rv[4,5] -compose_multiply[4,5] -a[1,2,3,4] c -rv[0,1]
 -gimp_compose_dodge[0,1] $2
 -gimp_gaussian_blur[2] {{w+h}/200},0,0,1,1,0,0 -to_gray[2] -s[1] c
 -rv[4,5] -compose_multiply[4,5] -a[1,2,3,4] c -rv[0,1]
 -gimp_compose_colorburn[0,1] $3 -endif
 -if {$7==1} --map_tones[0] 0.50,0.70,$4,50
 --normalize_local[0] $4,6.00,5.00,1.00
 -rv[0,1] -gimp_compose_value[0,1] $5,0
 -rv[0,1] -gimp_compose_value[0,1] $5,0 -endif
 -endl -done

gimp_tk_dri_preview :

 -gimp_split_preview "-gimp_tk_dri ${1--2}",$-1

#*************END OF FILTER**************

#****************************************
# portrait retouching
#****************************************

#@gimp Portrait Retouching : gimp_tk_portrait, gimp_tk_portrait_preview(0)
#@gimp : sep = separator()
#@gimp : Retouching style = choice("Standard","Glamour glow","Masculine","High key","Low Key")
#@gimp : Effect strength = float(100,0,100)
#@gimp : sep = separator()
#@gimp : note = note("<b>Retouching settings:</b>")
#@gimp : Fine details smoothness = float(1,0,10)
#@gimp : Medium details smoothness = float(5,0,25)
#@gimp : Areas smoothness = float(20,0,100)
#@gimp : Fine details threshold = float(3,0,10)
#@gimp : Medium details threshold = float(20,0,100)
#@gimp : Areas light adjustment = float(10,0,100)
#@gimp : Smoothing type = choice("Gaussian","Bilateral","Anisotropic","Median")
#@gimp : Output mode = choice("Retouched image","Composed layers","All layers and masks")
#@gimp : sep = separator()
#@gimp : note = note("<b>Skin tone mask settings:</b>")
#@gimp : Apply skin tone mask = bool(1)
#@gimp : Similarity space = choice(2,"RGB[A]","RGB","YCbCr","Red","Green","Blue","Opacity","Luminance","Blue & Red chrominances","Hue","Saturation")
#@gimp : Tolerance = float(25,0,100)
#@gimp : Smoothness = float(2,0,25)
#@gimp : Selected color = color(250,180,150,255)
#@gimp : Generic skin structure = bool(0)
#@gimp : sep = separator()
#@gimp : note = note("<b>Enhancement settings:</b>")
#@gimp : Apply adjustments on = choice(0,"Final image","Retouched areas only","Sharpened areas only","Retouched and sharpened areas")
#@gimp : Sharpening Radius = float(1,0,10)
#@gimp : Sharpening Strength = float(1.5,0,5)
#@gimp : Edge Threshold = float(10,0,50)
#@gimp : Edge Smoothness = float(1,0,10)
#@gimp : Color temperature = float(0,-20,20)
#@gimp : Lightness = float(0,-50,50)
#@gimp : Contrast = float(1,0.5,1.5)
#@gimp : Saturation = float(1,0,4)
#@gimp : sep = separator()
#@gimp : Preview selection = choice("Retouched image final","Retouched image basic","Retouch layer","Sharpening layer","Skin tone mask","Skin tone colors","Edge mask","High frequency layer","Medium frequency layer","Low frequency layer")
#@gimp : Preview type = choice("Full","Forward horizontal","Forward vertical","Backward horizontal","Backward vertical","Duplicate top","Duplicate left","Duplicate bottom","Duplicate right")
#@gimp : sep = separator(), note = note("<small>Author: <i>Tom Keil</i>.      Latest update: <i>04/18/2012</i>.</small>")
##@gimp : note = link("Filter explained here","http://www.tkfilter.bplaced.net/TKFilter%20tutorials%20Portrait%20retouching.html")

gimp_tk_portrait :

 -repeat $! -l[$>] -to_rgb
 -if {narg($_previewflag)==0} _previewflag=0 -endif

#create layers and masks

 -if {{$1==3}||{$1==4}} --luminance[0] -elif {$1==2} --channels[0] 2 -gimp_unsharp[-1] 0,$21,30,$22,0.00,1.00,0.5,1,0,0,0 -endif

 --gimp_edges[0] $24,$23,0,0 -if {$23==0} -fc[-1] 0 -endif --gimp_unsharp[0] 0,$21,30,$22,0.00,1.00,0.5,1,0,7,0

 -if {{$_previewflag==4}&&{$29==5}} --tk_gimp_select_color[0] ${12-18},0,0 -else --tk_gimp_select_color[0] ${12-18},1,0 -endif

 --gimp_split_freq[0] $6 -if {$19==1} -fc[-1] 128,128,128 -noise[-1] {$6*2},0 -luminance[-1] -endif

 --gimp_split_freq[0] $7

#retouch frequency layers

 -rm[-2,-4]
 --gimp_tk_dri[0] {$8/100},{$8/200},{$8/200},0,0,1,0,0

 -if {$9==0} -blur[-1] $5 -rv[-1,-2] -blur[-1] $4 -blur[-3] $3
 -elif {$9==1} -bilateral[-1] $7,$5 -rv[-1,-2] -bilateral[-1] $6,$4 -bilateral[-3] {$3/5},$3
 -elif {$9==2} -smooth[-1] $5 -rv[-1,-2] -smooth[-1] $4 -smooth[-3] $3
 -elif {$9==3} -median[-1] $5 -rv[-1,-2] -median[-1] $4 -median[-3] $3
 -endif

#recompose retouching layers

 -if {{{$_previewflag!=0}&&{$_previewflag<=3}}||{{$10<=1}&&{$_previewflag==0}}}

 -gimp_compose_freq[-1,-2] -rv[-1,-2] -gimp_compose_freq[-1,-2]

 -if {$11==1} -to_rgba[-1] -blur[-2] $14 -s[-1] c -negate[-1] -+[-1] [-5] -a[-1,-2,-3,-4] c -endif -rm[-2] -mv[-1] 1

 -to_rgba[-1] -s[-1] c -negate[-1,-5] -+[-1] [-5] -a[-1,-2,-3,-4] c -rm[-2] -if {$23==50} -fc[-1] 0,0,0,0 -endif

#recompose final image

 -if {{{$_previewflag==1}||{$_previewflag==2}}||{{$10==0}&&{$_previewflag==0}}}

 -if {{$1!=0}&&{$1!=1}} -mv[-2] 0 -endif

 -if {$20==1} -gimp_mix_lab[-2] $27,$26,0,$28,{if({$25>=0},{$25/4},{$25*0.75})},0,$28,$25,0,0,2,0
 -elif {$20==2} -gimp_mix_lab[-1] $27,$26,0,$28,{if({$25>=0},{$25/4},{$25*0.75})},0,$28,$25,0,0,2,0
 -elif {$20==3} -gimp_mix_lab[-1,-2] $27,$26,0,$28,{if({$25>=0},{$25/4},{$25*0.75})},0,$28,$25,0,0,2,0
 -endif

 -gimp_compose_alpha[-2,-3] {if({$1==0},{$2/100},1)},0 -gimp_compose_alpha[-1,-2] {if({$1==0},{$2/100},1)},0
 -if {$23==50} -gimp_unsharp[0] 0,$21,30,$22,0.00,1.00,0.5,1,0,0,0 -endif

 -if {$_previewflag<=1}
 -if {$1==1} -gimp_glow[0] {$2/10},0,0
 -elif {$1==2} -gimp_compose_hardlight[0,1] {$2/100}
 -elif {$1==3} -gimp_compose_screen[0,1] {$2/100}
 -elif {$1==4} -gimp_compose_multiply[0,1] {$2/100}
 -endif

 -if {$20==0} -gimp_mix_lab[0] $27,$26,0,$28,{if({$25>=0},{$25/4},{$25*0.75})},0,$28,$25,0,0,2,0  -endif
 -endif -endif -endif -endl -done

#preview function

gimp_tk_portrait_preview :

 _previewflag=1
 -if {$29==1} _previewflag=2 -elif {{$29==2}||{$29==3}} _previewflag=3 -elif {$29>=4} _previewflag=4 -endif

 -if {$29>=2} -gimp_split_preview "-gimp_tk_portrait ${1--2}",0
 -else -gimp_split_preview "-gimp_tk_portrait ${1--2}",$-1 -endif

 -if {$29==1} -k[0] -elif {$29==2} -k[2] -elif {$29==3} -k[0] -elif {$29==4} -k[-3] -elif {$29==5} -k[-3]
 -elif {$29==6} -k[-5] -negate -elif {$29==7} -k[-2] -elif {$29==8} -k[0] -elif {$29==9} -k[-1] -endif
 _previewflag=0

#*******END OF FILTER********************

#****************************************
#high pass
#****************************************

#@gimp High Pass: gimp_highpass, gimp_highpass_preview(0)
#@gimp : Radius = float(5,0,100)
#@gimp : Contrast = float(2,0,7)
#@gimp : Inverse = bool(0)
#@gimp : Greyscale = bool(0)
#@gimp : sep = separator(), Preview type = choice("Full","Forward horizontal","Forward vertical","Backward horizontal","Backward vertical","Duplicate top","Duplicate left","Duplicate bottom","Duplicate right")
#@gimp : sep = separator(), note = note("<small>Author : <i>Tom Keil</i>.      Latest update: <i>01/05/2011</i>.</small>")
gimp_highpass :
  -repeat $! -l[$>]
  -to_rgb --negate
  -if {$4==1} -to_gray -endif
  -gimp_gaussian_blur[1] $1,0,0,1,0,0,0
  -compose_interpolation
  -tk_gimp_channel_processing 1,$2,0,0,0,0,100,256,0,0,0,2,0,0
  -if {$2>=4} -tk_gimp_channel_processing 1,{$2-3},0,0,0,0,100,256,0,0,0,2,0,0  -endif
  -tk_gimp_channel_processing 1,1,0,0,1,50,100,256,0,0,0,2,0,0
  -if {$3==1} -negate -endif -endl -done

gimp_highpass_preview :
  -gimp_split_preview "-gimp_highpass ${1--2}",$-1

#*************END OF FILTER**************

#*******END OF DIRECTORY*****************
#@gimp _


#@gimp _<b>Lights &amp; Shadows</b>

#****************************************
#dodge and burn
#****************************************

#@gimp Dodge and Burn : gimp_dodgeburn, gimp_dodgeburn_preview(1)
#@gimp : note = note("automatic dodging and burning")
#@gimp : sep = separator()
#@gimp : Highlights selection = float(15,0,100)
#@gimp : Highlights abstraction = float(1.5,0,10)
#@gimp : Dodge strength = float(25,0,256)
#@gimp : Dodge blur = float(10,0,20)
#@gimp : Shadows selection = float(40,0,100)
#@gimp : Shadows abstraction = float(1.5,0,10)
#@gimp : Burn strength = float(25,0,256)
#@gimp : Burn blur = float(10,0,20)
#@gimp : sep = separator()
#@gimp : note = note("Advanved: output dodge and burn layer separate")
#@gimp : Keep layers seperate = bool(0)
#@gimp : Keep original layer = bool(0)
#@gimp : Blur dodge and burn layer = float(10,0,20)
#@gimp : sep = separator(), Preview type = choice("Full","Forward horizontal","Forward vertical","Backward horizontal","Backward vertical","Duplicate top","Duplicate left","Duplicate bottom","Duplicate right")
#@gimp : sep = separator(), note = note("<small>Author: <i>Tom Keil</i>.      Latest update: <i>02/15/2011</i>.</small>")
gimp_dodgeburn :
 -repeat $! -l[$>] --luminance -if {$9==1} --fc[0] 128,128,128,255 -endif
 -tk_gimp_channel_processing[1] 1,1,0,$2,4,0,{100-$1},256,0,1,0,2,0,0
 -tk_gimp_channel_processing[1] 1,1,{-{256-$3}},0,0,0,100,256,0,0,0,2,0,0
 -gimp_gaussian_blur[1] $4,0,0,1,0,0,0 --luminance[0]
 -if {$9==0} -compose_dodge[0,1] -else -rv[1,2] -compose_dodge[1,2] -endif
 -tk_gimp_channel_processing[-1] 1,1,0,$6,4,$5,100,256,0,0,0,2,0,0
 -tk_gimp_channel_processing[-1] 1,1,{256-$7},0,0,0,100,256,0,0,0,2,0,0
 -gimp_gaussian_blur[-1] $8,0,0,1,0,0,0
 -if {$9==0} -compose_colorburn[0,1] -else -compose_colorburn[-1,-2] -endif
 -if {$9==1} -gimp_gaussian_blur[-1] $11,0,0,1,0,0,0 -endif
 -if {$10==0} -if {$9==1} -rm[0] -endif -endif -endl -done

gimp_dodgeburn_preview :
 -gimp_split_preview "-gimp_dodgeburn ${1--2}",$-1

#*************END OF FILTER**************

gimp_split_freq :
  -repeat $!
    --b[-1] $1 --[-2] [-1] -/[-2] 2 -+[-2] 128 -rv[-2,-1]
  -mv[-2,-1] 0 -done

gimp_compose_freq :
  -repeat {int($!/2)}
    --[-1] 128 -*[-1] 2 -+[-2,-1] -c[-1] 0,255
  -mv[-1] 0 -done

compose_alpha :
  -e[^-1] "Compose image$? two-by-two, using alpha blending."
  -v - -repeat {int($!/2)} -l[$>,{$>+1}]
    -r[-1] [-2],[-2],[-2],100%,0,0,0.5,0.5
    -to_colormode[-2] {a1=!({-2,s}%2);a2=!(s%2);max({-2,s}-a1,s-a2)+a1}
    -to_colormode[-1] {a=max({-2,s},s);a+(a%2)}
    -if {-2,s==2" || "s==4} # Background has alpha.
      -_compose_alpha[-2] -_compose_alpha[-1]
      -sh[-1] {s-1},{s-1} --*[-3,-1] -rm[-2] -+[-3,-2] --[-2,-1]
      -sh[-1] 0,{s-2} -sh[-2] {-2,s-1},{-2,s-1}
      -max[-1] 1e-10 -/[-2] [-1] -*[-1] 255 -rm[-2,-1]
    -else                        # Background has no alpha.
      -sh[-1] 0,{s-2} -sh[-2] {-2,s-1},{-2,s-1} --[-2] [-4] -*[-2,-1] -/[-1] 255 -rm[-1] -+[-2,-1]
    -endif
  -endl -done -c 0,255 -v +

_compose_alpha :
  -sh[-1] 0,{s-2} -sh[-2] {-2,s-1},{-2,s-1} -max[-1] 1e-10 -/[-1] 255 -*[-2,-1] -rm[-1]

gimp_compose_alpha :
  -if ${2=0} -_gimp_revert_layers -endif
  -repeat {int($!/2)}
    -to_rgba[-1] -sh[-1] 3,3 -*[-1] $1 -rm[-1]
    -blend[-2,-1] alpha
  -mv[-1] 0 -done

#*******END OF DIRECTORY*****************
#@gimp _

# Local Variables:
# mode: sh
# End:
#
# (End of G'MIC custom commands)
