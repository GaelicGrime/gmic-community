<!DOCTYPE html>
<html lang="en-us"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link rel="stylesheet" href="tutorial.css">
<script type="text/javascript" src="highslide/highslide.js"></script>
<link rel="stylesheet" type="text/css" href="highslide/highslide.css" />
<script type="text/javascript">
hs.graphicsDir = 'highslide/graphics/';
hs.wrapperClassName = 'wide-border';
</script>
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<body>


      



<h1>-do&nbsp;&hellip; -while</h1>
<div id="Frame1" style="float: left; width: 320px; height: 380px; border: none; padding: 0in;"><img src="http://www.particularart.com/static/media/uploads/command_reference/do/do_00.png" title="do_00.png" class="img_block" style="margin: 3px; border: 0px solid #808080;" width="300" height="300" />
<p style="font-size: 10pt; line-height: 100%;"><i>Figure 1: Caution: Electrified 1911 Goudy Bookletter Ampersand. Please do not stand in any water puddles or other conductive liquids while following this tutorial. Thank you.</i></p>
</div>
<p>A <tt>-do&nbsp;&hellip;&nbsp;-while</tt> block repeatly executes until the <em>condition</em> given as an argument to <tt>-while</tt> becomes false. Execution then continues with the commands following <tt>-while</tt>.</p>
<p>The format of the command is:</p>
<p><code>-do <em>&lt;statements&gt;</em> &hellip;-while <em>&lt;condition&gt;</em></code></p>
<p>The <em>condition</em> is an expression reducing to either a numeral or a string. So long as the numeral is non-zero or the string resolves to a existing file (boolean true), the commands, if any, enclosed in the&nbsp;<tt>-do&nbsp;&hellip;&nbsp;-while</tt> block execute repeatedly. Zero or a file that can no longer be found (boolean false) stops the iteration.</p>
<p>Commands enclosed within a&nbsp;<tt>-do&nbsp;&hellip;&nbsp;-while</tt> block always execute at least once. Following an initial pass through the block, the interpreter evaluates the condition expression for the first time and only if it is true, recommences execution at the first command following <tt>-do</tt>. Otherwise the interpreter proceeds to the next command following <tt>-while</tt>.</p>
<p>The commands enclosed in the&nbsp;<tt>-do&nbsp;&hellip;&nbsp;-while</tt> block never cease executing if the condition remains true. In anticipation of this possibility, a programmer can build an 'escape hatch' within the body of the <tt>-do&nbsp;&hellip;&nbsp;-while</tt> block, using the <a target="_parent" href="http://gmic.eu/reference.shtml#break"><tt>-break</tt></a> command, usually in the body of an <tt><a target="_parent" href="_if.shtml">-if</a> &hellip; <a target="_parent" href="_if.shtml">-endif</a></tt> block. Similarly, a <a target="_parent" href="http://gmic.eu/reference.shtml#continue"><tt>-continue</tt></a> command terminates the current iteration and forces an immediate re-evaluation of <tt>-while's</tt> conditional argument.</p>
<p>Usually, the commands constituting the body of the <tt>-do&nbsp;&hellip;&nbsp;-while</tt> block have some direct or indirect effect on the condition given as an argument to <tt>-while</tt>. Searching for items that meet certain criteria is a case where one uses a <tt>-do&nbsp;&hellip;&nbsp;-while</tt> block; eventually finding items that match the search criteria flips the condition given to <tt>-while</tt>, finishing the search loop.</p>
<h2 id="ExampleRiversLightningOhMy">Example: Rivers And Lightning, Oh My!</h2>
<p>Two points which are distant "as the crow flies" may be effectively close at hand when connected by a smooth-surface, graded road. On the other hand, a point "nearby" in terms of flying crows is, as a practical matter, distant when there are large mountains or oceans, or implacibly fierce Corgis inhabiting the intervening regions. When factors other than spatial separation alter the <em>effective </em>distances between points, the <tt><a target="_parent" href="_distance.shtml">-distance</a></tt> command can take a "cost map" as an argument, which account for such factors and which alters how the <tt>-distance</tt> command records the separation between points and isovalues.</p>
<p>This map assigns a <em>cost</em> to each pixel and when such a map is in place, the distance between any two points becomes the sum of costs of intervening points. This gives rise to a <em>minimal path,</em> that collection of intervening points which sum to the smallest cost, the effective "shortest distance" connecting two points. The minimal path need not be a straight line; it may even look like a river or a lightning bolt.</p>
<h3 id="PotentialMaps">Potential Maps</h3>
<p>The <tt>-distance</tt> command produces a <em>potental</em> or <em>return</em> map as an additional output when given a cost map and mode arguments of three or four (low- or high-connectivity Dijkstra metric functions, respectively. See <tt><a target="_parent" href="_label.shtml">-label</a></tt> for further remarks on connectivity). The potential map produces minimal paths connecting arbitrary points to isovalues &mdash; that particular value establishing reference points from which one measures distances.</p>
<p>For each pixel in the selected image, the potential map contains a <em>routing directive</em>, an unsigned eight bit integer encoding the direction that some imagined cursor should go when taking one step on a minimal path. Every pixel in the potential map is a routing directive on at least one minimal path. When we place our imagined cursor anywhere in the potential map, it reads the routing directive from the pixel it is sitting on to determine the next step it should take to follow some minimal path to the nearest isovalue. We generally read pixels from a potential map and chart our course on a separate image.</p>
<p>The routing directives which populate potential maps look like this:</p>
<p style="text-align: center;"><span><!--?xml version="1.0" encoding="UTF-8" standalone="no"?--> <!-- Created with Inkscape (http://www.inkscape.org/) --> <svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" width="60mm" height="12mm" viewbox="0 0 442.91339 88.582678" id="svg2" version="1.1" inkscape:version="0.91 r13725" sodipodi:docname="returnmap.svg"> <defs id="defs4"></defs> <sodipodi:namedview id="base" pagecolor="#ffffff" bordercolor="#666666" borderopacity="1.0" inkscape:pageopacity="0.0" inkscape:pageshadow="2" inkscape:zoom="1.6961556" inkscape:cx="118.59161" inkscape:cy="177.16535" inkscape:document-units="mm" inkscape:current-layer="g4227" showgrid="false" inkscape:window-width="1678" inkscape:window-height="972" inkscape:window-x="0" inkscape:window-y="24" inkscape:window-maximized="1"></sodipodi:namedview> <metadata id="metadata7"> <rdf:rdf> <cc:work rdf:about=""> <dc:format>image/svg+xml</dc:format> <dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"> <dc:title></dc:title> </dc:type></cc:work> </rdf:rdf> </metadata> <g inkscape:label="Layer 1" inkscape:groupmode="layer" id="layer1" transform="translate(0,-963.77953)"> <g id="g4227" transform="translate(0,-35.433062)"> <path inkscape:connector-curvature="0" id="rect4136" d="m 322.94097,1021.321 53.06117,0 0,53.0611 -53.06117,0 z" style="fill: #aaccff; fill-opacity: 1; fill-rule: evenodd; stroke: #000000; stroke-width: 1; stroke-miterlimit: 4; stroke-dasharray: none; stroke-opacity: 1;"></path> <path inkscape:connector-curvature="0" style="fill: #ffcc00; fill-opacity: 1; fill-rule: evenodd; stroke: #000000; stroke-width: 1; stroke-miterlimit: 4; stroke-dasharray: none; stroke-opacity: 1;" d="m 269.79135,1021.321 53.06118,0 0,53.0611 -53.06118,0 z" id="path4139"></path> <path inkscape:connector-curvature="0" id="path4141" d="m 216.64173,1021.321 53.06118,0 0,53.0611 -53.06118,0 z" style="fill: #ffeeaa; fill-opacity: 1; fill-rule: evenodd; stroke: #000000; stroke-width: 1; stroke-miterlimit: 4; stroke-dasharray: none; stroke-opacity: 1;"></path> <path inkscape:connector-curvature="0" style="fill: #ff2a7f; fill-opacity: 1; fill-rule: evenodd; stroke: #000000; stroke-width: 1; stroke-miterlimit: 4; stroke-dasharray: none; stroke-opacity: 1;" d="m 163.49213,1021.321 53.06117,0 0,53.0611 -53.06117,0 z" id="path4143"></path> <path sodipodi:nodetypes="ccccc" inkscape:connector-curvature="0" id="path4145" d="m 376.09055,1021.321 53.06118,0 0,53.0611 -53.06118,0 z" style="fill: #5599ff; fill-opacity: 1; fill-rule: evenodd; stroke: #000000; stroke-width: 1; stroke-miterlimit: 4; stroke-dasharray: none; stroke-opacity: 1;"></path> <path inkscape:connector-curvature="0" id="path4147" d="m 110.34252,1021.321 53.06118,0 0,53.0611 -53.06118,0 z" style="fill: #ffaacc; fill-opacity: 1; fill-rule: evenodd; stroke: #000000; stroke-width: 1; stroke-miterlimit: 4; stroke-dasharray: none; stroke-opacity: 1;"></path> <g transform="translate(318.17131,898.71579)" style="font-style: normal; font-weight: normal; font-size: 40px; line-height: 125%; font-family: sans-serif; letter-spacing: 0px; word-spacing: 0px; fill: #000000; fill-opacity: 1; stroke: none; stroke-width: 1px; stroke-linecap: butt; stroke-linejoin: miter; stroke-opacity: 1;" id="flowRoot4157"> <path d="m 68.929687,149.62404 0,-2.89062 9.882813,0 0,2.89062 -9.882813,0 z" id="path4540"></path> <path d="m 81.117187,159.74123 6.894532,-11.21094 -6.660157,-10 4.453125,0 5.3125,7.94922 4.765625,-7.94922 3.554688,0 -6.484375,10.6836 7.011719,10.52734 -4.433594,0 -5.742188,-8.51563 -5.117187,8.51563 -3.554688,0 z" id="path4542"></path> </g> <g transform="translate(259.86548,898.71579)" style="font-style: normal; font-weight: normal; font-size: 40px; line-height: 125%; font-family: sans-serif; letter-spacing: 0px; word-spacing: 0px; fill: #000000; fill-opacity: 1; stroke: none; stroke-width: 1px; stroke-linecap: butt; stroke-linejoin: miter; stroke-opacity: 1;" id="flowRoot4165"> <path d="m 77.425781,157.80764 0,-8.1836 -8.183594,0 0,-2.89062 8.183594,0 0,-8.20313 2.890625,0 0,8.20313 8.203125,0 0,2.89062 -8.203125,0 0,8.1836 -2.890625,0 z" id="path4535"></path> <path d="m 91.117187,159.74123 6.894532,-11.21094 -6.660157,-10 4.453125,0 5.312503,7.94922 4.76562,-7.94922 3.55469,0 -6.48437,10.6836 7.01171,10.52734 -4.43359,0 -5.742188,-8.51563 -5.117187,8.51563 -3.554688,0 z" id="path4537"></path> </g> <g transform="translate(211.68657,898.71579)" style="font-style: normal; font-weight: normal; font-size: 40px; line-height: 125%; font-family: sans-serif; letter-spacing: 0px; word-spacing: 0px; fill: #000000; fill-opacity: 1; stroke: none; stroke-width: 1px; stroke-linecap: butt; stroke-linejoin: miter; stroke-opacity: 1;" id="flowRoot4173"> <path d="m 68.929687,149.62404 0,-2.89062 9.882813,0 0,2.89062 -9.882813,0 z" id="path4530"></path> <path d="m 88.460937,159.74123 -7.519531,-21.21094 3.90625,0 5.761719,16.26953 6.328125,-16.26953 3.39844,0 -11.21094,28.92578 -4.003906,0 3.339843,-7.71484 z" id="path4532"></path> </g> <g transform="translate(153.38069,898.71579)" style="font-style: normal; font-weight: normal; font-size: 40px; line-height: 125%; font-family: sans-serif; letter-spacing: 0px; word-spacing: 0px; fill: #000000; fill-opacity: 1; stroke: none; stroke-width: 1px; stroke-linecap: butt; stroke-linejoin: miter; stroke-opacity: 1;" id="flowRoot4181"> <path d="m 77.425781,157.80764 0,-8.1836 -8.183594,0 0,-2.89062 8.183594,0 0,-8.20313 2.890625,0 0,8.20313 8.203125,0 0,2.89062 -8.203125,0 0,8.1836 -2.890625,0 z" id="path4525"></path> <path d="m 98.460937,159.74123 -7.519531,-21.21094 3.90625,0 5.761724,16.26953 6.32812,-16.26953 3.39844,0 -11.21094,28.92578 -4.003906,0 3.339843,-7.71484 z" id="path4527"></path> </g> <g transform="translate(105.99281,898.71579)" style="font-style: normal; font-weight: normal; font-size: 40px; line-height: 125%; font-family: sans-serif; letter-spacing: 0px; word-spacing: 0px; fill: #000000; fill-opacity: 1; stroke: none; stroke-width: 1px; stroke-linecap: butt; stroke-linejoin: miter; stroke-opacity: 1;" id="flowRoot4189"> <path d="m 68.929687,149.62404 0,-2.89062 9.882813,0 0,2.89062 -9.882813,0 z" id="path4520"></path> <path d="m 82.015625,159.74123 0,-2.89063 12.128906,-15.42968 -11.523437,0 0,-2.89063 16.269531,0 0,2.89063 -12.128906,15.42968 12.363281,0 0,2.89063 -17.109375,0 z" id="path4522"></path> </g> <g transform="translate(47.686947,898.71579)" style="font-style: normal; font-weight: normal; font-size: 40px; line-height: 125%; font-family: sans-serif; letter-spacing: 0px; word-spacing: 0px; fill: #000000; fill-opacity: 1; stroke: none; stroke-width: 1px; stroke-linecap: butt; stroke-linejoin: miter; stroke-opacity: 1;" id="flowRoot4197"> <path d="m 77.425781,157.80764 0,-8.1836 -8.183594,0 0,-2.89062 8.183594,0 0,-8.20313 2.890625,0 0,8.20313 8.203125,0 0,2.89062 -8.203125,0 0,8.1836 -2.890625,0 z" id="path4515"></path> <path d="m 92.015625,159.74123 0,-2.89063 12.128905,-15.42968 -11.523436,0 0,-2.89063 16.269536,0 0,2.89063 -12.128911,15.42968 12.363281,0 0,2.89063 -17.109375,0 z" id="path4517"></path> </g> <g transform="translate(367.17346,869.52017)" style="font-style: normal; font-weight: normal; font-size: 40px; line-height: 125%; font-family: sans-serif; letter-spacing: 0px; word-spacing: 0px; fill: #000000; fill-opacity: 1; stroke: none; stroke-width: 1px; stroke-linecap: butt; stroke-linejoin: miter; stroke-opacity: 1;" id="flowRoot4211"> <path d="m 23.037354,148.77412 0,-16.25977 2.307128,0 0,14.53492 7.976075,0 0,1.72485 -10.283203,0 z" style="font-size: 22.5px;" id="path4508"></path> <path d="m 35.221191,148.20283 0,-2.28516 q 3.251954,1.53809 6.416016,1.53809 3.548584,0 3.548584,-2.62573 0,-1.36231 -0.977783,-1.99951 -0.758057,-0.50538 -2.438965,-1.05469 l -2.208252,-0.7251 q -4.251709,-1.39526 -4.251709,-4.60327 0,-4.3396 5.95459,-4.3396 2.548828,0 5.284424,0.69214 l 0,2.12036 q -2.856446,-1.08765 -5.427246,-1.08765 -3.581543,0 -3.581543,2.43897 0,0.95581 0.670166,1.53808 0.692138,0.60425 2.438964,1.17554 l 2.263184,0.73608 q 2.559815,0.83497 3.603516,1.91163 1.043701,1.06567 1.043701,2.85644 0,2.16431 -1.604004,3.42774 -1.593018,1.26342 -4.405518,1.26342 -2.768554,0 -6.328125,-0.97778 z" style="font-size: 22.5px;" id="path4510"></path> <path d="m 50.766846,148.77412 0,-16.25977 5.207519,0 q 3.208008,0 4.526367,0.82398 1.329346,0.83496 1.329346,2.8125 0,1.82373 -1.307373,2.95532 -0.791016,0.68115 -2.296143,1.19751 1.911622,0.57129 2.878418,1.39526 1.373291,1.16455 1.373291,3.02124 0,1.72486 -1.120605,2.86744 -0.791016,0.81298 -2.076416,1.02172 -1.021729,0.1648 -2.735596,0.1648 l -5.778808,0 z m 2.307129,-1.72485 1.70288,0 q 3.229981,0 4.251709,-0.4834 1.010743,-0.47242 1.010743,-1.99951 0,-1.68091 -1.307373,-2.55982 -1.307373,-0.88989 -3.779297,-0.88989 l -1.878662,0 0,5.93262 z m 0,-7.3938 1.966552,0 q 4.416504,0 4.416504,-3.10913 0,-1.57105 -1.263427,-1.98853 -0.966797,-0.3186 -2.988282,-0.3186 l -2.131347,0 0,5.41626 z" style="font-size: 22.5px;" id="path4512"></path> </g> <g transform="translate(-19.494046,869.52017)" style="font-style: normal; font-weight: normal; font-size: 40px; line-height: 125%; font-family: sans-serif; letter-spacing: 0px; word-spacing: 0px; fill: #000000; fill-opacity: 1; stroke: none; stroke-width: 1px; stroke-linecap: butt; stroke-linejoin: miter; stroke-opacity: 1;" id="flowRoot4219"> <path d="m 23.037354,148.77412 0,-16.25977 3.197021,0 4.471436,12.57935 4.592285,-12.57935 2.856445,0 0,16.25977 -2.15332,0 0,-13.21655 -4.438477,12.1289 -2.230224,0 -4.306641,-12.17285 0,13.2605 -1.988525,0 z" style="font-size: 22.5px;" id="path4501"></path> <path d="m 41.307617,148.20283 0,-2.28516 q 3.251953,1.53809 6.416016,1.53809 3.548584,0 3.548584,-2.62573 0,-1.36231 -0.977783,-1.99951 -0.758057,-0.50538 -2.438965,-1.05469 l -2.208252,-0.7251 q -4.251709,-1.39526 -4.251709,-4.60327 0,-4.3396 5.95459,-4.3396 2.548828,0 5.284423,0.69214 l 0,2.12036 q -2.856445,-1.08765 -5.427246,-1.08765 -3.581543,0 -3.581543,2.43897 0,0.95581 0.670166,1.53808 0.692139,0.60425 2.438965,1.17554 l 2.263184,0.73608 q 2.559814,0.83497 3.603515,1.91163 1.043702,1.06567 1.043702,2.85644 0,2.16431 -1.604004,3.42774 -1.593018,1.26342 -4.405518,1.26342 -2.768555,0 -6.328125,-0.97778 z" style="font-size: 22.5px;" id="path4503"></path> <path d="m 56.831299,148.77412 0,-16.25977 5.207519,0 q 3.208008,0 4.526368,0.82398 1.329345,0.83496 1.329345,2.8125 0,1.82373 -1.307373,2.95532 -0.791015,0.68115 -2.296142,1.19751 1.911621,0.57129 2.878418,1.39526 1.373291,1.16455 1.373291,3.02124 0,1.72486 -1.120606,2.86744 -0.791015,0.81298 -2.076416,1.02172 -1.021728,0.1648 -2.735596,0.1648 l -5.778808,0 z m 2.307129,-1.72485 1.702881,0 q 3.22998,0 4.251709,-0.4834 1.010742,-0.47242 1.010742,-1.99951 0,-1.68091 -1.307373,-2.55982 -1.307373,-0.88989 -3.779297,-0.88989 l -1.878662,0 0,5.93262 z m 0,-7.3938 1.966552,0 q 4.416504,0 4.416504,-3.10913 0,-1.57105 -1.263427,-1.98853 -0.966797,-0.3186 -2.988282,-0.3186 l -2.131347,0 0,5.41626 z" style="font-size: 22.5px;" id="path4505"></path> </g> <path style="fill: #b7b7c8; fill-opacity: 1; fill-rule: evenodd; stroke: #000000; stroke-width: 1; stroke-miterlimit: 4; stroke-dasharray: none; stroke-opacity: 1;" d="m 57.192914,1021.321 53.061186,0 0,53.0611 -53.061186,0 z" id="path4267" inkscape:connector-curvature="0"></path> <path inkscape:connector-curvature="0" id="path4269" d="m 4.0433076,1021.321 53.0611844,0 0,53.0611 -53.0611844,0 z" style="fill: #b7b7c8; fill-opacity: 1; fill-rule: evenodd; stroke: #000000; stroke-width: 1; stroke-miterlimit: 4; stroke-dasharray: none; stroke-opacity: 1;"></path> <g transform="translate(298.47187,906.32447)" style="font-style: normal; font-weight: normal; font-size: 40px; line-height: 125%; font-family: sans-serif; letter-spacing: 0px; word-spacing: 0px; fill: #000000; fill-opacity: 1; stroke: none; stroke-width: 1px; stroke-linecap: butt; stroke-linejoin: miter; stroke-opacity: 1;" id="flowRoot4271"> <path d="m 73.933594,177.74683 0,-0.84473 q 0.332031,-0.78125 1.123047,-1.60644 l 0.527343,-0.53711 0.478516,-0.48828 q 0.942383,-0.96192 0.942383,-1.92871 0,-0.68848 -0.361328,-1.01563 -0.292969,-0.26855 -0.810547,-0.26855 -0.673828,0 -1.71875,0.58594 l 0,-0.84961 q 0.991211,-0.45411 1.845703,-0.45411 0.947266,0 1.508789,0.55176 0.561523,0.54688 0.561523,1.47461 0,0.63965 -0.288086,1.13281 -0.302734,0.50782 -1.09375,1.22071 l -0.336914,0.30273 q -1.010742,0.91797 -1.21582,1.87988 l 2.895508,0 0,0.84473 -4.057617,0 z" style="font-size: 10px; text-align: end; text-anchor: end;" id="path4573"></path> </g> <g transform="translate(244.68749,906.32447)" style="font-style: normal; font-weight: normal; font-size: 40px; line-height: 125%; font-family: sans-serif; letter-spacing: 0px; word-spacing: 0px; fill: #000000; fill-opacity: 1; stroke: none; stroke-width: 1px; stroke-linecap: butt; stroke-linejoin: miter; stroke-opacity: 1;" id="flowRoot4279"> <path d="m 76.794922,177.74683 0,-2.0459 -3.208008,0 0,-0.72754 3.208008,-4.45312 0.90332,0 0,4.39453 0.966797,0 0,0.78613 -0.966797,0 0,2.0459 -0.90332,0 z m -2.265625,-2.83203 2.329101,0 0,-3.21289 -2.329101,3.21289 z" style="font-size: 10px; text-align: end; text-anchor: end;" id="path4570"></path> </g> <g transform="translate(191.44998,906.32447)" style="font-style: normal; font-weight: normal; font-size: 40px; line-height: 125%; font-family: sans-serif; letter-spacing: 0px; word-spacing: 0px; fill: #000000; fill-opacity: 1; stroke: none; stroke-width: 1px; stroke-linecap: butt; stroke-linejoin: miter; stroke-opacity: 1;" id="flowRoot4287"> <path d="m 75.354492,173.81128 q -0.478515,-0.34668 -0.717773,-0.66406 -0.341797,-0.45898 -0.341797,-0.99121 0,-0.7959 0.600586,-1.30371 0.600586,-0.5127 1.567383,-0.5127 0.898437,0 1.450195,0.43457 0.551758,0.42969 0.551758,1.13282 0,0.62988 -0.488282,1.1914 -0.297851,0.33692 -0.859375,0.71289 0.732422,0.37598 1.108399,0.77637 0.527344,0.56641 0.527344,1.30371 0,0.89356 -0.688477,1.46485 -0.683594,0.57128 -1.772461,0.57128 -1.069336,0 -1.71875,-0.54199 -0.654297,-0.54199 -0.654297,-1.43554 0,-0.78125 0.527344,-1.39649 0.3125,-0.37109 0.908203,-0.74219 z m 1.225586,-0.30273 q 1.010742,-0.69336 1.010742,-1.44531 0,-0.45899 -0.332031,-0.72754 -0.332031,-0.27344 -0.898437,-0.27344 -0.53711,0 -0.864258,0.25879 -0.327149,0.25391 -0.327149,0.68359 0,0.5127 0.551758,0.94727 0.283203,0.22461 0.859375,0.55664 z m -0.703125,0.69336 q -0.537109,0.41992 -0.751953,0.72754 -0.244141,0.35156 -0.244141,0.8789 0,0.62989 0.400391,1.01075 0.400391,0.38574 1.05957,0.38574 0.625,0 1.020508,-0.32715 0.400391,-0.32715 0.400391,-0.84961 0,-0.46387 -0.307617,-0.78125 -0.25879,-0.26367 -0.893555,-0.63965 l -0.683594,-0.40527 z" style="font-size: 10px; text-align: end; text-anchor: end;" id="path4567"></path> </g> <g transform="translate(138.61287,906.32447)" style="font-style: normal; font-weight: normal; font-size: 40px; line-height: 125%; font-family: sans-serif; letter-spacing: 0px; word-spacing: 0px; fill: #000000; fill-opacity: 1; stroke: none; stroke-width: 1px; stroke-linecap: butt; stroke-linejoin: miter; stroke-opacity: 1;" id="flowRoot4295"> <path d="m 69.34375,177.74683 0,-0.72266 1.445312,0 0,-5.70312 -1.445312,0.36133 0,-0.74219 2.412109,-0.60059 0,6.68457 1.445313,0 0,0.72266 -3.857422,0 z" style="font-size: 10px; text-align: end; text-anchor: end;" id="path4562"></path> <path d="m 74.880859,173.948 q 0.673828,-0.83984 1.645508,-0.83984 0.888672,0 1.401367,0.60547 0.512696,0.60058 0.512696,1.66015 0,1.17676 -0.605469,1.86524 -0.605469,0.68847 -1.621094,0.68847 -1.108398,0 -1.743164,-0.95214 -0.634766,-0.94727 -0.634766,-2.61231 0,-1.88965 0.756836,-2.95898 0.756836,-1.06934 2.094727,-1.06934 0.615234,0 1.362305,0.27344 l 0,0.83984 q -0.883789,-0.39062 -1.381836,-0.39062 -1.079102,0 -1.513672,1.08398 -0.170899,0.42969 -0.229492,0.96192 -0.03418,0.2832 -0.04395,0.84472 z m 1.386719,-0.14648 q -0.605469,0 -0.976562,0.41992 -0.375977,0.41992 -0.375977,1.1377 0,0.80078 0.385742,1.32324 0.385742,0.52246 1.000977,0.52246 1.191406,0 1.191406,-1.63086 0,-1.77246 -1.225586,-1.77246 z" style="font-size: 10px; text-align: end; text-anchor: end;" id="path4564"></path> </g> <g transform="translate(85.873425,906.32447)" style="font-style: normal; font-weight: normal; font-size: 40px; line-height: 125%; font-family: sans-serif; letter-spacing: 0px; word-spacing: 0px; fill: #000000; fill-opacity: 1; stroke: none; stroke-width: 1px; stroke-linecap: butt; stroke-linejoin: miter; stroke-opacity: 1;" id="flowRoot4303"> <path d="m 68.616211,177.69312 0,-0.89844 0.03418,0.0146 q 0.126953,0.0537 0.180664,0.0684 0.532226,0.19531 0.722656,0.24414 0.317383,0.083 0.576172,0.083 0.737304,0 1.103515,-0.41016 0.322266,-0.35156 0.322266,-1.00097 0,-0.75684 -0.493164,-1.15723 -0.488281,-0.40039 -1.396484,-0.40039 l -0.38086,0 0,-0.64942 0.332031,-0.005 q 0.839844,-0.0147 1.293946,-0.38574 0.473633,-0.38086 0.473633,-1.04981 0,-1.08398 -1.166993,-1.08398 -0.600586,0 -1.503906,0.40527 l 0,-0.83984 q 0.883789,-0.28809 1.5625,-0.28809 1.176758,0 1.689453,0.56153 0.38086,0.41504 0.38086,1.10351 0,0.77637 -0.546875,1.2793 -0.322266,0.29785 -0.957032,0.54688 0.556641,0.14648 0.839844,0.3125 0.90332,0.52246 0.90332,1.61132 0,0.98633 -0.649414,1.57715 -0.649414,0.5957 -1.708984,0.5957 -0.571289,0 -1.611328,-0.23437 z" style="font-size: 10px; text-align: end; text-anchor: end;" id="path4557"></path> <path d="m 73.933594,177.74683 0,-0.84473 q 0.332031,-0.78125 1.123047,-1.60644 l 0.527343,-0.53711 0.478516,-0.48828 q 0.942383,-0.96192 0.942383,-1.92871 0,-0.68848 -0.361328,-1.01563 -0.292969,-0.26855 -0.810547,-0.26855 -0.673828,0 -1.71875,0.58594 l 0,-0.84961 q 0.991211,-0.45411 1.845703,-0.45411 0.947266,0 1.508789,0.55176 0.561523,0.54688 0.561523,1.47461 0,0.63965 -0.288086,1.13281 -0.302734,0.50782 -1.09375,1.22071 l -0.336914,0.30273 q -1.010742,0.91797 -1.21582,1.87988 l 2.895508,0 0,0.84473 -4.057617,0 z" style="font-size: 10px; text-align: end; text-anchor: end;" id="path4559"></path> </g> <g transform="translate(32.098825,906.32447)" style="font-style: normal; font-weight: normal; font-size: 40px; line-height: 125%; font-family: sans-serif; letter-spacing: 0px; word-spacing: 0px; fill: #000000; fill-opacity: 1; stroke: none; stroke-width: 1px; stroke-linecap: butt; stroke-linejoin: miter; stroke-opacity: 1;" id="flowRoot4311"> <path d="m 69.207031,173.948 q 0.673828,-0.83984 1.645508,-0.83984 0.888672,0 1.401367,0.60547 0.512696,0.60058 0.512696,1.66015 0,1.17676 -0.605469,1.86524 -0.605469,0.68847 -1.621094,0.68847 -1.108398,0 -1.743164,-0.95214 -0.634766,-0.94727 -0.634766,-2.61231 0,-1.88965 0.756836,-2.95898 0.756836,-1.06934 2.094727,-1.06934 0.615234,0 1.362305,0.27344 l 0,0.83984 q -0.88379,-0.39062 -1.381836,-0.39062 -1.079102,0 -1.513672,1.08398 -0.170899,0.42969 -0.229492,0.96192 -0.03418,0.2832 -0.04395,0.84472 z m 1.386719,-0.14648 q -0.605469,0 -0.976563,0.41992 -0.375976,0.41992 -0.375976,1.1377 0,0.80078 0.385742,1.32324 0.385742,0.52246 1.000977,0.52246 1.191406,0 1.191406,-1.63086 0,-1.77246 -1.225586,-1.77246 z" style="font-size: 10px; text-align: end; text-anchor: end;" id="path4552"></path> <path d="m 76.785156,177.74683 0,-2.0459 -3.208008,0 0,-0.72754 3.208008,-4.45312 0.903321,0 0,4.39453 0.966796,0 0,0.78613 -0.966796,0 0,2.0459 -0.903321,0 z m -2.265625,-2.83203 2.329102,0 0,-3.21289 -2.329102,3.21289 z" style="font-size: 10px; text-align: end; text-anchor: end;" id="path4554"></path> </g> <g transform="translate(-18.314453,906.32447)" style="font-style: normal; font-weight: normal; font-size: 40px; line-height: 125%; font-family: sans-serif; letter-spacing: 0px; word-spacing: 0px; fill: #000000; fill-opacity: 1; stroke: none; stroke-width: 1px; stroke-linecap: butt; stroke-linejoin: miter; stroke-opacity: 1;" id="flowRoot4319"> <path d="m 60.669922,177.74683 0,-0.72266 1.445312,0 0,-5.70312 -1.445312,0.36133 0,-0.74219 2.412109,-0.60059 0,6.68457 1.445313,0 0,0.72266 -3.857422,0 z" style="font-size: 10px;" id="path4545"></path> <path d="m 65.523437,177.74683 0,-0.84473 q 0.332032,-0.78125 1.123047,-1.60644 l 0.527344,-0.53711 0.478516,-0.48828 q 0.942383,-0.96192 0.942383,-1.92871 0,-0.68848 -0.361329,-1.01563 -0.292968,-0.26855 -0.810546,-0.26855 -0.673829,0 -1.71875,0.58594 l 0,-0.84961 q 0.99121,-0.45411 1.845703,-0.45411 0.947265,0 1.508789,0.55176 0.561523,0.54688 0.561523,1.47461 0,0.63965 -0.288086,1.13281 -0.302734,0.50782 -1.09375,1.22071 l -0.336914,0.30273 q -1.010742,0.91797 -1.21582,1.87988 l 2.895508,0 0,0.84473 -4.057618,0 z" style="font-size: 10px;" id="path4547"></path> <path d="m 72.520508,173.81128 q -0.478516,-0.34668 -0.717774,-0.66406 -0.341797,-0.45898 -0.341797,-0.99121 0,-0.7959 0.600586,-1.30371 0.600586,-0.5127 1.567383,-0.5127 0.898438,0 1.450196,0.43457 0.551757,0.42969 0.551757,1.13282 0,0.62988 -0.488281,1.1914 -0.297851,0.33692 -0.859375,0.71289 0.732422,0.37598 1.108399,0.77637 0.527343,0.56641 0.527343,1.30371 0,0.89356 -0.688476,1.46485 -0.683594,0.57128 -1.772461,0.57128 -1.069336,0 -1.71875,-0.54199 -0.654297,-0.54199 -0.654297,-1.43554 0,-0.78125 0.527344,-1.39649 0.3125,-0.37109 0.908203,-0.74219 z m 1.225586,-0.30273 q 1.010742,-0.69336 1.010742,-1.44531 0,-0.45899 -0.332031,-0.72754 -0.332032,-0.27344 -0.898438,-0.27344 -0.537109,0 -0.864258,0.25879 -0.327148,0.25391 -0.327148,0.68359 0,0.5127 0.551758,0.94727 0.283203,0.22461 0.859375,0.55664 z m -0.703125,0.69336 q -0.53711,0.41992 -0.751953,0.72754 -0.244141,0.35156 -0.244141,0.8789 0,0.62989 0.400391,1.01075 0.40039,0.38574 1.05957,0.38574 0.625,0 1.020508,-0.32715 0.40039,-0.32715 0.40039,-0.84961 0,-0.46387 -0.307617,-0.78125 -0.258789,-0.26367 -0.893555,-0.63965 l -0.683593,-0.40527 z" style="font-size: 10px;" id="path4549"></path> </g> <g transform="translate(351.23571,906.32447)" style="font-style: normal; font-weight: normal; font-size: 40px; line-height: 125%; font-family: sans-serif; letter-spacing: 0px; word-spacing: 0px; fill: #000000; fill-opacity: 1; stroke: none; stroke-width: 1px; stroke-linecap: butt; stroke-linejoin: miter; stroke-opacity: 1;" id="flowRoot4327"> <path d="m 74.558594,177.74683 0,-0.72266 1.445312,0 0,-5.70312 -1.445312,0.36133 0,-0.74219 2.412109,-0.60059 0,6.68457 1.445313,0 0,0.72266 -3.857422,0 z" style="font-size: 10px; text-align: end; text-anchor: end;" id="path4576"></path> </g> </g> </g> </svg></span></p>
<p>A routing directive consists of three, two bit <em>nibbles</em> preceded by an unused nibble containing two unset (zero) bits. From the most significant bit to the least, the nibbles dictate z (depth), y (vertical), or x (horizontal) movement. In each nibble, the most significant bit flags forward (positive) movement; the least significant bit flags reverse (negative) movement.</p>
<ol>
<li>Both nibbles may be unset. That indicates no movement in the given direction.</li>
<li>If the most significant nibble is set, forward (positive) movement takes place.</li>
<li>If the least significant nibble is set, reverse (negative) movement takes place.</li>
<li>Both nibbles cannot be set, as that conveys simultaneous forward and reverse movement.</li>
</ol>
<p>Commencing from an arbitrary pixel with a non-zero routing directive, the imagined cursor steps once to the neighboring pixel that may or may not be closer to the nearest isovalue "as the crow flies", but is on the cheapest path to that point, according to the <tt>-distance</tt> command with cost map that computed the routing directive. The cursor then assesses the routing directive of the neighboring pixel and if that too is non-zero, steps furher on, repeating the cycle until encountering a routing directives equal to zero. That is, all three nibbles have unset forward and reverse directives; the cursor has arrived at a point corresponding to an isovalue in the original image. This permanently stops the imagined cursor. Without a direction in which to move, it can no longer obtain new routing directives. The course it has traced from its given arbitrary starting pixel to the isovalue corresponds to the minimal cost path between the initial pixel and the isovalue. In a properly composed potential map, zero-valued routing directives correspond to isovalues in the selected image and all other pixels have non-zero routing directives so composed as to steer an imagined cursor toward the nearest isovalue.</p>
<h3 id="MakingRiversPerhaps">Making Rivers, Perhaps, or Maybe Lightning Bolts</h3>
<p>The lightning bold crackling fiercely in the frontpiece stems from some 180 arbitrarily chosen points, from which minimal paths were traced to a single isovalue. For the cost map, we rendered a mode 0 <a target="_parent" href="_turbulence.shtml"><tt>-turbulence</tt></a> pattern, further <a target="_parent" href="http://gmic.eu/reference.shtml#sharpen">sharpened</a> through inverse diffusion. We then set an isovalue of one in an otherwise black image at a location coincident to the minimal value of the turbulence image.</p>
<p>Astute readers will, no doubt, recognize that we are playing the Watershed Game, tracing the paths of so many droplets dribbling their ways downslope to the basin containing the minimum point. This behavior follows readily from the turbulence-generated cost map. This particular turbulence forms discontinuous rilles which tend to snake in river-like ways. They are also local minima, cheap pixels over which one may traverse when the turbulence is used as a cost map. Our game for river or lightning bolt emulation is straightforward: harness <tt>-distance</tt> to generate a potential map corresponding to a turbulence image. Then, for a supply of a few hundred arbitrarily chosen pixels, trace the minimal paths of each to the isovalue. If we render these paths in dark gray and then composite them through an additive operator, the more heavily traveled paths will tend to whites and light greys; less traveled paths will be darker. Particulars follow.</p>
<h4 id="CostMap">Height, Cost and Potential Maps</h4>
<table style="border-color: #808080; border-width: 1px; border-style: solid;" rules="all" class="table table-striped" border="0">
<tbody>
<tr>
<td colspan="2"><tt>gmic -srand 9717 \<br />-input 1024,1024,1,1 \<br />-turbulence[-1] 512,12,3,0,0 \</tt></td>
</tr>
<tr>
<td width="256"><img src="http://www.particularart.com/static/media/uploads/command_reference/do/do_01.png" title="do_00.png: Turbulence" class="img_block" style="margin: 3px; border: 0px solid #808080;" width="300" height="300" /></td>
<td>The genesis of the frontpiece illustration is mode 0 <tt><a target="_parent" href="_turbulence.shtml">-turbulence</a>.</tt> We base the height, cost and potential map on this underlying rendering.<br /> As noted in the <a target="_parent" href="_plasma.shtml"><tt>-plasma</tt></a> tutorial, it is our wont to set a particular seed in G'MIC's random number generator (via <a target="_parent" href="http://gmic.eu/reference.shtml#srand"><tt>-srand</tt></a>) so that we can reproduce a particular pattern; what we have here may as well be called "Turbulence Pattern 9717".<br /> Mode 0 turbulence employs the <a target="_parent" href="http://gmic.eu/reference.shtml#abs"><tt>-abs</tt></a> command as a mixer; at each stage of its development, any zero-crossings are folded back into the positive region, generating numerous discontinuities &ndash; creases &ndash; both large and small. These emulate rilles and waterways, somewhat. Being local minima, the rilles have low intensities; when we derive a cost map from this turbulence, rivers or lightning bolts will tend to follow these rilles. We revisit this idea downstream from here.<br /> We render the turbulence so that it exhibits large-scale features, develop the pattern through 12 octaves and set a modest decay factor of three between each octave. While large-scale features are present, low-magnitude, small-scale features persist.</td>
</tr>
<tr>
<td colspan="2"><tt>-input http://particularart.com/static/media/uploads/command_reference/repeat/ampersand_goudybl1911.svg \<br /> -resize[-1] [-2],[-2],[-2],[-2],5,0 \<br /> -blur[-1] 11,1,0 \<br /> -normalize[-1] 0.4,1 \<br /> -mul[-2,-1] \<br /> -sharpen 50 \<br /> --sqr[-1] \</tt></td>
</tr>
<tr>
<td width="256"><img src="http://www.particularart.com/static/media/uploads/command_reference/do/do_02.png" title="do_02.png: Final Cost Map" width="300" height="300" /></td>
<td>
<p>From this point forward, we modify the turbulence patterns in various ways to make our height, cost and potential maps.<br /> The first modification is impressing a Goudy 1911 Bookletter ampersand on the turbulence field, mainly because we are obsessed with this ampersand (but you knew that), and secondarily, we'd like to steer our lightning bolts so that they roughly trace parts of the ampersand's shape. Since we will trace the lightning bolts by the Watershed Game, we go about making a general depression in the turbulence in the shape of the ampersand; we blur the ampersand slightly to avoid abrupt drops into the basin.</p>
<p>We anticipate that as lightning bolts trace along minimal paths, those will thread through the lower elevation ampersand on the way to the isovalue. Once we have blurred and scaled the ampersand, we multiply it with the original turbulence, giving us the final form of our <em>height map</em>. Our <a target="_parent" href="_distance.shtml#CustomMetricMaps" title="cost map" class="internal"><em>cost map</em></a> follows directly from sharpening and squaring operations. Sharpening tends to magnify fine detail, alternately, increasing or decreasing the values of out-of-bound pixels, driving them from the mean value of the image and towards its extremes. Squaring makes expensive (light colored) pixels even more expensive. In the larger scheme of things, we are making a cost map where minimal paths will meander a great deal, as we are creating pits and rises and other obstacles that mitigate against the straightforward progression of minimal paths to the isovalue.</p>
</td>
</tr>
<tr>
<td colspan="2"><tt>-input 100%,100%,100%,100% \<br /> -set[-1] 1,'{xm#-3}','{ym#-3}'\<br /> -distance[-1] 1,[-2],4 \<br /> -output[-1] potmap.cimg,uchar \<br /> -output[0] height.png \</tt></td>
</tr>
<tr>
<td width="256"><img src="http://www.particularart.com/static/media/uploads/command_reference/do/do_03.png" title="do_03.png: Final Height Map" width="300" height="300" /></td>
<td>
<p>&nbsp;We harness the <tt><a target="_parent" href="_distance.shtml">-distance</a></tt> command to make a <em><a target="_parent" href="#PotentialMaps">potential map</a></em>.</p>
<p>To that end, we require an image in which we can measure distances. We don't have one, so we <a target="_parent" class="intern" href="conjuring-images.shtml">conjure a black image</a> from the aether and set a single pixel to isovalue one within it, this pixel situated in the same location as the minimal point in our turbulence-based cost map. It is to this point that all lightning bolts meander when we play the Watershed Game.</p>
<p>Don't let the black uniformity of this conjured image fool you. In playing the Watershed Game, we will harness a special form of the <tt>-distance</tt> command to associate our <tt>-turbulence</tt>-generated cost map with this seemingly uniform space. When we do that, the cost map will set a 'traversal price' for every pixel in this uniform seeming image.</p>
<p>If a pixel in the cost map is white, or very nearly so, the corresponding pixel in the conjured image becomes expensive to cross. In contrast, pixels corresponding to very nearly black counterparts in the cost map are very nearly free.</p>
<p>The special form of the <tt>-distance</tt> command accounts for the non-uniform traversal costs of pixels set by the cost map and makes a new map, the <emp>return</emp>, or <emp>potential map</emp>, and that map can tell us the cheapest path between any pixel and the nearest isovalue in the conjured image, given the vagarities specified by the cost map. We can use the potential map produced by the <tt>-distance</tt> command to plot these minimal paths.</p>
<p>It is worthwhile to comment on the math parser notation that allows us to extract the minimal point from our turbulence-based cost map and translate it to the isovalue-one pixel in our conjured image. G'MIC regards strings within curley braces (<tt>{}</tt>) as substitution sequences, and math expressions appearing within substitution sequences simply evaluate themselves, then replace themselves with their computed values. G'MIC math expressions have a host of predefined variables that convey metrics about images. Predefined variables <tt>xm</tt> and <tt>ym</tt> contain the coordinates of the minimal pixel value; for multi-slice images with depth, add <tt>zm</tt> to your kit. On the chance that two or more pixels vie for the minimal (or any other metric) distinction, G'MIC chooses the pixel with the smallest depth, column and row coordinates &ndash; that is, the first qualifying pixel in the image stream.</p>
<p>These and all predefined math parser variables, unadorned, implicitly refer to the metrics of the last image on the image list. Variables may be postfixed with a hashtag (<tt>#</tt>) followed by a list index to explicity choose an image on the list. Thus, the math parser substitutes the expression <tt>xm#-3</tt> with the column (<tt>x</tt>) coordinate of the first minimal pixel in the third image from the end of the image list. Had we omitted the negative sign, we would have referenced the <emp>fourth</emp> image from the beginning of the image list &ndash; recall that the G'MIC image list indices are zero-referenced.</p>
<p>All <emp>together</emp> now! <tt><a target="_parent" href="http://gmic.eu/reference.shtml#set">-set</a>[-1] 1, '{xm#-3}','{ym#-3}'</tt> sets to a value of one, the pixel in the last image on the list &ndash; our conjured image &ndash; with the same coordinates as the minimal pixel of the third image from the end of the image list &mdash; our turbulence-based cost map. See <a target="_parent" href="http://gmic.eu/reference.shtml">section 1.8</a> of the <emp><a target="_parent" href="http://gmic.eu/reference.shtml">G'MIC Reference Manual</a></emp> for a full list of image metric variables and the basics of the math parser. By using this math parser-based substitution sequence, we are protected if we change the turbulence image. We can do this on a whim and this substitution sequence adjusts automatically to the minimum point coordinates of the new image.</p>
<p>We invoke the <tt><a target="_parent" href="_distance.shtml">-distance</a>[-1] 1,[-2],4</tt> command in a special way to associate a cost map &ndash; the <tt>-turbulence</tt> graphic &ndash; with our conjured image currently sitting in the last slot of the image list. The cost map, with its origins in the <tt>-turbulence</tt> generator, ensures that the cheapest path from any pixel in the conjured image to the isovalue is not necessarily the direct line connecting the two points.</p>
<ol>
<li>The first argument given to the <tt>-distance</tt> command should be familiar to most readers; <tt>1</tt> designates the isovalue to which we measure distances. Recall that in the conjured image we set just one pixel at this isovalue; its position corresponds to the minimal value in the <tt>-turbulence</tt> generated height map.</li>
<li><tt>[-2]</tt> designates the penultimate image on the list as the cost map: our sharpened, squared version of the initial <tt>-turbulence</tt> generated image. Pixels in this cost map are in a 1:1 correspondence with pixels in the conjured image, and each pixel in the cost map indicates how expensive it is to traverse its mate in the conjured image. The whiter the pixel is in the cost map, the more expensive it is to traverse the corresponding pixel in the conjured image.</li>
<li>The last argument, <tt>4</tt>, requests <tt>-distance</tt> to produce an additional <emp>potential map</emp>, using a high connectivity Dijkstra metric function. Its behavior approaches that of the Euclidean metric should the values in the cost map be more or less the same. That is not the case in our turbulence-generated cost map, so the cheapest distances to the isovalue from various points are generally not the Euclidean "as the crow flies" path.</li>
</ol>
<p>We save out the first image on the list, the height map, depicted on the immediate left. Downstream, it is involved with <a target="_parent" href="http://gmic.eu/reference.shtml#light_relief">-light_relief</a> and other <a target="_parent" href="fingerpainting.shtml#Lighting">fake lighting methods</a>, which many of you will think of as "bump mapping". Finally, we save out the potential map, taking care to specify to the <a target="_parent" href="http://gmic.eu/reference.shtml#output">-output</a> command a particular data type, unsigned character, to prevent the default conversion to floating point, a calamity which would destroy the routing directives stored in this map. Observe, too, that we save the potential map in G'MIC's native CIMG format to further avoid the inadvertant casting of the routing directives into an unreadable format.</p>
</td>
</tr>
<tr>
<td width="256"><img src="http://www.particularart.com/static/media/uploads/command_reference/do/do_04.png" title="do_04.png: Potental Map Detail Around Isovalue" width="300" height="300" /></td>
<td>
<p>The conventional output from <tt>-distance</tt> is a displacement map which furnishes point-wise offsets of each pixel in the original image to the nearest isovalue. For the Great Watershed Game, we use the <em>potential map</em> instead and throw away the displacement map, unused.</p>
<p>The potential map set is a point-wise collection of control words, <a target="_parent" href="#PotentialMap" title="described above" class="internal">described above</a>, which we call <i><a target="_parent" href="#PotentialMaps">routing directives</a></i>, one corresponding to each pixel in the conjured image. Given a pixel, the associated routing directive conveys to an imagined cursor the least expensive direction it needs to step in order to move "closer" to the isovalue, in quotes because the routing directive may shift the imagined cursor away from the isovalue, at least in terms of Euclidean distance. However, when <tt>-distance</tt> is furnished with a point-wise cost map, as we have done here, the "shortest distance" is the minimal path with the lowest cost sums, which likely is not the shortest distance by Euclidean measure.</p>
<p>On the left, we have schematically reproduced the 9&times;9 pixel neighborhood around the minimum point in the potential map. The numerals reprsent routing directives, each with three two-bit directional fields that collectively move an imagined cursor away from, or toward the isovalue, along each cardinal direction. Numerals 1, 5, 4, 6, 2, 10, 8 and 9 direct an imagined cursor, respectively, west, northwest, north, northeast, east, southeast, south or sourthwest. The special routing directive 0 tells the cursor not to move; once a cursor is given such a directive it necessarily stalls, as it has been told to go nowhere so can never acquire another directive.</p>
<p>The <tt>-distance</tt> command computes these point-wise routing directives based on the cost map; in aggregate, these routing directives put an imagined cursor at a given point on a minimal path toward the nearest isovalue, one that accumulates the least cost along its length.</p>
<p>This brings us to the Watershed Game. Both rivers and lightning bolts, among other phenomena, attempt to minimize a cost of travelling from an initial to a destination point. Armed with a potential map such as the one on the left, we can emulate droplets of water streaming from arbitrary locations towards some minimum point. Our working mechanism is a <tt>-do&nbsp;&hellip;&nbsp;-while</tt> block: while routing directives are non-zero, step in the direction it gives us, then read a new directive. Repeat the block. Continue doing so until we read a zero-valued routing directive. We have arrived at the minimum point and the path followed respresents the smallest cost possible from our starting point, whatever that may be. In doing this, of course, we trust that <tt>-distance</tt> has computed all of the routing directives correctly.</p>
<p>Particulars follow.</p>
</td>
</tr>
</tbody>
</table>
<h4 id="WalkingAMinimalPath">Walking a Minimal Path</h4>
<table style="border-color: #808080; border-width: 1px; border-style: solid;" rules="all" class="table table-striped" border="0">
<tbody>
<tr>
<td colspan="2"><tt>gmic pcnt=180 -input potmap.cimg \<br /> -input 100%,100%,100%,100% \<br /> -input '{$pcnt}',2,1,1,'round(1024*u)' \</tt></td>
</tr>
<tr>
<td width="256"><img src="http://www.particularart.com/static/media/uploads/command_reference/do/do_05.png" class="img_block" style="margin: 3px; border: 0px solid #808080;" width="300" height="300" /></td>
<td>
<p>To play the Watershed Game, we <a target="_parent" href="_input.shtml"><tt>-input</tt></a> three "images" (in the broad G'MIC sense, meaning they might not be pretty to look at).</p>
<ol>
<li><tt>-input potmap.cimg</tt> The first is the potential, or return map introduced in the previous panel. This tells us how to find the least expensive paths to an isovalue from any other point, and we concocted it in such a way that those paths will meander like rivers or lightning bolts.</li>
<li><tt>-input 100%,100%,100%,100%</tt> The second is an solid black image that we conjure out of the aether. This is the image upon which we draw rivers or lightning bolts.</li>
<li><tt>input '{$pcnt}',2,1,1,'round(1024*u)'</tt>The third image may be hard to recognize, at first, but is a useful G'MIC idiom nontheless. It is a bag of random coordinates. Here, we find two math expressions in play.<ol type="a">
<li>The first, <tt>'{$pcnt}'</tt>, is a substitution sequence. In the previous step, we defined the variable <tt>'pcnt=180'</tt>; here, the G'MIC command processor evauates and substitutes <tt>'$pcnt'</tt> for its value. This, of course, is a trivial substitution example, but if a particular value occurs in many places, then a great deal of effort can be saved when one must revise that value. Defining that value as a variable, then allowing the G'MIC to substitute the variable in all the other places it appears saves a great deal of time. Being a math parser expression, the initial definition of a variable can also be arbitrarily complex, perhaps referencing the metrics of a number of images. Using a substitution variable confines that complexity to one place.</li>
<li>The second place a math expression appears is as the fifth argument to <tt>-input</tt>. The expression <tt>'round(1024*u))'</tt> is a <emp>pixel processor</emp>, which runs once for every pixel component in the new image. In this case, the math parser expression does not appear in curley braces because the results of its evaluation is not to provide a substitute text string, but to set a pixel component value. Pixel processors appear as parameters to <tt>-input</tt>, as seen here, to procedurally define an image, or as parameters to <tt>-fill</tt> to procedurally define the stream of a <tt>-fill</tt> operation. In this particular example, when G'MIC is about to set a pixel channel value, it is invited to pick some floating point value in the half-open interval [0&hellip;1024), then round it to the nearest whole number. In the larger scheme of things, this gives us a coordinate pair selecting a pixel somewhere in our 1024 x 1024 image - a starting point for a minimal path. We asked for 180 random coordinates (<tt>$pcnt</tt>). We could have asked for 65,356 for a dense pattern, or 16 for a sparse one. The particular value, 180 is a matter of taste.</li>
</ol></li>
</ol>
<p>From each of these 180 coordinates, we seek the minimal path to the isovalue, the one point in the potential map with a routing directive of zero.</p>
<p>How to we actually follow a minimal path? One implementation of a minimal path follower is next on tap. Repeating for each pair in our bag of coordinates, we do a minimal path tracking, running from each of the randomly generated coordinates to the single isovalue we had initially set.</p>
</td>
</tr>
<tr>
<td colspan="2"><tt>-repeat '{$pcnt}' \<br /> &nbsp;&nbsp;&nbsp;rdir=0 \<br /> &nbsp;&nbsp;&nbsp;kx='{i(#-1,$&gt;,0,0,0,0)}' \<br /> &nbsp;&nbsp;&nbsp;ky='{i(#-1,$&gt;,1,0,0,0)}' \<br /> &nbsp;&nbsp;&nbsp;-do \<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -set[-2] '{i(#-2,$kx,$ky,0,0,0)+1}','{$kx}','{$ky}',0,0 \<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rdir='{i(#-3,$kx,$ky,0,0,0)}' \<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-if '{$rdir&amp;1}' \<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kx='{$kx-1}' \<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-elif '{$rdir&amp;2}' \<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kx='{$kx+1}' \<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-endif \<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-if '{$rdir&amp;4}' \<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ky='{$ky-1}' \<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-elif '{$rdir&amp;8}' \<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ky='{$ky+1}' \<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-endif \<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-while '{$rdir&gt;0}' \<br /> &nbsp;&nbsp;&nbsp;-done \</tt></td>
</tr>
<tr>
<td width="256"><img src="http://www.particularart.com/static/media/uploads/command_reference/do/do_06.png" title="do_06.png" class="img_block" style="margin: 3px; border: 0px solid #808080;" width="300" height="300" /></td>
<td>
<p>And this, in its entirety, is the Watershed Game: We iterate over our 180 points, and for each randomly chosen coordinate, trace the minimal path from it to the isovalue. The tracing is an example of a <tt>-do&nbsp;&hellip;&nbsp;-while</tt> block. While routing directives remain non-zero, we step to the pixel the directive indicates and read the next directive. We keep on doing that until we read the zero directive, which stops the iteration. This gives us one meandering river, or lightning bolt, depending on how you want to interpret it. We do this for as many randomly generated coordinates as we have.</p>
<p>The body of the <tt>-do&nbsp;&hellip;&nbsp;-while</tt> loop concerns itself with parsing the routing directive, with the current directive retained in <tt>$rdir</tt>. We initialize <tt>$kx</tt> and <tt>$ky</tt> with the current randomly chosen coordinate, then successively mask <tt>$rdir</tt> against powers of two so as to read its depth, column and row directional nibbles, as described above. For example, the math parser expression <tt>{$rdir&amp;1}</tt> evaluates to '1' if the decrement <tt>x</tt> nibble is set. These expresssions parse <tt>$rdir</tt>'s bit fields and increments or decrements <tt>$kx</tt> and <tt>$ky</tt> respectively, advancing our cursor along the minimal path. We don't bother with the depth field, since our rivers/lightning bolts are flat, but we could. In fact, there is a G'MIC command which is a complete implementation of the partial effort here: see <a target="_parent" class="intern" href="http://gmic.eu/reference.shtml#minimal_path">-<tt>minimal_path</tt></a>.</p>
<p>We drop out of the <tt>-do&nbsp;&hellip;&nbsp;-while</tt> loop when our traversal of the minimal path hits upon the directive corresponding to the isovalue. All nibbles are unset in that directive; the cursor has nowhere else to go. The outer <tt>-repeat&nbsp;&hellip;&amp;nobsp;-done</tt> block gives us another randomly generated starting coordinate to trace a subsequent minimal path. When our supply of randomly generated coordinates is exhaused, we are <tt>-done</tt>.</p>
<p>There are some artistic things we do as side effects. When stepping onto a pixel, we mark our passage by bumping its intensity by one, to wit: <tt>-set[-2] '{i(#-2,$kx,$ky,0,0,0)+1}','{$kx}','{$ky}',0,0</tt>. The two or three inexpensive approaches to the isovalue tend to be shared by many minimal paths; these become very nearly white, while the less traveled segments remain almost black.</p>
<p>The line which increments the pixel's intensity illustrate another substitution sequence. A comma-separated list of complete image coordinates, width, height, depth, slice, and channel, fetches the current pixel value at that locale, here, on the penultimate position (-2) of the image stack.</p>
</td>
</tr>
<tr>
<td colspan="2"><tt>-rm[-3,-1] \<br /> -add[-1] 1e-10 \<br /> -log[-1] \<br /> -div[-1] '{log($pcnt)}' \<br /> -cut -1,'{iM}' \<br /> -normalize[-1] 0,255 \<br /> -dilate[-1] 3 \<br /> -repeat 2 \<br /> -smooth[-1] 10,0.2,0.8,5,3 \<br /> -done \<br /> -normalize[-1] 0,255 \<br /> -output[-1] lbolt.png \</tt></td>
</tr>
<tr>
<td width="256"><img src="http://www.particularart.com/static/media/uploads/command_reference/do/do_08.png" class="img_block" title="do_08.png" style="margin: 3px; border: 0px solid #808080;" width="300" height="300" /><br /><img src="http://www.particularart.com/static/media/uploads/command_reference/do/do_07.png" title="do_07.png" class="img_block" style="margin: 3px; border: 0px solid #808080;" width="300" height="300" /></td>
<td>Once we have plotted our 180 paths, we rescale the the intensity levels according to a logarithmic scale so that the 'less traveled' paths are more readly visible. We dilate, then anisotropically smooth the pathways. We used pretty aggressive smoothing here, giving flame-like bolts, but our choices here are a matter of taste. Less aggressive smoothing lends itself to more jagged electrical-like bolts.</td>
</tr>
</tbody>
</table>
<p><em>Garry Osgood</em></p>



   
</body></html>